<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/xiaolangwiki/images/favicon64.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/xiaolangwiki/images/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/xiaolangwiki/images/favicon16.ico">
  <link rel="mask-icon" href="/xiaolangwiki/images/favicon48.ico" color="#222">

<link rel="stylesheet" href="/xiaolangwiki/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic|Noto Serif SC:300,300italic,400,400italic,700,700italic|Console:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/xiaolangwiki/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">
  <link rel="stylesheet" href="/xiaolangwiki/lib/pace/pace-theme-minimal.min.css">
  <script src="/xiaolangwiki/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"liantianno1.github.io","root":"/xiaolangwiki/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","enable":true,"active":"gitalk","storage":true,"lazyload":false,"nav":null,"activeClass":"gitalk"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="一个关于编程、计算机、软件工程、互联网的知识库。">
<meta property="og:type" content="website">
<meta property="og:title" content="小浪wiki">
<meta property="og:url" content="https://liantianno1.github.io/xiaolangwiki/index.html">
<meta property="og:site_name" content="小浪wiki">
<meta property="og:description" content="一个关于编程、计算机、软件工程、互联网的知识库。">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="小浪wiki">
<meta property="article:tag" content="小浪wiki, 编程, 计算机, 软件工程, 互联网">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://liantianno1.github.io/xiaolangwiki/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>
<!-- 页面点击小红心 -->
<!-- <script type="text/javascript" src="/xiaolangwiki/js/love.js"></script> -->
<script type="text/javascript" defer src="/xiaolangwiki/js/mybg.js"></script>
<!-- 文章加密 -->
<script>
    (function(){
        if(''){
            if (prompt('请输入文章密码') !== ''){
                alert('密码错误！');
                history.back();
            }
        }
    })();
</script>

  <title>小浪wiki</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

  <meta name="referrer" content="no-referrer"/>
<link rel="alternate" href="/xiaolangwiki/atom.xml" title="小浪wiki" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/xiaolangwiki/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">小浪wiki</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">一个关于编程、计算机、软件工程、互联网</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/xiaolangwiki/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/xiaolangwiki/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/xiaolangwiki/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/xiaolangwiki/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

  <a href="https://github.com/LianTianNo1" class="github-corner" title="LianTianNo1&#96; GitHub" aria-label="LianTianNo1&#96; GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://liantianno1.github.io/xiaolangwiki/2021/07/30/13/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/xiaolangwiki/images/avatar.png">
      <meta itemprop="name" content="小浪wiki">
      <meta itemprop="description" content="一个关于编程、计算机、软件工程、互联网的知识库。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小浪wiki">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/xiaolangwiki/2021/07/30/13/" class="post-title-link" itemprop="url">从了解到深入虚拟dom和实现diff算法虚拟dom算法</a>
        </h2>

        <div class="post-meta">
          
              <i class="fa fa-thumb-tack"></i>
              <font color=7D26CD>置顶</font>
              <span class="post-meta-divider">|</span>
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-07-30 09:14:13" itemprop="dateCreated datePublished" datetime="2021-07-30T09:14:13+08:00">2021-07-30</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/xiaolangwiki/categories/%E5%89%8D%E7%AB%AF/" itemprop="url" rel="index"><span itemprop="name">前端</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="从了解到深入虚拟DOM和实现diff算法虚拟DOM-和-diff-算法"><a href="#从了解到深入虚拟DOM和实现diff算法虚拟DOM-和-diff-算法" class="headerlink" title="从了解到深入虚拟DOM和实现diff算法虚拟DOM 和 diff 算法"></a>从了解到深入虚拟DOM和实现diff算法虚拟DOM 和 diff 算法</h2><p>原文：<a target="_blank" rel="noopener" href="https://juejin.cn/post/6990582632270528525">https://juejin.cn/post/6990582632270528525</a></p>
<blockquote>
<p>前言</p>
</blockquote>
<p><code>虚拟DOM</code> 和 <code>diff</code> 算法 ，大家有的时候就会经常听到，那么它们是什么实现的呢，这是小浪我在学习的 <code>虚拟DOM</code> 和 <code>diff</code> 的时候总结，在这里就来带大家来深入了解 <code>virtual DOM</code> 和 <code>diff</code> 算法，从 <strong>snabbdom</strong> 的基础使用 ,到自己实现一个丐版 <strong>snabbdom</strong>，自己实现 <strong>h函数</strong>(创建虚拟DOM) <strong>patch</strong>函数(通过比较新旧虚拟DOM更新视图)，这里我也画了几个动图 来帮助大家理解 <strong>diff</strong> 的四种优化策略，文章有点长，希望大家耐心阅读，最后会贴出所有代码，大家可以动手试试喔</p>
<p>最后希望大家能给小浪一个 <strong>赞</strong></p>
<blockquote>
<p>往期精彩：</p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6989106100582744072" title="https://juejin.cn/post/6989106100582744072">手写一个简易vue响应式带你了解响应式原理</a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6988316779818778631" title="https://juejin.cn/post/6988316779818778631">从使用到自己实现简单Vue Router看这个就行了</a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6983934602196811789" title="https://juejin.cn/post/6983934602196811789">前端面试必不可少的基础知识，虽然少但是你不能不知道</a></p>
</blockquote>
<h2 id="1-介绍"><a href="#1-介绍" class="headerlink" title="1.介绍"></a>1.介绍</h2><blockquote>
<p><strong>Virtual DOM</strong> 简单的介绍</p>
</blockquote>
<p>是<code>JavaScript</code>按照<code>DOM</code>的结构来创建的虚拟树型结构对象，是对<code>DOM</code>的抽象，比<code>DOM</code>更加轻量型</p>
<blockquote>
<p>为啥要使用<strong>Virtual DOM</strong></p>
</blockquote>
<ul>
<li>当然是前端优化方面，避免频繁操作<code>DOM</code>，频繁操作<code>DOM</code>会可能让浏览器回流和重绘，性能也会非常低，还有就是手动操作 <code>DOM</code> 还是比较麻烦的，要考虑浏览器兼容性问题，当前<code>jQuery</code>等库简化了 <code>DOM</code>操作，但是项目复杂了，<code>DOM</code>操作还是会变得复杂，数据操作也变得复杂</li>
<li>并不是所有情况使用虚拟<code>DOM</code> 都提高性能，是针对在复杂的的项目使用。如果简单的操作，使用虚拟<code>DOM</code>,要创建虚拟<code>DOM</code>对象等等一系列操作，还不如普通的<code>DOM</code> 操作</li>
<li>虚拟<code>DOM</code> 可以实现跨平台渲染，服务器渲染 、小程序、原生应用都使用了虚拟<code>DOM</code></li>
<li>使用虚拟<code>DOM</code>改变了当前的状态不需要立即的去更新<code>DOM</code> 而且更新的内容进行更新，对于没有改变的内容不做任何操作，通过前后两次差异进行比较</li>
<li>虚拟 DOM 可以维护程序的状态，跟踪上一次的状态</li>
</ul>
<h2 id="2-snabbdom-介绍"><a href="#2-snabbdom-介绍" class="headerlink" title="2.snabbdom 介绍"></a>2.snabbdom 介绍</h2><blockquote>
<p>首先来介绍下 snabbdom</p>
</blockquote>
<p>我们要了解虚拟DOM ，那么就先了解它的始祖，也就是 <strong>snabbdom</strong></p>
<p><strong>snabbdom</strong> 是一个开源的项目，<strong>Vue</strong> 里面的 虚拟<strong>DOM</strong> 当初是借鉴了 <strong>snabbdom</strong>,我们可以通过了解<strong>snabbdom</strong> 的虚拟<strong>DOM</strong> 来理解 <strong>Vue</strong> 的虚拟<strong>DOM</strong>,<strong>Vue</strong> 的源码太多，<strong>snabbdom</strong> 比较简洁，所以用它来展开 虚拟 <strong>DOM</strong> 的研究</p>
<p>通过npm 进行安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install snabbdom</span><br></pre></td></tr></table></figure>
<h3 id="1-snabbdom简单使用"><a href="#1-snabbdom简单使用" class="headerlink" title="1.snabbdom简单使用"></a>1.snabbdom简单使用</h3><blockquote>
<p>下面来写个简单的例子使用下 snabbdom</p>
</blockquote>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;./js/test.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>写个 test.js 进行使用</p>
</blockquote>
 <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; h, init, thunk &#125; <span class="keyword">from</span> <span class="string">&#x27;snabbdom&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> patch = <span class="title function_">init</span>(\[\])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> vnode = <span class="title function_">h</span>(<span class="string">&#x27;div#box&#x27;</span>, <span class="string">&#x27;测试&#x27;</span>, \[</span><br><span class="line">  <span class="title function_">h</span>(<span class="string">&#x27;ul.list&#x27;</span>, \[</span><br><span class="line">    <span class="title function_">h</span>(<span class="string">&#x27;li&#x27;</span>, <span class="string">&#x27;我是一个li&#x27;</span>),</span><br><span class="line">    <span class="title function_">h</span>(<span class="string">&#x27;li&#x27;</span>, <span class="string">&#x27;我是一个li&#x27;</span>),</span><br><span class="line">    <span class="title function_">h</span>(<span class="string">&#x27;li&#x27;</span>, <span class="string">&#x27;我是一个li&#x27;</span>),</span><br><span class="line">  \]),</span><br><span class="line">\])</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> app = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;#app&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> oldNode = <span class="title function_">patch</span>(app, vnode)</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> vNode = <span class="title function_">h</span>(<span class="string">&#x27;div#box&#x27;</span>, <span class="string">&#x27;重新获取了数据&#x27;</span>, \[</span><br><span class="line">    <span class="title function_">h</span>(<span class="string">&#x27;ul.list&#x27;</span>, \[</span><br><span class="line">      <span class="title function_">h</span>(<span class="string">&#x27;li&#x27;</span>, <span class="string">&#x27;我是一个li&#x27;</span>),</span><br><span class="line">      <span class="title function_">h</span>(<span class="string">&#x27;li&#x27;</span>, <span class="string">&#x27;通过path判断了差异性&#x27;</span>),</span><br><span class="line">      <span class="title function_">h</span>(<span class="string">&#x27;li&#x27;</span>, <span class="string">&#x27;更新了数据&#x27;</span>),</span><br><span class="line">    \]),</span><br><span class="line">  \])</span><br><span class="line"></span><br><span class="line">  <span class="title function_">patch</span>(oldNode, vNode)</span><br><span class="line">&#125;, <span class="number">3000</span>)</span><br></pre></td></tr></table></figure>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/93f5b5f17b44461485732581e68afd90~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp" alt="image-20210726224703891"></p>
<p>可以看见把 虚拟<strong>DOM</strong>更新到了 真实<strong>DOM</strong> ,直接 把之前的 <strong>div#app</strong> 给替换更新了</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/33bb43d23ef649e58cca26cf4e6290a9~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp" alt="9"></p>
<p>过了3秒进行对比虚拟<strong>DOM</strong> 的 差异来添加到真实<strong>DOM</strong> ，这里改变了第二个和第三个 <strong>li</strong> 用h函数渲染成虚拟<strong>DOM</strong> 和<strong>oldNode</strong> 不一样所以进行了对比更新</p>
<h3 id="2-介绍下-snabbdom中的模块"><a href="#2-介绍下-snabbdom中的模块" class="headerlink" title="2.介绍下 snabbdom中的模块"></a>2.介绍下 snabbdom中的模块</h3><blockquote>
<p>几个模块 这里简单过一下</p>
</blockquote>
<div class="table-container">
<table>
<thead>
<tr>
<th>模块名</th>
<th>简介</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>attributes</strong></td>
<td>DOM 自定义属性，包括两个布尔值 <code>checked``selected</code>，通过<code>setAttribute()</code> 设置</td>
</tr>
<tr>
<td><strong>props</strong></td>
<td>是DOM 的 property属性，通过 <code>element\[attr\] = value</code> 设置</td>
</tr>
<tr>
<td><strong>dataset</strong></td>
<td>是 <code>data-</code> 开头的属性 data-src…</td>
</tr>
<tr>
<td><strong>style</strong></td>
<td>行内样式</td>
</tr>
<tr>
<td><strong>eventListeners</strong></td>
<td>用来注册和移除事件</td>
</tr>
</tbody>
</table>
</div>
<blockquote>
<p>有了上面的介绍，那我们就来简单的使用一下</p>
</blockquote>
 <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; h, init &#125; <span class="keyword">from</span> <span class="string">&#x27;snabbdom&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> attr <span class="keyword">from</span> <span class="string">&#x27;snabbdom/modules/attributes&#x27;</span></span><br><span class="line"><span class="keyword">import</span> style <span class="keyword">from</span> <span class="string">&#x27;snabbdom/modules/style&#x27;</span></span><br><span class="line"><span class="keyword">import</span> eventListeners <span class="keyword">from</span> <span class="string">&#x27;snabbdom/modules/eventlisteners&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> patch = <span class="title function_">init</span>(\[attr, style, eventListeners\])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> vnode = <span class="title function_">h</span>(</span><br><span class="line">  <span class="string">&#x27;div#app&#x27;</span>,</span><br><span class="line">  &#123;</span><br><span class="line"></span><br><span class="line">    <span class="attr">attrs</span>: &#123;</span><br><span class="line">      <span class="attr">myattr</span>: <span class="string">&#x27;我是自定义属性&#x27;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="attr">style</span>: &#123;</span><br><span class="line">      <span class="attr">fontSize</span>: <span class="string">&#x27;29px&#x27;</span>,</span><br><span class="line">      <span class="attr">color</span>: <span class="string">&#x27;skyblue&#x27;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="attr">on</span>: &#123;</span><br><span class="line">      <span class="attr">click</span>: clickHandler,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&#x27;我是内容&#x27;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">clickHandler</span>(<span class="params"></span>) &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> elm = <span class="variable language_">this</span>.<span class="property">elm</span></span><br><span class="line">  elm.<span class="property">style</span>.<span class="property">color</span> = <span class="string">&#x27;red&#x27;</span></span><br><span class="line">  elm.<span class="property">textContent</span> = <span class="string">&#x27;我被点击了&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> app = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;#app&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="title function_">patch</span>(app, vnode)</span><br></pre></td></tr></table></figure>
<p>然后再 <code>html</code> 中引入</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;./js/module_test.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>来看看效果</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1875f83c496e4ad282639c099b510ac9~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp" alt="11"></p>
<p>可以看见的是 自定义属性 ，行内样式 ，点击事件都被 <strong>h()</strong> 渲染出来了</p>
<p>上面的使用都简单地过了一遍，那么我们就来看看 <strong>snabbdom</strong> 中的源码吧</p>
<h2 id="3-虚拟DOM-例子"><a href="#3-虚拟DOM-例子" class="headerlink" title="3.虚拟DOM 例子"></a>3.虚拟DOM 例子</h2><p>说了这么久的 <strong>h()</strong> 函数和 虚拟<strong>DOM</strong> 那么 渲染出来的 虚拟<strong>DOM</strong> 是什么样呢</p>
<blockquote>
<p>真实DOM 结构</p>
</blockquote>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;container&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">p</span>&gt;</span>哈哈<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">&quot;list&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span>&gt;</span>1<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span>&gt;</span>2<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>转为为 虚拟DOM 之后的结构</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">  <span class="string">&quot;sel&quot;</span>: <span class="string">&quot;div&quot;</span>,</span><br><span class="line"></span><br><span class="line">  <span class="string">&quot;data&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;class&quot;</span>: &#123; <span class="string">&quot;container&quot;</span>: <span class="literal">true</span> &#125;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="string">&quot;elm&quot;</span>: <span class="literal">undefined</span>,</span><br><span class="line"></span><br><span class="line">  <span class="string">&quot;key&quot;</span>: <span class="literal">undefined</span>,</span><br><span class="line"></span><br><span class="line">  <span class="string">&quot;children&quot;</span>: \[</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;elm&quot;</span>: <span class="literal">undefined</span>,</span><br><span class="line">      <span class="string">&quot;key&quot;</span>: <span class="literal">undefined</span>,</span><br><span class="line">      <span class="string">&quot;sel&quot;</span>: <span class="string">&quot;p&quot;</span>,</span><br><span class="line">      <span class="string">&quot;data&quot;</span>: &#123; <span class="string">&quot;text&quot;</span>: <span class="string">&quot;哈哈&quot;</span> &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;elm&quot;</span>: <span class="literal">undefined</span>,</span><br><span class="line">      <span class="string">&quot;key&quot;</span>: <span class="literal">undefined</span>,</span><br><span class="line">      <span class="string">&quot;sel&quot;</span>: <span class="string">&quot;ul&quot;</span>,</span><br><span class="line">      <span class="string">&quot;data&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;class&quot;</span>: &#123; <span class="string">&quot;list&quot;</span>: <span class="literal">true</span> &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;children&quot;</span>: \[</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;elm&quot;</span>: <span class="literal">undefined</span>,</span><br><span class="line">          <span class="string">&quot;key&quot;</span>: <span class="literal">undefined</span>,</span><br><span class="line">          <span class="string">&quot;sel&quot;</span>: <span class="string">&quot;li&quot;</span>,</span><br><span class="line">          <span class="string">&quot;data&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;text&quot;</span>: <span class="string">&quot;1&quot;</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="string">&quot;children&quot;</span>: <span class="literal">undefined</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;elm&quot;</span>: <span class="literal">undefined</span>,</span><br><span class="line">          <span class="string">&quot;key&quot;</span>: <span class="literal">undefined</span>,</span><br><span class="line">          <span class="string">&quot;sel&quot;</span>: <span class="string">&quot;li&quot;</span>,</span><br><span class="line">          <span class="string">&quot;data&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;text&quot;</span>: <span class="string">&quot;1&quot;</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="string">&quot;children&quot;</span>: <span class="literal">undefined</span></span><br><span class="line">        &#125;</span><br><span class="line">      \]</span><br><span class="line">    &#125;</span><br><span class="line">  \]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在之前提到的 <code>snabbdom</code> 中 <code>patch</code>方法</p>
<p>就是对 <strong>新的虚拟DOM</strong> 和 <strong>老的虚拟DOM</strong> 进行<strong>diff</strong>(精细化比较)，找出最小量更新 是在虚拟<strong>DOM</strong> 比较</p>
<p>不可能把所有的 <strong>DOM</strong> 都拆掉 然后全部重新渲染</p>
<h2 id="4-h-函数"><a href="#4-h-函数" class="headerlink" title="4.h 函数"></a>4.h 函数</h2><p>在上面我们体验了<strong>虚拟DOM</strong>的使用 ，那么我们现在来实现一个 丐版的 <strong>snabbdom</strong></p>
<blockquote>
<p>h 函数在介绍下</p>
</blockquote>
<p>在 <strong>snabbdom</strong> 我们也使用了多次的 <strong>h</strong> 函数，主要作用是创建 虚拟节点</p>
<p><strong>snabbdom</strong> 使用 <strong>TS</strong> 编写, 所以 <strong>h</strong> 函数中做了 <strong>方法重载</strong> 使用起来灵活</p>
<p>下面是 <strong>snabbdom</strong> 中 <strong>h</strong> 函数，可以看出 参数的有好几种方式</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> declare <span class="keyword">function</span> <span class="title function_">h</span>(<span class="params">sel: string</span>): <span class="title class_">VNode</span>;</span><br><span class="line"><span class="keyword">export</span> declare <span class="keyword">function</span> <span class="title function_">h</span>(<span class="params">sel: string, data: VNodeData</span>): <span class="title class_">VNode</span>;</span><br><span class="line"><span class="keyword">export</span> declare <span class="keyword">function</span> <span class="title function_">h</span>(<span class="params">sel: string, children: VNodeChildren</span>): <span class="title class_">VNode</span>;</span><br><span class="line"><span class="keyword">export</span> declare <span class="keyword">function</span> <span class="title function_">h</span>(<span class="params">sel: string, data: VNodeData, children: VNodeChildren</span>): <span class="title class_">VNode</span>;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>实现 vnode 函数</p>
</blockquote>
<p>在写 <strong>h</strong> 函数之前 先实现 <strong>vnode</strong> 函数，<strong>vnode</strong> 函数要在 <strong>h</strong> 中使用， 其实这个 <strong>vnode</strong> 函数实现功能非常简单 在 <strong>TS</strong> 里面规定了很多类型，不过我这里和之后都是 用 <strong>JS</strong> 去写</p>
 <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">\* 把传入的 参数 作为 对象返回</span><br><span class="line"> \* @param &#123;string&#125; sel 选择器</span><br><span class="line"> \* @param &#123;object&#125; data 数据</span><br><span class="line"> \* @param &#123;array&#125; children 子节点</span><br><span class="line"> \* @param &#123;string&#125; text 文本</span><br><span class="line"> \* @param &#123;dom&#125; elm <span class="variable constant_">DOM</span></span><br><span class="line"> \* @returns object</span><br><span class="line"> */</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> (<span class="params">sel, data, children, text, elm</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123; sel, data, children, text, elm &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>实现简易 h 函数</p>
</blockquote>
<p>这里写的 h 函数 只实现主要功能，没有实现重载，直接实现 3个 参数的 h 函数</p>
 <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> vnode <span class="keyword">from</span> <span class="string">&#x27;./vnode&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> \*</span><br><span class="line"> \* @param &#123;string&#125; a sel</span><br><span class="line"> \* @param &#123;object&#125; b data</span><br><span class="line"> \* @param &#123;any&#125; c 是子节点 可以是文本，数组</span><br><span class="line"> */</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">h</span>(<span class="params">a, b, c</span>) &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">arguments</span>.<span class="property">length</span> &lt; <span class="number">3</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;请检查参数个数&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> c === <span class="string">&#x27;string&#x27;</span> || <span class="keyword">typeof</span> c === <span class="string">&#x27;number&#x27;</span>) &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">vnode</span>(a, b, <span class="literal">undefined</span>, c, <span class="literal">undefined</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(c)) &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> children = \[\]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; c.<span class="property">length</span>; i++) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!(<span class="keyword">typeof</span> c\[i\] === <span class="string">&#x27;object&#x27;</span> &amp;&amp; c\[i\].<span class="property">sel</span>))</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;第三个参数为数组时只能传递 h() 函数&#x27;</span>)</span><br><span class="line"></span><br><span class="line">      children.<span class="title function_">push</span>(c\[i\])</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">vnode</span>(a, b, children, <span class="literal">undefined</span>, <span class="literal">undefined</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> c === <span class="string">&#x27;object&#x27;</span> &amp;&amp; c.<span class="property">sel</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> children = \[c\]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">vnode</span>(a, b, children, <span class="literal">undefined</span>, <span class="literal">undefined</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>是不是很简单呢，他说起来也不是递归，像是一种嵌套，不断地收集 <strong>{sel,data,children,text,elm}</strong></p>
<p><strong>chirldren</strong> 里面再套 <strong>{sel,data,children,text,elm}</strong></p>
<blockquote>
<p>举个例子</p>
</blockquote>
 <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> h <span class="keyword">from</span> <span class="string">&#x27;./my-snabbdom/h&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> vnode = <span class="title function_">h</span>(<span class="string">&#x27;div&#x27;</span>, &#123;&#125;,</span><br><span class="line">  <span class="title function_">h</span>(<span class="string">&#x27;ul&#x27;</span>, &#123;&#125;, \[</span><br><span class="line">    <span class="title function_">h</span>(<span class="string">&#x27;li&#x27;</span>, &#123;&#125;, <span class="string">&#x27;我是一个li&#x27;</span>),</span><br><span class="line">    <span class="title function_">h</span>(<span class="string">&#x27;li&#x27;</span>, &#123;&#125;, <span class="string">&#x27;我是一个li&#x27;</span>),</span><br><span class="line">    <span class="title function_">h</span>(<span class="string">&#x27;li&#x27;</span>, &#123;&#125;, <span class="string">&#x27;我是一个li&#x27;</span>),</span><br><span class="line">  ),</span><br><span class="line">\])</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(vnode)</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;container&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;/virtualdir/bundle.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/942b20c050664ddb82a4073c95198075~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp" alt="image-20210727204731661"></p>
<p><strong>OK</strong>，写的 <strong>h</strong> 函数没有问题，生成了虚拟<strong>DOM</strong> 树，生成了虚拟 DOM,我们之后 就会用的到</p>
<p>简单说下流程吧</p>
<p>大家都知道<code>js</code> 函数执行，当然是先执行最里面的 函数</p>
<ul>
<li><p>1.<code>h(&#39;li&#39;, &#123;&#125;, &#39;我是一个li&#39;)</code>第一个执行 返回的 <code>&#123;sel,data,children,text,elm&#125;</code> 连续三个 li 都是这个</p>
</li>
<li><p>2.接着就是 <code>h(&#39;ul&#39;, &#123;&#125;, \[\])</code> 进入到了第二个判断是否为数组，然后 把每一项 进行判断是否对象 和 有<strong>sel</strong> 属性，然后添加到 <strong>children</strong> 里面又返回了出去 <code>&#123;sel,data,children,text,elm&#125;</code></p>
</li>
<li><p>3.第三就是执行 <code>h(&#39;div&#39;, &#123;&#125;,h())</code> 了， 第三个参数 直接是 <code>h()</code>函数 = <code>&#123;sel,data,children,text,elm&#125;</code> ，他的 <strong>children</strong> 把他用 <strong>[ ]</strong> 包起来</p>
<p>再返回给 <strong>vnode</strong></p>
</li>
</ul>
<h2 id="5-patch-函数"><a href="#5-patch-函数" class="headerlink" title="5.patch 函数"></a>5.patch 函数</h2><blockquote>
<p>简介</p>
</blockquote>
<p>在 <strong>snabbdom</strong> 中我们 通过 <strong>init()</strong> 返回了一个 <strong>patch</strong> 函数，通过 <strong>patch</strong> 进行吧比较两个 虚拟 DOM 然后添加的 真实的 <strong>DOM</strong> 树上，中间比较就是我们等下要说的 <strong>diff</strong></p>
<p>先来了解下 <strong>patch</strong>里面做了什么</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/58f567538c1d4cffa7264cf5467ed271~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp" alt="image-20210728172052418"></p>
<p>按照上面的流程我们来写个简单的 <strong>patch</strong></p>
<h3 id="1-patch"><a href="#1-patch" class="headerlink" title="1.patch"></a>1.patch</h3><blockquote>
<p>先写个sameVnode</p>
</blockquote>
<p>用来对比两个虚拟<strong>DOM</strong> 的 <strong>key</strong> 和 <strong>sel</strong></p>
 <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">\* 判断两个虚拟节点是否是同一节点</span><br><span class="line"> \* @param &#123;vnode&#125; vnode1 虚拟节点<span class="number">1</span></span><br><span class="line"> \* @param &#123;vnode&#125; vnode2 虚拟节点<span class="number">2</span></span><br><span class="line"> \* @returns boolean</span><br><span class="line"> */</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">sameVnode</span>(<span class="params">vnode1, vnode2</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    (vnode1.<span class="property">data</span> ? vnode1.<span class="property">data</span>.<span class="property">key</span> : <span class="literal">undefined</span>) ===</span><br><span class="line">      (vnode2.<span class="property">data</span> ? vnode2.<span class="property">data</span>.<span class="property">key</span> : <span class="literal">undefined</span>) &amp;&amp; vnode1.<span class="property">sel</span> === vnode2.<span class="property">sel</span></span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>写个基础的patch</p>
</blockquote>
 <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> vnode <span class="keyword">from</span> <span class="string">&#x27;./vnode&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> \*</span><br><span class="line"> \* @param &#123;vnode/<span class="variable constant_">DOM</span>&#125; oldVnode</span><br><span class="line"> \* @param &#123;vnode&#125; newVnode</span><br><span class="line"> */</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">patch</span>(<span class="params">oldVnode, newVnode</span>) &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!oldVnode.<span class="property">sel</span>) &#123;</span><br><span class="line"></span><br><span class="line">    oldVnode = <span class="title function_">emptyNodeAt</span>(oldVnode)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">sameVnode</span>(oldVnode, newVnode)) &#123;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">  newVnode.<span class="property">elm</span> = oldVnode.<span class="property">elm</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> newVnode</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> \* 转为 虚拟 <span class="variable constant_">DOM</span></span><br><span class="line"> \* @param &#123;<span class="variable constant_">DOM</span>&#125; elm <span class="variable constant_">DOM</span>节点</span><br><span class="line"> \* @returns &#123;object&#125;</span><br><span class="line"> */</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">emptyNodeAt</span>(<span class="params">elm</span>) &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">vnode</span>(elm.<span class="property">tagName</span>.<span class="title function_">toLowerCase</span>(), <span class="literal">undefined</span>, <span class="literal">undefined</span>, <span class="literal">undefined</span>, elm)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在要处理是否是 同一个虚拟节点的问题</p>
<h3 id="2-createElm"><a href="#2-createElm" class="headerlink" title="2.createElm"></a>2.createElm</h3><blockquote>
<p>先来处理不是同一个虚拟节点</p>
</blockquote>
<p>处理这个我们得去写个 创建节点的方法 这里就放到 <strong>createElm.js</strong> 中完成</p>
 <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">\* 创建元素</span><br><span class="line"> \* @param &#123;vnode&#125; vnode 要创建的节点</span><br><span class="line"> */</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">createElm</span>(<span class="params">vnode</span>) &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> node = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(vnode.<span class="property">sel</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    vnode.<span class="property">text</span> !== <span class="string">&#x27;&#x27;</span> &amp;&amp;</span><br><span class="line">    (vnode.<span class="property">children</span> === <span class="literal">undefined</span> || vnode.<span class="property">children</span>.<span class="property">length</span> === <span class="number">0</span>)</span><br><span class="line">  ) &#123;</span><br><span class="line"></span><br><span class="line">    node.<span class="property">textContent</span> = vnode.<span class="property">text</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(vnode.<span class="property">children</span>) &amp;&amp; vnode.<span class="property">children</span>.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> children = vnode.<span class="property">children</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; children.<span class="property">length</span>; i++) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">let</span> ch = children\[i\]</span><br><span class="line"></span><br><span class="line">      <span class="keyword">let</span> chDom = <span class="title function_">createElm</span>(ch)</span><br><span class="line"></span><br><span class="line">      node.<span class="title function_">appendChild</span>(chDom)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  vnode.<span class="property">elm</span> = node</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> node</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的 <strong>createElm</strong> 就是使用了递归的方式去创建子节点 ，然后我们就去 patch 中 具体的调用这个 创建节点的方法</p>
 <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> vnode <span class="keyword">from</span> <span class="string">&#x27;./vnode&#x27;</span></span><br><span class="line"><span class="keyword">import</span> createElm <span class="keyword">from</span> <span class="string">&#x27;./createElm&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> \*</span><br><span class="line"> \* @param &#123;vnode/<span class="variable constant_">DOM</span>&#125; oldVnode</span><br><span class="line"> \* @param &#123;vnode&#125; newVnode</span><br><span class="line"> */</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">patch</span>(<span class="params">oldVnode, newVnode</span>) &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!oldVnode.<span class="property">sel</span>) &#123;</span><br><span class="line"></span><br><span class="line">    oldVnode = <span class="title function_">emptyNodeAt</span>(oldVnode)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">sameVnode</span>(oldVnode, newVnode)) &#123;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> newNode = <span class="title function_">createElm</span>(newVnode)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (oldVnode.<span class="property">elm</span>.<span class="property">parentNode</span>) &#123;</span><br><span class="line">      <span class="keyword">let</span> parentNode = oldVnode.<span class="property">elm</span>.<span class="property">parentNode</span></span><br><span class="line"></span><br><span class="line">      parentNode.<span class="title function_">insertBefore</span>(newNode, oldVnode.<span class="property">elm</span>)</span><br><span class="line"></span><br><span class="line">      parentNode.<span class="title function_">removeChild</span>(oldVnode.<span class="property">elm</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  newVnode.<span class="property">elm</span> = oldVnode.<span class="property">elm</span></span><br><span class="line">  <span class="keyword">return</span> newVnode</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在递归添加子节点 到了最后我们在 <strong>patch</strong> 添加到 真实的 <strong>DOM</strong> 中，移除之前的老节点</p>
<p>写到这里了来试试 不同节点 是否真的添加</p>
 <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> h <span class="keyword">from</span> <span class="string">&#x27;./my-snabbdom/h&#x27;</span></span><br><span class="line"><span class="keyword">import</span> patch <span class="keyword">from</span> <span class="string">&#x27;./my-snabbdom/patch&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> app = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;#app&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> vnode = <span class="title function_">h</span>(<span class="string">&#x27;ul&#x27;</span>, &#123;&#125;, \[</span><br><span class="line">  <span class="title function_">h</span>(<span class="string">&#x27;li&#x27;</span>, &#123;&#125;, <span class="string">&#x27;我是一个li&#x27;</span>),</span><br><span class="line">  <span class="title function_">h</span>(<span class="string">&#x27;li&#x27;</span>, &#123;&#125;, \[</span><br><span class="line">    <span class="title function_">h</span>(<span class="string">&#x27;p&#x27;</span>, &#123;&#125;, <span class="string">&#x27;我是一个p&#x27;</span>),</span><br><span class="line">    <span class="title function_">h</span>(<span class="string">&#x27;p&#x27;</span>, &#123;&#125;, <span class="string">&#x27;我是一个p&#x27;</span>),</span><br><span class="line">    <span class="title function_">h</span>(<span class="string">&#x27;p&#x27;</span>, &#123;&#125;, <span class="string">&#x27;我是一个p&#x27;</span>),</span><br><span class="line">  \]),</span><br><span class="line">  <span class="title function_">h</span>(<span class="string">&#x27;li&#x27;</span>, &#123;&#125;, <span class="string">&#x27;我是一个li&#x27;</span>),</span><br><span class="line">\])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> oldVnode = <span class="title function_">patch</span>(app, vnode)</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span>hellow<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;/virtualdir/bundle.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6be430ef040d448b8b2b059b4823dfc2~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp" alt="image-20210728164308771"></p>
<p>把 <strong>div#app</strong> 给替换了，并且成功替换</p>
<h3 id="3-patchVnode"><a href="#3-patchVnode" class="headerlink" title="3.patchVnode"></a>3.patchVnode</h3><blockquote>
<p>我们现在来实现同一个虚拟 DOM 的处理</p>
</blockquote>
<p>在 patchVnode 中</p>
<p>步骤都是按照 之前那个流程图进行编写,我们把比较两个<strong>相同</strong>的 虚拟 DOM 代码写在 <strong>patchVnode.js</strong>中</p>
<p>在比较 两个相同的虚拟节点分支 有好几种情况</p>
 <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> createElm <span class="keyword">from</span> <span class="string">&#x27;./createElm&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> \*</span><br><span class="line"> \* @param &#123;vnode&#125; oldVnode 老的虚拟节点</span><br><span class="line"> \* @param &#123;vnode&#125; newVnode 新的虚拟节点</span><br><span class="line"> \* @returns</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">patchVnode</span>(<span class="params">oldVnode, newVnode</span>) &#123;</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;同一个虚拟节点&#x27;</span>)</span><br><span class="line">  <span class="keyword">if</span> (oldVnode === newVnode) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (newVnode.<span class="property">text</span> &amp;&amp; !newVnode.<span class="property">children</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (oldVnode.<span class="property">text</span> !== newVnode.<span class="property">text</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;文字不相同&#x27;</span>)</span><br><span class="line"></span><br><span class="line">      oldVnode.<span class="property">elm</span>.<span class="property">textContent</span> = newVnode.<span class="property">text</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (oldVnode.<span class="property">children</span>) &#123;</span><br><span class="line">      ...这里新旧节点都存在children 这里要使用 updateChildren 下面进行实现</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;old没有children，new有children&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      oldVnode.<span class="property">elm</span>.<span class="property">innerHTML</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">let</span> newChildren = newVnode.<span class="property">children</span></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; newChildren.<span class="property">length</span>; i++) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> node = <span class="title function_">createElm</span>(newChildren\[i\])</span><br><span class="line"></span><br><span class="line">        oldVnode.<span class="property">elm</span>.<span class="title function_">appendChild</span>(node)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>按照流程图进行编码，现在要处理 <strong>newVnode</strong> 和 <strong>oldVnode</strong> 都存在 <strong>children</strong> 的情况了</p>
<p>在这里我们要进行精细化比较 也就是我们经常说的 <strong>diff</strong></p>
<h3 id="4-diff"><a href="#4-diff" class="headerlink" title="4.diff"></a>4.diff</h3><p>经常听到的 <strong>diff(精细化比较)</strong> ,那我们先来了解下</p>
<blockquote>
<p>diff四种优化策略</p>
</blockquote>
<p>在这里要使用 4 个指针,从1-4的顺序来开始命中优化策略，命中一个，指针进行移动<code>(新前和旧前向下移动，新后和旧后向上移动)</code>，没有命中，就使用<strong>下一个策略</strong>，如果四个策略都没有命中，只能靠循环来找</p>
<p>命中：两个节点 <strong>sel</strong> 和 <strong>key</strong> 一样</p>
<ol>
<li>新前与旧前</li>
<li>新后与旧后</li>
<li>新后与旧前</li>
<li>新前与旧后</li>
</ol>
<blockquote>
<p>先来说下新增的情况</p>
</blockquote>
<p>四种策略都是在 循环里面执行</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span>(旧前&lt;=旧后&amp;&amp;新前&lt;=新后)&#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c5d39847b94f4a3ca1763eb939366ae0~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp" alt="14"></p>
<p>可以看出 <strong>旧子节点</strong> 先循环完毕，那么说明了新的子节点有需要 新增的 子节点</p>
<p><strong>新前</strong> 和 <strong>新后</strong> 的 节点 就是需要新增的字节</p>
<blockquote>
<p>删除的情况1</p>
</blockquote>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a8727f03b28e4dd48d960c73e3b4be85~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp" alt="19"></p>
<p>这里新子节点 先循环完毕说明 旧子节点有需要删除的节点</p>
<blockquote>
<p>删除的情况2</p>
</blockquote>
<p>当我们删除多个，而且 4种策略都没有满足，我们得通过 <strong>while</strong> 循环 旧子节点 找到 新子节点需要寻找节点并标记为 <code>undefined</code> 虚拟节点是 <strong>undefined</strong>实际上在 <strong>DOM</strong>已经把它移动了 ,<strong>旧前</strong> 和 <strong>旧后</strong> 之间的节点就是需要删除的节点</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a4bc4cbb7093444988b87830f036bba3~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp" alt="18"></p>
<blockquote>
<p>复杂情况1</p>
</blockquote>
<p>当触发了 第四种 策略，这里就需要移动节点了，旧后指向的节点（在虚拟节点标为 <strong>undefined</strong>），实际把 <strong>新前</strong> 指向的节点 在<strong>DOM</strong> 中 移动到<strong>旧前之前</strong></p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/99cc589cb22548528139cc46d6498234~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp" alt="20"></p>
<blockquote>
<p>复杂情况2</p>
</blockquote>
<p>当触发了 第三种 策略，这里也需要移动节点了，旧前 指向的节点（在虚拟节点标为 <strong>undefined</strong>），实际把 <strong>新后</strong> 指向的节点 在<strong>DOM</strong> 中 移动到<strong>旧后之后</strong></p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1f9bbbb7afce48da85d76991d7367e80~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp" alt="21"></p>
<blockquote>
<p>注意几个点 :</p>
</blockquote>
<ul>
<li><code>h(&#39;li&#39;,&#123;key:&#39;A&#39;&#125; : &quot;A&quot;&#125;)</code> 比如这其中的 key 是这个节点的唯一的标识</li>
<li>它的存在是在告诉 <strong>diff</strong> ,在更改前后它们是同一个<strong>DOM</strong>节点。</li>
<li>只有是<strong>同一个虚拟节点，</strong>才进行精细化比较，否则就是<strong>暴力删除旧的</strong>、插入新的</li>
<li>同一虚拟节点 不仅要 key 相同而且要 选择器相同也就是上面的 <code>h()</code> 函数创建的 虚拟节点 对象里的 <code>sel</code></li>
<li>只进行同层比较，不会进行跨层比较</li>
</ul>
<h3 id="5-updateChildren"><a href="#5-updateChildren" class="headerlink" title="5.updateChildren"></a>5.updateChildren</h3><p>看了上面对于 <strong>diff</strong> 的介绍，不知道我画的图 演示清楚了没，然后我们接着继续来完成 <strong>patchVnode</strong></p>
<p>我们得写个 <strong>updateChildren</strong> 来进行精细化比较</p>
<p>这个文件就是 <strong>diff</strong> 算法的核心，我们用来比较 <strong>oldVnode</strong> 和 <strong>newVnode</strong> 都存在 <strong>children</strong> 的情况</p>
<p>这里有点绕，注释都写了，请耐心观看，流程就是按照 diff 的四种策略来写，还要处理没有命中的情况</p>
 <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> createElm <span class="keyword">from</span> <span class="string">&#x27;./createElm&#x27;</span></span><br><span class="line"><span class="keyword">import</span> patchVnode <span class="keyword">from</span> <span class="string">&#x27;./patchVnode&#x27;</span></span><br><span class="line"><span class="keyword">import</span> sameVnode <span class="keyword">from</span> <span class="string">&#x27;./sameVnode&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> \*</span><br><span class="line"> \* @param &#123;dom&#125; parentElm 父节点</span><br><span class="line"> \* @param &#123;array&#125; oldCh 旧子节点</span><br><span class="line"> \* @param &#123;array&#125; newCh 新子节点</span><br><span class="line"> */</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">updateChildren</span>(<span class="params">parentElm, oldCh, newCh</span>) &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> oldStartIdx = <span class="number">0</span>,</span><br><span class="line">    newStartIdx = <span class="number">0</span></span><br><span class="line">  <span class="keyword">let</span> oldEndIdx = oldCh.<span class="property">length</span> - <span class="number">1</span></span><br><span class="line">  <span class="keyword">let</span> newEndIdx = newCh.<span class="property">length</span> - <span class="number">1</span></span><br><span class="line">  <span class="keyword">let</span> oldStartVnode = oldCh\[<span class="number">0</span>\]</span><br><span class="line">  <span class="keyword">let</span> oldEndVnode = oldCh\[oldEndIdx\]</span><br><span class="line">  <span class="keyword">let</span> newStartVnode = newCh\[<span class="number">0</span>\]</span><br><span class="line">  <span class="keyword">let</span> newEndVnode = newCh\[newEndIdx\]</span><br><span class="line">  <span class="keyword">let</span> keyMap = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (newStartIdx &lt;= newEndIdx &amp;&amp; oldStartIdx &lt;= oldEndIdx) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;---进入diff---&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (oldCh\[oldStartIdx\] == <span class="literal">undefined</span>) &#123;</span><br><span class="line">      oldStartVnode = oldCh\[++oldStartIdx\]</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (oldCh\[oldEndIdx\] == <span class="literal">undefined</span>) &#123;</span><br><span class="line">      oldEndVnode = oldCh\[--oldEndIdx\]</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (newCh\[newStartIdx\] == <span class="literal">undefined</span>) &#123;</span><br><span class="line">      newStartVnode = newCh\[++newStartIdx\]</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (newCh\[newEndIdx\] == <span class="literal">undefined</span>) &#123;</span><br><span class="line">      newEndVnode = newCh\[--newEndIdx\]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">sameVnode</span>(oldStartVnode, newStartVnode)) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;1命中&#x27;</span>)</span><br><span class="line"></span><br><span class="line">      <span class="title function_">patchVnode</span>(oldStartVnode, newStartVnode)</span><br><span class="line"></span><br><span class="line">      newStartVnode = newCh\[++newStartIdx\]</span><br><span class="line">      oldStartVnode = oldCh\[++oldStartIdx\]</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">sameVnode</span>(oldEndVnode, newEndVnode)) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;2命中&#x27;</span>)</span><br><span class="line"></span><br><span class="line">      <span class="title function_">patchVnode</span>(oldEndVnode, newEndVnode)</span><br><span class="line"></span><br><span class="line">      newEndVnode = newCh\[--newEndIdx\]</span><br><span class="line">      oldEndVnode = oldCh\[--oldEndIdx\]</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">sameVnode</span>(oldStartVnode, newEndVnode)) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;3命中&#x27;</span>)</span><br><span class="line"></span><br><span class="line">      <span class="title function_">patchVnode</span>(oldStartVnode, newEndVnode)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      parentElm.<span class="title function_">insertBefore</span>(oldStartVnode.<span class="property">elm</span>, oldEndVnode.<span class="property">elm</span>.<span class="property">nextSibling</span>)</span><br><span class="line"></span><br><span class="line">      newEndVnode = newCh\[--newEndIdx\]</span><br><span class="line">      oldStartVnode = oldCh\[++oldStartIdx\]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">sameVnode</span>(oldEndVnode, newStartVnode)) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;4命中&#x27;</span>)</span><br><span class="line"></span><br><span class="line">      <span class="title function_">patchVnode</span>(oldEndVnode, newStartVnode)</span><br><span class="line"></span><br><span class="line">      parentElm.<span class="title function_">insertBefore</span>(oldEndVnode.<span class="property">elm</span>, oldStartVnode.<span class="property">elm</span>)</span><br><span class="line"></span><br><span class="line">      newStartVnode = newCh\[++newStartIdx\]</span><br><span class="line">      oldEndVnode = oldCh\[--oldEndIdx\]</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;diff四种优化策略都没命中&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!keyMap) &#123;</span><br><span class="line"></span><br><span class="line">        keyMap = &#123;&#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = oldStartIdx; i &lt; oldEndIdx; i++) &#123;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">const</span> key = oldCh\[i\].<span class="property">data</span>.<span class="property">key</span></span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (!key) keyMap\[key\] = i</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      <span class="keyword">let</span> idInOld = keyMap\[newStartIdx.<span class="property">data</span>\]</span><br><span class="line">        ? keyMap\[newStartIdx.<span class="property">data</span>.<span class="property">key</span>\]</span><br><span class="line">        : <span class="literal">undefined</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (idInOld) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;移动节点&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> moveElm = oldCh\[idInOld\]</span><br><span class="line"></span><br><span class="line">        <span class="title function_">patchVnode</span>(moveElm, newStartVnode)</span><br><span class="line"></span><br><span class="line">        oldCh\[idInOld\] = <span class="literal">undefined</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        parentElm.<span class="title function_">insertBefore</span>(moveElm.<span class="property">elm</span>, oldStartVnode.<span class="property">elm</span>)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;添加新节点&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        parentElm.<span class="title function_">insertBefore</span>(<span class="title function_">createElm</span>(newStartVnode), oldStartVnode.<span class="property">elm</span>)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      newStartVnode = newCh\[++newStartIdx\]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (newStartIdx &lt;= newEndIdx) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;进入添加剩余节点&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> beforeFlag = newCh\[newEndIdx + <span class="number">1</span>\] ? newCh\[newEndIdx + <span class="number">1</span>\] : <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = newStartIdx; i &lt;= newEndIdx; i++) &#123;</span><br><span class="line"></span><br><span class="line">      parentElm.<span class="title function_">insertBefore</span>(<span class="title function_">createElm</span>(newCh\[i\]), beforeFlag)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (oldStartIdx &lt;= oldEndIdx) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;进入删除多余节点&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = oldStartIdx; i &lt;= oldEndIdx; i++) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (oldCh\[i\].<span class="property">elm</span>) parentElm.<span class="title function_">removeChild</span>(oldCh\[i\].<span class="property">elm</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>到了这里我们基本写都完成了， <strong>h</strong> 函数 创建 虚拟 <strong>DOM</strong> , <strong>patch</strong> 比较 虚拟<strong>DOM</strong> 进行更新视图</p>
<h2 id="6-我们来测试一下写的"><a href="#6-我们来测试一下写的" class="headerlink" title="6.我们来测试一下写的"></a>6.我们来测试一下写的</h2><p>其实在写代码的时候就在不断的调试。。。现在随便测试几个</p>
<h3 id="1-代码"><a href="#1-代码" class="headerlink" title="1.代码"></a>1.代码</h3><blockquote>
<p>html</p>
</blockquote>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;btn&quot;</span>&gt;</span>策略3<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;btn&quot;</span>&gt;</span>复杂<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;btn&quot;</span>&gt;</span>删除<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;btn&quot;</span>&gt;</span>复杂<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;btn&quot;</span>&gt;</span>复杂<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">ul</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span></span><br><span class="line">    hellow</span><br><span class="line">  <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;/virtualdir/bundle.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>index.js</p>
</blockquote>
 <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> h <span class="keyword">from</span> <span class="string">&#x27;./my-snabbdom/h&#x27;</span></span><br><span class="line"><span class="keyword">import</span> patch <span class="keyword">from</span> <span class="string">&#x27;./my-snabbdom/patch&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> app = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;#app&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> vnode = <span class="title function_">h</span>(<span class="string">&#x27;ul&#x27;</span>, &#123;&#125;, \[</span><br><span class="line">  <span class="title function_">h</span>(<span class="string">&#x27;li&#x27;</span>, &#123; <span class="attr">key</span>: <span class="string">&#x27;A&#x27;</span> &#125;, <span class="string">&#x27;A&#x27;</span>),</span><br><span class="line">  <span class="title function_">h</span>(<span class="string">&#x27;li&#x27;</span>, &#123; <span class="attr">key</span>: <span class="string">&#x27;B&#x27;</span> &#125;, <span class="string">&#x27;B&#x27;</span>),</span><br><span class="line">  <span class="title function_">h</span>(<span class="string">&#x27;li&#x27;</span>, &#123; <span class="attr">key</span>: <span class="string">&#x27;C&#x27;</span> &#125;, <span class="string">&#x27;C&#x27;</span>),</span><br><span class="line">  <span class="title function_">h</span>(<span class="string">&#x27;li&#x27;</span>, &#123; <span class="attr">key</span>: <span class="string">&#x27;D&#x27;</span> &#125;, <span class="string">&#x27;D&#x27;</span>),</span><br><span class="line">  <span class="title function_">h</span>(<span class="string">&#x27;li&#x27;</span>, &#123; <span class="attr">key</span>: <span class="string">&#x27;E&#x27;</span> &#125;, <span class="string">&#x27;E&#x27;</span>),</span><br><span class="line">\])</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> oldVnode = <span class="title function_">patch</span>(app, vnode)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> vnode2 = <span class="title function_">h</span>(<span class="string">&#x27;ul&#x27;</span>, &#123;&#125;, \[</span><br><span class="line">  <span class="title function_">h</span>(<span class="string">&#x27;li&#x27;</span>, &#123; <span class="attr">key</span>: <span class="string">&#x27;E&#x27;</span> &#125;, <span class="string">&#x27;E&#x27;</span>),</span><br><span class="line">  <span class="title function_">h</span>(<span class="string">&#x27;li&#x27;</span>, &#123; <span class="attr">key</span>: <span class="string">&#x27;D&#x27;</span> &#125;, <span class="string">&#x27;D&#x27;</span>),</span><br><span class="line">  <span class="title function_">h</span>(<span class="string">&#x27;li&#x27;</span>, &#123; <span class="attr">key</span>: <span class="string">&#x27;C&#x27;</span> &#125;, <span class="string">&#x27;C&#x27;</span>),</span><br><span class="line">  <span class="title function_">h</span>(<span class="string">&#x27;li&#x27;</span>, &#123; <span class="attr">key</span>: <span class="string">&#x27;B&#x27;</span> &#125;, <span class="string">&#x27;B&#x27;</span>),</span><br><span class="line">  <span class="title function_">h</span>(<span class="string">&#x27;li&#x27;</span>, &#123; <span class="attr">key</span>: <span class="string">&#x27;A&#x27;</span> &#125;, <span class="string">&#x27;A&#x27;</span>),</span><br><span class="line">\])</span><br><span class="line"><span class="keyword">let</span> vnode3 = <span class="title function_">h</span>(<span class="string">&#x27;ul&#x27;</span>, &#123;&#125;, \[</span><br><span class="line">  <span class="title function_">h</span>(<span class="string">&#x27;li&#x27;</span>, &#123; <span class="attr">key</span>: <span class="string">&#x27;E&#x27;</span> &#125;, <span class="string">&#x27;E&#x27;</span>),</span><br><span class="line">  <span class="title function_">h</span>(<span class="string">&#x27;li&#x27;</span>, &#123; <span class="attr">key</span>: <span class="string">&#x27;D&#x27;</span> &#125;, <span class="string">&#x27;D&#x27;</span>),</span><br><span class="line">  <span class="title function_">h</span>(<span class="string">&#x27;li&#x27;</span>, &#123; <span class="attr">key</span>: <span class="string">&#x27;C&#x27;</span> &#125;, <span class="string">&#x27;C&#x27;</span>),</span><br><span class="line">  <span class="title function_">h</span>(<span class="string">&#x27;li&#x27;</span>, &#123; <span class="attr">key</span>: <span class="string">&#x27;A&#x27;</span> &#125;, <span class="string">&#x27;A&#x27;</span>),</span><br><span class="line">  <span class="title function_">h</span>(<span class="string">&#x27;li&#x27;</span>, &#123; <span class="attr">key</span>: <span class="string">&#x27;B&#x27;</span> &#125;, <span class="string">&#x27;B&#x27;</span>),</span><br><span class="line">  <span class="title function_">h</span>(<span class="string">&#x27;li&#x27;</span>, &#123; <span class="attr">key</span>: <span class="string">&#x27;K&#x27;</span> &#125;, <span class="string">&#x27;K&#x27;</span>),</span><br><span class="line">\])</span><br><span class="line"><span class="keyword">let</span> vnode4 = <span class="title function_">h</span>(<span class="string">&#x27;ul&#x27;</span>, &#123;&#125;, \[</span><br><span class="line">  <span class="title function_">h</span>(<span class="string">&#x27;li&#x27;</span>, &#123; <span class="attr">key</span>: <span class="string">&#x27;A&#x27;</span> &#125;, <span class="string">&#x27;A&#x27;</span>),</span><br><span class="line">  <span class="title function_">h</span>(<span class="string">&#x27;li&#x27;</span>, &#123; <span class="attr">key</span>: <span class="string">&#x27;B&#x27;</span> &#125;, <span class="string">&#x27;B&#x27;</span>),</span><br><span class="line">  <span class="title function_">h</span>(<span class="string">&#x27;li&#x27;</span>, &#123; <span class="attr">key</span>: <span class="string">&#x27;C&#x27;</span> &#125;, <span class="string">&#x27;C&#x27;</span>),</span><br><span class="line">\])</span><br><span class="line"><span class="keyword">let</span> vnode5 = <span class="title function_">h</span>(<span class="string">&#x27;ul&#x27;</span>, &#123;&#125;, \[</span><br><span class="line">  <span class="title function_">h</span>(<span class="string">&#x27;li&#x27;</span>, &#123; <span class="attr">key</span>: <span class="string">&#x27;E&#x27;</span> &#125;, <span class="string">&#x27;E&#x27;</span>),</span><br><span class="line">  <span class="title function_">h</span>(<span class="string">&#x27;li&#x27;</span>, &#123; <span class="attr">key</span>: <span class="string">&#x27;C&#x27;</span> &#125;, <span class="string">&#x27;C&#x27;</span>),</span><br><span class="line">  <span class="title function_">h</span>(<span class="string">&#x27;li&#x27;</span>, &#123; <span class="attr">key</span>: <span class="string">&#x27;V&#x27;</span> &#125;, <span class="string">&#x27;V&#x27;</span>),</span><br><span class="line">\])</span><br><span class="line"><span class="keyword">let</span> vnode6 = <span class="title function_">h</span>(<span class="string">&#x27;ul&#x27;</span>, &#123;&#125;, \[</span><br><span class="line">  <span class="title function_">h</span>(<span class="string">&#x27;li&#x27;</span>, &#123; <span class="attr">key</span>: <span class="string">&#x27;A&#x27;</span> &#125;, <span class="string">&#x27;A&#x27;</span>),</span><br><span class="line">  <span class="title function_">h</span>(<span class="string">&#x27;li&#x27;</span>, &#123; <span class="attr">key</span>: <span class="string">&#x27;B&#x27;</span> &#125;, <span class="string">&#x27;B&#x27;</span>),</span><br><span class="line">  <span class="title function_">h</span>(<span class="string">&#x27;li&#x27;</span>, &#123; <span class="attr">key</span>: <span class="string">&#x27;C&#x27;</span> &#125;, <span class="string">&#x27;C&#x27;</span>),</span><br><span class="line">  <span class="title function_">h</span>(<span class="string">&#x27;li&#x27;</span>, &#123; <span class="attr">key</span>: <span class="string">&#x27;D&#x27;</span> &#125;, <span class="string">&#x27;D&#x27;</span>),</span><br><span class="line">  <span class="title function_">h</span>(</span><br><span class="line">    <span class="string">&#x27;li&#x27;</span>,</span><br><span class="line">    &#123; <span class="attr">key</span>: <span class="string">&#x27;E&#x27;</span> &#125;,</span><br><span class="line">    <span class="title function_">h</span>(<span class="string">&#x27;ul&#x27;</span>, &#123;&#125;, \[</span><br><span class="line">      <span class="title function_">h</span>(<span class="string">&#x27;li&#x27;</span>, &#123; <span class="attr">key</span>: <span class="string">&#x27;A&#x27;</span> &#125;, <span class="string">&#x27;A&#x27;</span>),</span><br><span class="line">      <span class="title function_">h</span>(<span class="string">&#x27;li&#x27;</span>, &#123; <span class="attr">key</span>: <span class="string">&#x27;B&#x27;</span> &#125;, <span class="string">&#x27;B&#x27;</span>),</span><br><span class="line">      <span class="title function_">h</span>(<span class="string">&#x27;li&#x27;</span>, &#123; <span class="attr">key</span>: <span class="string">&#x27;C&#x27;</span> &#125;, <span class="string">&#x27;C&#x27;</span>),</span><br><span class="line">      <span class="title function_">h</span>(<span class="string">&#x27;li&#x27;</span>, &#123; <span class="attr">key</span>: <span class="string">&#x27;D&#x27;</span> &#125;, <span class="string">&#x27;D&#x27;</span>),</span><br><span class="line">      <span class="title function_">h</span>(<span class="string">&#x27;li&#x27;</span>, &#123; <span class="attr">key</span>: <span class="string">&#x27;E&#x27;</span> &#125;, <span class="title function_">h</span>(<span class="string">&#x27;div&#x27;</span>, &#123; <span class="attr">key</span>: <span class="string">&#x27;R&#x27;</span> &#125;, <span class="string">&#x27;R&#x27;</span>)),</span><br><span class="line">    \])</span><br><span class="line">  ),</span><br><span class="line">\])</span><br><span class="line"><span class="keyword">let</span> vnodeList = \[vnode2, vnode3, vnode4, vnode5, vnode6\]</span><br><span class="line"><span class="keyword">let</span> btn = <span class="variable language_">document</span>.<span class="title function_">querySelectorAll</span>(<span class="string">&#x27;.btn&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; btn.<span class="property">length</span>; i++) &#123;</span><br><span class="line">  btn\[i\].<span class="property">onclick</span> = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">patch</span>(vnode, vnodeList\[i\])</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-演示"><a href="#2-演示" class="headerlink" title="2.演示"></a>2.演示</h3><blockquote>
<p>策略3</p>
</blockquote>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0f95d637265f4ea894fb0ee36e9c9bdb~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp" alt="22"></p>
<blockquote>
<p>复杂</p>
</blockquote>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5582ea0aa45e4b05b751e3c54a2b59c9~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp" alt="23"></p>
<blockquote>
<p>删除</p>
</blockquote>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/246cbf9a6c6749a494e27f0ef5fecbb1~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp" alt="24"></p>
<blockquote>
<p>复杂</p>
</blockquote>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0b351a63e539467598b4e3ff1990bef9~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp" alt="25"></p>
<blockquote>
<p>复杂（这里是简单 。。）</p>
</blockquote>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ff817315ac8c4cacac1dab0330a96e6e~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp" alt="26"></p>
<h2 id="7-结语"><a href="#7-结语" class="headerlink" title="7.结语"></a>7.结语</h2><p>注释我都写了喔，大家可以对照 我上面画的图不清楚可以反复耐心的看哈</p>
<p>如果看的话没什么感觉，大家可以自己动手写写，下面我会贴出所有的代码</p>
<p>代码同样也放在 <a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2FLianTianNo1%2FVirtual_DOM_demo%2Ftree%2Fmain%2Fsrc%2Fmy-snabbdom" title="https://github.com/LianTianNo1/Virtual_DOM_demo/tree/main/src/my-snabbdom"><strong>github</strong></a></p>
<p>完整代码：</p>
<blockquote>
<p>h.js</p>
</blockquote>
 <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> vnode <span class="keyword">from</span> <span class="string">&#x27;./vnode&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> \*</span><br><span class="line"> \* @param &#123;string&#125; a sel</span><br><span class="line"> \* @param &#123;object&#125; b data</span><br><span class="line"> \* @param &#123;any&#125; c 是子节点 可以是文本，数组</span><br><span class="line"> */</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">h</span>(<span class="params">a, b, c</span>) &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">arguments</span>.<span class="property">length</span> &lt; <span class="number">3</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;请检查参数个数&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> c === <span class="string">&#x27;string&#x27;</span> || <span class="keyword">typeof</span> c === <span class="string">&#x27;number&#x27;</span>) &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">vnode</span>(a, b, <span class="literal">undefined</span>, c, <span class="literal">undefined</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(c)) &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> children = \[\]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; c.<span class="property">length</span>; i++) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!(<span class="keyword">typeof</span> c\[i\] === <span class="string">&#x27;object&#x27;</span> &amp;&amp; c\[i\].<span class="property">sel</span>))</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;第三个参数为数组时只能传递 h() 函数&#x27;</span>)</span><br><span class="line"></span><br><span class="line">      children.<span class="title function_">push</span>(c\[i\])</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">vnode</span>(a, b, children, <span class="literal">undefined</span>, <span class="literal">undefined</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> c === <span class="string">&#x27;object&#x27;</span> &amp;&amp; c.<span class="property">sel</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> children = \[c\]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">vnode</span>(a, b, children, <span class="literal">undefined</span>, <span class="literal">undefined</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>patch.js</p>
</blockquote>
 <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> vnode <span class="keyword">from</span> <span class="string">&#x27;./vnode&#x27;</span></span><br><span class="line"><span class="keyword">import</span> createElm <span class="keyword">from</span> <span class="string">&#x27;./createElm&#x27;</span></span><br><span class="line"><span class="keyword">import</span> patchVnode <span class="keyword">from</span> <span class="string">&#x27;./patchVnode&#x27;</span></span><br><span class="line"><span class="keyword">import</span> sameVnode <span class="keyword">from</span> <span class="string">&#x27;./sameVnode&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> \*</span><br><span class="line"> \* @param &#123;vnode/<span class="variable constant_">DOM</span>&#125; oldVnode</span><br><span class="line"> \* @param &#123;vnode&#125; newVnode</span><br><span class="line"> */</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">patch</span>(<span class="params">oldVnode, newVnode</span>) &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!oldVnode.<span class="property">sel</span>) &#123;</span><br><span class="line"></span><br><span class="line">    oldVnode = <span class="title function_">emptyNodeAt</span>(oldVnode)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">sameVnode</span>(oldVnode, newVnode)) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">patchVnode</span>(oldVnode, newVnode)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> newNode = <span class="title function_">createElm</span>(newVnode)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (oldVnode.<span class="property">elm</span>.<span class="property">parentNode</span>) &#123;</span><br><span class="line">      <span class="keyword">let</span> parentNode = oldVnode.<span class="property">elm</span>.<span class="property">parentNode</span></span><br><span class="line"></span><br><span class="line">      parentNode.<span class="title function_">insertBefore</span>(newNode, oldVnode.<span class="property">elm</span>)</span><br><span class="line"></span><br><span class="line">      parentNode.<span class="title function_">removeChild</span>(oldVnode.<span class="property">elm</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  newVnode.<span class="property">elm</span> = oldVnode.<span class="property">elm</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> newVnode</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> \* 转为 虚拟 <span class="variable constant_">DOM</span></span><br><span class="line"> \* @param &#123;<span class="variable constant_">DOM</span>&#125; elm <span class="variable constant_">DOM</span>节点</span><br><span class="line"> \* @returns &#123;object&#125;</span><br><span class="line"> */</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">emptyNodeAt</span>(<span class="params">elm</span>) &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">vnode</span>(elm.<span class="property">tagName</span>.<span class="title function_">toLowerCase</span>(), <span class="literal">undefined</span>, <span class="literal">undefined</span>, <span class="literal">undefined</span>, elm)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>createElm.js</p>
</blockquote>
 <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">\* 创建元素</span><br><span class="line"> \* @param &#123;vnode&#125; vnode 要创建的节点</span><br><span class="line"> */</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">createElm</span>(<span class="params">vnode</span>) &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> node = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(vnode.<span class="property">sel</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    vnode.<span class="property">text</span> !== <span class="string">&#x27;&#x27;</span> &amp;&amp;</span><br><span class="line">    (vnode.<span class="property">children</span> === <span class="literal">undefined</span> || vnode.<span class="property">children</span>.<span class="property">length</span> === <span class="number">0</span>)</span><br><span class="line">  ) &#123;</span><br><span class="line"></span><br><span class="line">    node.<span class="property">textContent</span> = vnode.<span class="property">text</span></span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(vnode.<span class="property">children</span>) &amp;&amp; vnode.<span class="property">children</span>.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> children = vnode.<span class="property">children</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; children.<span class="property">length</span>; i++) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">let</span> ch = children\[i\]</span><br><span class="line"></span><br><span class="line">      <span class="keyword">let</span> chDom = <span class="title function_">createElm</span>(ch)</span><br><span class="line"></span><br><span class="line">      node.<span class="title function_">appendChild</span>(chDom)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  vnode.<span class="property">elm</span> = node</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> node</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>vnode.js</p>
</blockquote>
 <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">\* 把传入的 参数 作为 对象返回</span><br><span class="line"> \* @param &#123;string&#125; sel 选择器</span><br><span class="line"> \* @param &#123;object&#125; data 数据</span><br><span class="line"> \* @param &#123;array&#125; children 子节点</span><br><span class="line"> \* @param &#123;string&#125; text 文本</span><br><span class="line"> \* @param &#123;dom&#125; elm <span class="variable constant_">DOM</span></span><br><span class="line"> \* @returns</span><br><span class="line"> */</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> (<span class="params">sel, data, children, text, elm</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123; sel, data, children, text, elm &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>patchVnode.js</p>
</blockquote>
 <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> createElm <span class="keyword">from</span> <span class="string">&#x27;./createElm&#x27;</span></span><br><span class="line"><span class="keyword">import</span> updateChildren <span class="keyword">from</span> <span class="string">&#x27;./updateChildren&#x27;</span></span><br><span class="line"></span><br><span class="line"> \*</span><br><span class="line"> \* @param &#123;vnode&#125; oldVnode 老的虚拟节点</span><br><span class="line"> \* @param &#123;vnode&#125; newVnode 新的虚拟节点</span><br><span class="line"> \* @returns</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">patchVnode</span>(<span class="params">oldVnode, newVnode</span>) &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (oldVnode === newVnode) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (newVnode.<span class="property">text</span> &amp;&amp; !newVnode.<span class="property">children</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (oldVnode.<span class="property">text</span> !== newVnode.<span class="property">text</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;文字不相同&#x27;</span>)</span><br><span class="line"></span><br><span class="line">      oldVnode.<span class="property">elm</span>.<span class="property">textContent</span> = newVnode.<span class="property">text</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (oldVnode.<span class="property">children</span>) &#123;</span><br><span class="line">      <span class="title function_">updateChildren</span>(oldVnode.<span class="property">elm</span>, oldVnode.<span class="property">children</span>, newVnode.<span class="property">children</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;old没有children，new有children&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      oldVnode.<span class="property">elm</span>.<span class="property">innerHTML</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">let</span> newChildren = newVnode.<span class="property">children</span></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; newChildren.<span class="property">length</span>; i++) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> node = <span class="title function_">createElm</span>(newChildren\[i\])</span><br><span class="line"></span><br><span class="line">        oldVnode.<span class="property">elm</span>.<span class="title function_">appendChild</span>(node)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>sameVnode.js</p>
</blockquote>
 <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">\* 判断两个虚拟节点是否是同一节点</span><br><span class="line"> \* @param &#123;vnode&#125; vnode1 虚拟节点<span class="number">1</span></span><br><span class="line"> \* @param &#123;vnode&#125; vnode2 虚拟节点<span class="number">2</span></span><br><span class="line"> \* @returns boolean</span><br><span class="line"> */</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">sameVnode</span>(<span class="params">vnode1, vnode2</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    (vnode1.<span class="property">data</span> ? vnode1.<span class="property">data</span>.<span class="property">key</span> : <span class="literal">undefined</span>) ===</span><br><span class="line">      (vnode2.<span class="property">data</span> ? vnode2.<span class="property">data</span>.<span class="property">key</span> : <span class="literal">undefined</span>) &amp;&amp; vnode1.<span class="property">sel</span> === vnode2.<span class="property">sel</span></span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>updateChildren.js</p>
</blockquote>
 <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> createElm <span class="keyword">from</span> <span class="string">&#x27;./createElm&#x27;</span></span><br><span class="line"><span class="keyword">import</span> patchVnode <span class="keyword">from</span> <span class="string">&#x27;./patchVnode&#x27;</span></span><br><span class="line"><span class="keyword">import</span> sameVnode <span class="keyword">from</span> <span class="string">&#x27;./sameVnode&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> \*</span><br><span class="line"> \* @param &#123;dom&#125; parentElm 父节点</span><br><span class="line"> \* @param &#123;array&#125; oldCh 旧子节点</span><br><span class="line"> \* @param &#123;array&#125; newCh 新子节点</span><br><span class="line"> */</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">updateChildren</span>(<span class="params">parentElm, oldCh, newCh</span>) &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> oldStartIdx = <span class="number">0</span>,</span><br><span class="line">    newStartIdx = <span class="number">0</span></span><br><span class="line">  <span class="keyword">let</span> oldEndIdx = oldCh.<span class="property">length</span> - <span class="number">1</span></span><br><span class="line">  <span class="keyword">let</span> newEndIdx = newCh.<span class="property">length</span> - <span class="number">1</span></span><br><span class="line">  <span class="keyword">let</span> oldStartVnode = oldCh\[<span class="number">0</span>\]</span><br><span class="line">  <span class="keyword">let</span> oldEndVnode = oldCh\[oldEndIdx\]</span><br><span class="line">  <span class="keyword">let</span> newStartVnode = newCh\[<span class="number">0</span>\]</span><br><span class="line">  <span class="keyword">let</span> newEndVnode = newCh\[newEndIdx\]</span><br><span class="line">  <span class="keyword">let</span> keyMap = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (newStartIdx &lt;= newEndIdx &amp;&amp; oldStartIdx &lt;= oldEndIdx) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;---进入diff---&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (oldCh\[oldStartIdx\] == <span class="literal">undefined</span>) &#123;</span><br><span class="line">      oldStartVnode = oldCh\[++oldStartIdx\]</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (oldCh\[oldEndIdx\] == <span class="literal">undefined</span>) &#123;</span><br><span class="line">      oldEndVnode = oldCh\[--oldEndIdx\]</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (newCh\[newStartIdx\] == <span class="literal">undefined</span>) &#123;</span><br><span class="line">      newStartVnode = newCh\[++newStartIdx\]</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (newCh\[newEndIdx\] == <span class="literal">undefined</span>) &#123;</span><br><span class="line">      newEndVnode = newCh\[--newEndIdx\]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">sameVnode</span>(oldStartVnode, newStartVnode)) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;1命中&#x27;</span>)</span><br><span class="line"></span><br><span class="line">      <span class="title function_">patchVnode</span>(oldStartVnode, newStartVnode)</span><br><span class="line"></span><br><span class="line">      newStartVnode = newCh\[++newStartIdx\]</span><br><span class="line">      oldStartVnode = oldCh\[++oldStartIdx\]</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">sameVnode</span>(oldEndVnode, newEndVnode)) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;2命中&#x27;</span>)</span><br><span class="line"></span><br><span class="line">      <span class="title function_">patchVnode</span>(oldEndVnode, newEndVnode)</span><br><span class="line"></span><br><span class="line">      newEndVnode = newCh\[--newEndIdx\]</span><br><span class="line">      oldEndVnode = oldCh\[--oldEndIdx\]</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">sameVnode</span>(oldStartVnode, newEndVnode)) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;3命中&#x27;</span>)</span><br><span class="line"></span><br><span class="line">      <span class="title function_">patchVnode</span>(oldStartVnode, newEndVnode)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      parentElm.<span class="title function_">insertBefore</span>(oldStartVnode.<span class="property">elm</span>, oldEndVnode.<span class="property">elm</span>.<span class="property">nextSibling</span>)</span><br><span class="line"></span><br><span class="line">      newEndVnode = newCh\[--newEndIdx\]</span><br><span class="line">      oldStartVnode = oldCh\[++oldStartIdx\]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">sameVnode</span>(oldEndVnode, newStartVnode)) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;4命中&#x27;</span>)</span><br><span class="line"></span><br><span class="line">      <span class="title function_">patchVnode</span>(oldEndVnode, newStartVnode)</span><br><span class="line"></span><br><span class="line">      parentElm.<span class="title function_">insertBefore</span>(oldEndVnode.<span class="property">elm</span>, oldStartVnode.<span class="property">elm</span>)</span><br><span class="line"></span><br><span class="line">      newStartVnode = newCh\[++newStartIdx\]</span><br><span class="line">      oldEndVnode = oldCh\[--oldEndIdx\]</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;diff四种优化策略都没命中&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!keyMap) &#123;</span><br><span class="line"></span><br><span class="line">        keyMap = &#123;&#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = oldStartIdx; i &lt; oldEndIdx; i++) &#123;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">const</span> key = oldCh\[i\].<span class="property">data</span>.<span class="property">key</span></span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (!key) keyMap\[key\] = i</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      <span class="keyword">let</span> idInOld = keyMap\[newStartIdx.<span class="property">data</span>\]</span><br><span class="line">        ? keyMap\[newStartIdx.<span class="property">data</span>.<span class="property">key</span>\]</span><br><span class="line">        : <span class="literal">undefined</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (idInOld) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;移动节点&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> moveElm = oldCh\[idInOld\]</span><br><span class="line"></span><br><span class="line">        <span class="title function_">patchVnode</span>(moveElm, newStartVnode)</span><br><span class="line"></span><br><span class="line">        oldCh\[idInOld\] = <span class="literal">undefined</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        parentElm.<span class="title function_">insertBefore</span>(moveElm.<span class="property">elm</span>, oldStartVnode.<span class="property">elm</span>)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;添加新节点&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        parentElm.<span class="title function_">insertBefore</span>(<span class="title function_">createElm</span>(newStartVnode), oldStartVnode.<span class="property">elm</span>)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      newStartVnode = newCh\[++newStartIdx\]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (newStartIdx &lt;= newEndIdx) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;进入添加剩余节点&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> beforeFlag = newCh\[newEndIdx + <span class="number">1</span>\] ? newCh\[newEndIdx + <span class="number">1</span>\] : <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = newStartIdx; i &lt;= newEndIdx; i++) &#123;</span><br><span class="line"></span><br><span class="line">      parentElm.<span class="title function_">insertBefore</span>(<span class="title function_">createElm</span>(newCh\[i\]), beforeFlag)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (oldStartIdx &lt;= oldEndIdx) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;进入删除多余节点&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = oldStartIdx; i &lt;= oldEndIdx; i++) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (oldCh\[i\].<span class="property">elm</span>) parentElm.<span class="title function_">removeChild</span>(oldCh\[i\].<span class="property">elm</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://liantianno1.github.io/xiaolangwiki/2024/07/23/26/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/xiaolangwiki/images/avatar.png">
      <meta itemprop="name" content="小浪wiki">
      <meta itemprop="description" content="一个关于编程、计算机、软件工程、互联网的知识库。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小浪wiki">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/xiaolangwiki/2024/07/23/26/" class="post-title-link" itemprop="url">打印排版小技巧：pt、px、mm 之间的神秘转换 🪄</a>
        </h2>

        <div class="post-meta">
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-07-23 11:11:26" itemprop="dateCreated datePublished" datetime="2024-07-23T11:11:26+08:00">2024-07-23</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/xiaolangwiki/categories/%E5%89%8D%E7%AB%AF/" itemprop="url" rel="index"><span itemprop="name">前端</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="打印排版小技巧：pt、px、mm-之间的神秘转换-🪄"><a href="#打印排版小技巧：pt、px、mm-之间的神秘转换-🪄" class="headerlink" title="打印排版小技巧：pt、px、mm 之间的神秘转换 🪄"></a>打印排版小技巧：pt、px、mm 之间的神秘转换 🪄</h2><p>原文：<a target="_blank" rel="noopener" href="https://juejin.cn/post/7394652965908693043">https://juejin.cn/post/7394652965908693043</a></p>
<p>大家好，我是小浪，前几天在修改一个打印功能的 bug 的时候，突然发现了一个有趣的问题：打印出来的文字宽度和预期不符，导致排版错乱，需要重新换行。</p>
<p>仔细查看代码，发现之前同事们是根据每个字符的类型手动设置了一个大概的宽度，这显然不够精确，尤其是在涉及到不同字体、不同字号的时候，这种方法很容易出现问题。</p>
<p>为了解决这个问题，我决定深入研究一下打印排版中常用的单位：<strong>pt、px 和 mm</strong>，以及它们之间的转换关系。</p>
<h3 id="pt、px、mm-是什么？-🤔"><a href="#pt、px、mm-是什么？-🤔" class="headerlink" title="pt、px、mm 是什么？ 🤔"></a>pt、px、mm 是什么？ 🤔</h3><ul>
<li><strong>pt (point)</strong>：点，是印刷术语中常用的单位，1pt 等于 1/72 英寸。在网页设计中，pt 主要用于设置字体大小。</li>
<li><strong>px (pixel)</strong>：像素，是屏幕上最小的显示单元。在网页设计中，px 是最常用的长度单位，用于设置元素的宽度、高度、边距等。</li>
<li><strong>mm (millimeter)</strong>：毫米，是国际通用的长度单位。在打印设计中，mm 是常用的单位，用于设置纸张大小、边距等。</li>
</ul>
<h3 id="如何转换它们？-🔄"><a href="#如何转换它们？-🔄" class="headerlink" title="如何转换它们？ 🔄"></a>如何转换它们？ 🔄</h3><p>在过去，我们需要知道设备的 <strong>dpi (dots per inch)</strong>，也就是每英寸的像素密度，才能准确地将 pt、px 和 mm 之间进行转换。</p>
<p>例如，如果设备的 dpi 是 300，那么 1pt 就等于 300 / 72 = 4.17 px。</p>
<p>但是，这种方法比较麻烦，而且需要根据不同的设备进行调整。</p>
<p>好在，我们可以利用浏览器提供的 API 来直接获取 pt、px 和 mm 之间的转换关系，省去了很多麻烦。</p>
<h3 id="利用浏览器-API-实现转换-💻"><a href="#利用浏览器-API-实现转换-💻" class="headerlink" title="利用浏览器 API 实现转换 💻"></a>利用浏览器 API 实现转换 💻</h3><p>我们可以利用 JavaScript 和 DOM API 来实现 pt、px 和 mm 之间的转换。</p>
<p><strong>1. 获取每毫米的像素值</strong></p>
<p>首先，我们需要获取当前设备每毫米的像素值。我们可以创建一个 1mm 宽的 div 元素，插入到页面中，然后获取它的宽度，就可以得到每毫米的像素值。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> cachedMmPx = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">getOneMmsPx</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (cachedMmPx !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> cachedMmPx;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> div = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&quot;div&quot;</span>);</span><br><span class="line">  div.<span class="property">style</span>.<span class="property">width</span> = <span class="string">&quot;1mm&quot;</span>;</span><br><span class="line">  <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(div);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> &#123; width &#125; = div.<span class="title function_">getBoundingClientRect</span>();</span><br><span class="line">  <span class="keyword">const</span> mm1 = <span class="title class_">Math</span>.<span class="title function_">floor</span>(width * <span class="number">100</span>) / <span class="number">100</span>;</span><br><span class="line">  div.<span class="title function_">remove</span>();</span><br><span class="line"></span><br><span class="line">  cachedMmPx = mm1;</span><br><span class="line">  <span class="keyword">return</span> mm1;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><strong>2. 将 px 转换为 mm</strong></p>
<p>有了每毫米的像素值，我们就可以将 px 转换为 mm 了。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">pxToMm</span> = (<span class="params">px</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> mmPerPx = <span class="number">1</span> / <span class="title function_">getOneMmsPx</span>();</span><br><span class="line">  <span class="keyword">return</span> px * mmPerPx;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><strong>3. 获取每 pt 的像素值</strong></p>
<p>类似地，我们可以创建一个 1pt 宽的 div 元素，获取它的宽度，就可以得到每 pt 的像素值。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> cachedPtPx = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">getOnePtPx</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (cachedPtPx !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> cachedPtPx;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> div = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&quot;div&quot;</span>);</span><br><span class="line">  div.<span class="property">style</span>.<span class="property">width</span> = <span class="string">&quot;1pt&quot;</span>;</span><br><span class="line">  <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(div);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> &#123; width &#125; = div.<span class="title function_">getBoundingClientRect</span>();</span><br><span class="line">  <span class="keyword">const</span> pt1 = <span class="title class_">Math</span>.<span class="title function_">floor</span>(width * <span class="number">100</span>) / <span class="number">100</span>;</span><br><span class="line">  div.<span class="title function_">remove</span>();</span><br><span class="line"></span><br><span class="line">  cachedPtPx = pt1;</span><br><span class="line">  <span class="keyword">return</span> pt1;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><strong>4. 将 pt 转换为 px</strong></p>
<p>有了每 pt 的像素值，我们就可以将 pt 转换为 px 了。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">ptToPx</span> = (<span class="params">pt</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> pxPerPt = <span class="title function_">getOnePtPx</span>();</span><br><span class="line">  <span class="keyword">return</span> pt * pxPerPt;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><strong>5. 我实际用到的代码获取指定字符的 mm 宽度</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">getCharWidthInMm</span> = (<span class="params">char, ptSize = <span class="number">10.5</span>, fontFamily = <span class="string">&quot;宋体&quot;</span></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> canvas = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&quot;canvas&quot;</span>);</span><br><span class="line">  <span class="keyword">const</span> ctx = canvas.<span class="title function_">getContext</span>(<span class="string">&quot;2d&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (!ctx) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ctx.<span class="property">font</span> = <span class="string">`<span class="subst">$&#123;ptToPx(ptSize)&#125;</span>px <span class="subst">$&#123;fontFamily&#125;</span>`</span>;</span><br><span class="line">  <span class="keyword">const</span> &#123; width &#125; = ctx.<span class="title function_">measureText</span>(char);</span><br><span class="line">  <span class="keyword">const</span> mmWidth = <span class="title function_">pxToMm</span>(width);</span><br><span class="line"></span><br><span class="line">  canvas.<span class="title function_">remove</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Math</span>.<span class="title function_">floor</span>(mmWidth * <span class="number">10000</span>) / <span class="number">10000</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="解决打印排版问题-🚀"><a href="#解决打印排版问题-🚀" class="headerlink" title="解决打印排版问题 🚀"></a>解决打印排版问题 🚀</h3><p>有了这些代码，我就可以轻松地将模板上的 pt 值转换为 mm，从而判断字符是否超出预设的范围，解决打印排版错乱的问题。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>在解决打印排版问题的时候，我在网上查询了 pt、px 和 mm 之间的转换关系，涉及到比值计算、DPI 等，认为无法对每个设备都适配，于是利用浏览器 API 实现了一套转换工具。</p>
<p>工作中经常会遇到一些看似复杂的问题，但通过深入研究和探索，往往可以找到简单有效的解决方案。希望我的经验能够帮助到大家，也希望大家在工作中遇到有趣的问题时，可以像我一样记录下来，并与大家分享！</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://liantianno1.github.io/xiaolangwiki/2024/07/23/50/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/xiaolangwiki/images/avatar.png">
      <meta itemprop="name" content="小浪wiki">
      <meta itemprop="description" content="一个关于编程、计算机、软件工程、互联网的知识库。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小浪wiki">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/xiaolangwiki/2024/07/23/50/" class="post-title-link" itemprop="url">GitHub搜索技巧：快速找到你想要的代码</a>
        </h2>

        <div class="post-meta">
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-07-23 06:09:50" itemprop="dateCreated datePublished" datetime="2024-07-23T06:09:50+08:00">2024-07-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-01-10 16:50:00" itemprop="dateModified" datetime="2022-01-10T16:50:00+08:00">2022-01-10</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/xiaolangwiki/categories/GitHub/" itemprop="url" rel="index"><span itemprop="name">GitHub</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="GitHub搜索技巧🚀：快速找到你想要的代码"><a href="#GitHub搜索技巧🚀：快速找到你想要的代码" class="headerlink" title="GitHub搜索技巧🚀：快速找到你想要的代码"></a>GitHub搜索技巧🚀：快速找到你想要的代码</h2><p>原文：<a target="_blank" rel="noopener" href="https://juejin.cn/post/7386299931399110706">https://juejin.cn/post/7386299931399110706</a></p>
<p>嘿，开发者朋友们！ 👋</p>
<p>你是否曾迷失在GitHub的浩瀚代码海洋中，苦苦寻找那份珍贵的代码片段或项目？ 😩 别担心，今天我将传授你GitHub搜索的Jedi秘诀，让你像一位搜索大师一样，轻松找到你想要的任何东西！ ✨</p>
<p><strong>基础功：关键词和过滤器</strong></p>
<p>首先，掌握基础语法就像学习魔法咒语一样重要。 🪄</p>
<ul>
<li><strong>关键词:</strong> 直接输入你想找的内容，例如 “python”、”machine learning”。</li>
<li><strong>文件类型:</strong> 想找Python文件？加个 <code>extension:py</code> 就行啦！</li>
<li><strong>路径:</strong> 只想知道”docs”文件夹里的文件？用 <code>path:docs</code> 就能精准定位！</li>
<li><strong>用户/组织:</strong> 想看看某个大牛的项目？用 <code>user:username</code> 或 <code>org:organization</code> 就能找到！</li>
</ul>
<p><strong>进阶技巧：运算符和特殊字符</strong></p>
<p>想要更精准地搜索？ 🎯 那就来点高级技巧吧！</p>
<ul>
<li><strong>AND:</strong> 用 <code>+</code> 或空格连接关键词，例如 <code>&quot;machine learning&quot; +python</code>，表示必须同时包含这两个关键词。</li>
<li><strong>OR:</strong> 用 <code>|</code> 连接关键词，例如 <code>&quot;machine learning&quot; |&quot;deep learning&quot;</code>，表示只要包含其中一个关键词即可。</li>
<li><strong>NOT:</strong> 用 <code>-</code> 排除关键词，例如 <code>&quot;machine learning&quot; -python</code>，表示不包含 “python” 的结果。</li>
<li><strong>括号:</strong> 用括号分组关键词，例如 <code>(machine learning) +python</code>，可以更精确地控制搜索范围。</li>
<li><strong>通配符:</strong> 用 <code>*</code> 匹配任意字符，例如 <code>machine*</code> 可以匹配 “machine learning”、”machine vision” 等。</li>
<li><strong>正则表达式:</strong> 如果你是一位正则表达式高手，可以使用 <code>/regex/</code> 来进行更复杂的匹配。</li>
</ul>
<p><strong>终极秘籍：高级选项</strong></p>
<p>想要像搜索大师一样，掌握更多秘密武器？ ⚔️</p>
<ul>
<li><strong>stars:</strong><code>stars:&gt;number</code> 可以找到星标数量大于指定数字的仓库，例如 <code>stars:&gt;1000</code>。</li>
<li><strong>forks:</strong><code>forks:&gt;number</code> 可以找到 Forks 数量大于指定数字的仓库，例如 <code>forks:&gt;100</code>。</li>
<li><strong>language:</strong><code>language:language</code> 可以找到指定语言编写的代码，例如 <code>language:python</code>。</li>
<li><strong>created/pushed/size:</strong> 还可以根据创建日期、最后更新日期和仓库大小进行筛选。</li>
</ul>
<p><strong>案例分析：</strong></p>
<p>假设你想寻找一个使用 Python 编写的，关于机器学习的开源项目，并且希望它拥有超过 1000 个星标，你可以使用以下搜索语句：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">language:python machine learning stars:&gt;1000</span></span><br></pre></td></tr></table></figure>
<p>是不是很简单？ 🤩</p>
<p><strong>小贴士：</strong></p>
<ul>
<li>GitHub 搜索帮助文档是你的好朋友，里面有更多高级选项和语法： <a href="https://link.juejin.cn/?target=https%3A%2F%2Fdocs.github.com%2Fen%2Fsearch-github" title="https://docs.github.com/en/search-github">docs.github.com/en/search-g…</a></li>
<li>善用代码搜索功能，可以更精准地查找代码片段。</li>
<li>Issue 和 Pull Request 搜索功能也能帮助你找到问题的讨论和代码修改请求。</li>
<li>不要害怕尝试不同的搜索语句，不断练习才能成为搜索大师！</li>
</ul>
<p>GitHub搜索Jedi秘诀，速来学习！ 🚀 这份笔记记录了我的一些心得体会，希望能对大家有所帮助。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://liantianno1.github.io/xiaolangwiki/2023/02/27/54/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/xiaolangwiki/images/avatar.png">
      <meta itemprop="name" content="小浪wiki">
      <meta itemprop="description" content="一个关于编程、计算机、软件工程、互联网的知识库。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小浪wiki">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/xiaolangwiki/2023/02/27/54/" class="post-title-link" itemprop="url">从零开始 一步步学习微前端</a>
        </h2>

        <div class="post-meta">
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-02-27 10:07:54" itemprop="dateCreated datePublished" datetime="2023-02-27T10:07:54+08:00">2023-02-27</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/xiaolangwiki/categories/%E5%89%8D%E7%AB%AF/" itemprop="url" rel="index"><span itemprop="name">前端</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="从零开始，一步步学习微前端"><a href="#从零开始，一步步学习微前端" class="headerlink" title="从零开始，一步步学习微前端"></a>从零开始，一步步学习微前端</h2><p>原文：<a target="_blank" rel="noopener" href="https://juejin.cn/post/7204723936914554937">https://juejin.cn/post/7204723936914554937</a></p>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><blockquote>
<p>在实习的这段时间接触了很多新东西，比如微前端就是其中之一，在这里小浪就来聊聊微前端中的 qiankun 框架</p>
</blockquote>
<h2 id="1-介绍"><a href="#1-介绍" class="headerlink" title="1.介绍"></a>1.介绍</h2><h3 id="1-1-为什么需要微前端"><a href="#1-1-为什么需要微前端" class="headerlink" title="1.1 为什么需要微前端"></a>1.1 为什么需要微前端</h3><blockquote>
<p>当我们开发大型的前端应用时，通常需要将应用拆分成多个子应用进行开发和维护。这时候微前端就显得尤为重要。微前端是一种架构模式，它将前端应用程序拆分成多个更小的、相对独立的部分，每个部分都可以独立开发、测试、部署和扩展。在微前端架构中，每个子应用都是一个独立的应用程序，可以独立部署和运行。这样，我们就可以将前端应用程序的开发、测试、部署和维护工作分解成多个更小的任务，提高应用程序的可维护性和可扩展性。微前端的实现方式有多种，其中比较常见的方式是通过 iframe、Web Components 或者 JavaScript 模块加载器来实现子应用的隔离和独立运行。通过这些方式，不同的子应用之间可以互相独立、互相通信，从而实现一个完整的前端应用程序。</p>
</blockquote>
<h3 id="1-2-如何判断自己的项目需要使用微前端"><a href="#1-2-如何判断自己的项目需要使用微前端" class="headerlink" title="1.2 如何判断自己的项目需要使用微前端"></a>1.2 如何判断自己的项目需要使用微前端</h3><ol>
<li>项目功能逐渐增多，代码规模庞大，导致代码维护和开发效率低下；</li>
<li>项目需要集成多个不同技术栈的模块或服务；</li>
<li>团队成员分散，各自负责开发不同的模块或服务，需要实现独立开发和部署；</li>
<li>项目需要支持独立的生命周期管理和版本控制；</li>
<li>需要实现高可用性和弹性伸缩；</li>
<li>需要实现动态加载和卸载子应用等场景。</li>
</ol>
<blockquote>
<p>所以呢，小浪觉得如果项目具有上面这些特点，那么可以考虑使用微前端来优化项目架构和提升开发效率。</p>
</blockquote>
<h3 id="1-3-主应用和子应用"><a href="#1-3-主应用和子应用" class="headerlink" title="1.3 主应用和子应用"></a>1.3 主应用和子应用</h3><blockquote>
<p><code>qiankun</code> 官网地址是：<a href="https://link.juejin.cn/?target=https%3A%2F%2Fqiankun.umijs.org%2F%25E3%2580%2582" title="https://qiankun.umijs.org/%E3%80%82">qiankun.umijs.org/</a></p>
<p>官网的例子和教程都很详细，更新速度也快，大家想具体使用的可以去官网查阅</p>
</blockquote>
<p><code>qiankun</code> 是一个基于 Single-SPA 的微前端解决方案，它提供了一种轻量级的前端架构，可以将多个子应用整合成一个整体应用。<code>qiankun</code> 的架构包含两个主要的角色：</p>
<ul>
<li>主应用（Master Application）：负责整个应用的框架搭建、路由分发和子应用的注册和协调管理。</li>
<li>子应用（Micro Application）：独立开发的前端应用程序，可以独立运行，也可以作为主应用的一个子模块运行。</li>
</ul>
<h3 id="1-4-qiankun-的特点"><a href="#1-4-qiankun-的特点" class="headerlink" title="1.4 qiankun 的特点"></a>1.4 qiankun 的特点</h3><p><code>qiankun</code> 的主要特点包括：</p>
<ul>
<li>完备的生命周期管理：<code>qiankun</code> 提供了完备的子应用生命周期管理方案，可以自动加载、启动、挂载、卸载和卸载子应用。</li>
<li>灵活的应用路由分发：<code>qiankun</code> 提供了灵活的路由分发方案，可以自定义路由匹配规则，可以通过主应用的路由来匹配子应用的路由。</li>
<li>独立的应用状态管理：<code>qiankun</code> 提供了独立的状态管理方案，每个子应用都可以独立管理自己的状态，主应用可以通过 props 方式传递数据给子应用，也可以通过事件总线的方式进行通信。</li>
</ul>
<h3 id="1-5-如何使用微前端"><a href="#1-5-如何使用微前端" class="headerlink" title="1.5 如何使用微前端"></a>1.5 如何使用微前端</h3><p>在使用 <code>qiankun</code> 构建微前端应用时，我们需要按照以下步骤进行：</p>
<ol>
<li>创建主应用：主应用负责整个应用的框架搭建、路由分发和子应用的注册和协调管理。可以使用任何前端框架进行开发，例如 React、Vue、Angular 等。</li>
<li>创建子应用：子应用是独立开发的前端应用程序，可以独立运行，也可以作为主应用的一个子模块运行。每个子应用都可以使用任何前端框架进行开发，例如 React、Vue、Angular 等。</li>
<li>注册子应用：主应用需要在启动时注册所有的子应用。注册时需要指定子应用的名称、访问地址、加载方式和路由配置等信息。</li>
<li>启动子应用：主应用在启动时会自动加载和启动所有的子应用，每个子应用会根据配置的访问地址自动加载。</li>
<li>协调子应用：主应用需要协调管理所有的子应用，包括子应用的加载、启动、挂载、卸载和卸载等操作。主应用可以通过 props 方式传递数据给子应用，也可以通过事件总线的方式进行通信。</li>
<li>卸载子应用：当子应用不再需要时，主应用可以卸载子应用并释放资源，以提高系统的性能和稳定性。</li>
</ol>
<p>除此之外，<code>qiankun</code> 还提供了多种高级特性，例如异步加载、公共依赖、样式隔离、缓存优化等，可以进一步提高应用程序的性能和可维护性。</p>
<h2 id="2-使用qiankun搭建例子："><a href="#2-使用qiankun搭建例子：" class="headerlink" title="2.使用qiankun搭建例子："></a>2.使用<code>qiankun</code>搭建例子：</h2><p>这里举一个 demo 例子，大家如果感兴趣可以按照小浪这样来进行搭建 一个简单的 <code>qiankun</code> 实例 demo</p>
<ul>
<li>主应用使用 React</li>
<li>子应用 1 使用 Vue 3</li>
<li>子应用 2 使用 React</li>
</ul>
<h3 id="2-1-创建主应用"><a href="#2-1-创建主应用" class="headerlink" title="2.1 创建主应用"></a>2.1 创建主应用</h3><p>首先需要创建主应用，我们使用 create-react-app 快速创建一个 React 应用：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx create-react-app qiankun-example</span><br></pre></td></tr></table></figure>
<p>安装依赖</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd qiankun-example</span><br><span class="line">npm install qiankun</span><br></pre></td></tr></table></figure>
<p>修改主应用入口文件 src/index.js，加入以下代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">ReactDOM</span> <span class="keyword">from</span> <span class="string">&#x27;react-dom&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; registerMicroApps, start &#125; <span class="keyword">from</span> <span class="string">&#x27;qiankun&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> apps = \[</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;vue3&#x27;</span>,</span><br><span class="line">    <span class="attr">entry</span>: <span class="string">&#x27;//localhost:8081&#x27;</span>,</span><br><span class="line">    <span class="attr">container</span>: <span class="string">&#x27;#subapp-viewport&#x27;</span>,</span><br><span class="line">    <span class="attr">activeRule</span>: <span class="string">&#x27;/vue3&#x27;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;react-app&#x27;</span>,</span><br><span class="line">    <span class="attr">entry</span>: <span class="string">&#x27;//localhost:8082&#x27;</span>,</span><br><span class="line">    <span class="attr">container</span>: <span class="string">&#x27;#subapp-viewport&#x27;</span>,</span><br><span class="line">    <span class="attr">activeRule</span>: <span class="string">&#x27;/react-app&#x27;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">\];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="title function_">registerMicroApps</span>(apps);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="title function_">start</span>();</span><br></pre></td></tr></table></figure>
<p>在上面小浪首先定义了两个子应用，分别是 <code>Vue 3</code> 应用和 <code>React</code> 应用。然后通过 <code>registerMicroApps</code> 函数注册子应用，启动 <code>qiankun</code>。</p>
<h3 id="2-2-创建子应用-1：Vue-3"><a href="#2-2-创建子应用-1：Vue-3" class="headerlink" title="2.2 创建子应用 1：Vue 3"></a>2.2 创建子应用 1：Vue 3</h3><p>在主应用中我们定义了一个名为 <code>vue3</code> 的子应用，需要先创建子应用的代码。在 <code>vue-cli</code> 中创建一个 <code>Vue 3</code> 应用(大家也可以用<code>vite</code>搭建，这里我用<code>vue-cli</code>)：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vue create subapp-vue3</span><br></pre></td></tr></table></figure>
<p>安装依赖：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd subapp-vue3</span><br><span class="line">npm install</span><br></pre></td></tr></table></figure>
<p>修改 src/main.js，加入以下代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createApp &#125; <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">App</span> <span class="keyword">from</span> <span class="string">&quot;./App.vue&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> instance = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">  instance = <span class="title function_">createApp</span>(<span class="title class_">App</span>).<span class="title function_">mount</span>(<span class="string">&quot;#app&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> === <span class="string">&quot;development&quot;</span>) &#123;</span><br><span class="line">  <span class="title function_">render</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">bootstrap</span>(<span class="params"></span>) &#123;&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">mount</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="title function_">render</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">unmount</span>(<span class="params"></span>) &#123;</span><br><span class="line">  instance.$destroy();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面小浪定义了子应用的渲染函数，用于在主应用中渲染子应用。在开发环境下直接渲染，而在生产环境下则通过导出 <code>bootstrap</code>、<code>mount</code> 和 <code>unmount</code> 函数，由 <code>qiankun</code> 调用。</p>
<h3 id="2-3-创建子应用-2：React-应用"><a href="#2-3-创建子应用-2：React-应用" class="headerlink" title="2.3 创建子应用 2：React 应用"></a>2.3 创建子应用 2：React 应用</h3><p>我们需要先创建 React 应用：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx create-react-app subapp-react</span><br></pre></td></tr></table></figure>
<p>安装依赖：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd subapp-react</span><br><span class="line">npm install</span><br></pre></td></tr></table></figure>
<p>修改 src/index.js，加入以下代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">ReactDOM</span> <span class="keyword">from</span> <span class="string">&quot;react-dom&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">App</span> <span class="keyword">from</span> <span class="string">&quot;./App&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> instance = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="title class_">ReactDOM</span>.<span class="title function_">render</span>(<span class="language-xml"><span class="tag">&lt;<span class="name">App</span> /&gt;</span></span>, <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;root&quot;</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> === <span class="string">&quot;development&quot;</span>) &#123;</span><br><span class="line">  <span class="title function_">render</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">bootstrap</span>(<span class="params"></span>) &#123;&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">mount</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="title function_">render</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">unmount</span>(<span class="params"></span>) &#123;</span><br><span class="line">  instance.$destroy();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里同样定义了子应用的渲染函数，用于在主应用中渲染子应用。在开发环境下直接渲染，而在生产环境下则通过导出 <code>bootstrap</code>、<code>mount</code> 和 <code>unmount</code> 函数，由 <code>qiankun</code> 调用。</p>
<h3 id="2-4-启动应用"><a href="#2-4-启动应用" class="headerlink" title="2.4 启动应用"></a>2.4 启动应用</h3><p>我们需要分别启动主应用和两个子应用</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">启动主应用</span><br><span class="line">cd qiankun-example</span><br><span class="line">npm start</span><br><span class="line"></span><br><span class="line">\# 启动 Vue 3 子应用</span><br><span class="line">cd subapp-vue3</span><br><span class="line">npm run serve -- --port 8081</span><br><span class="line"></span><br><span class="line">\# 启动 React 子应用</span><br><span class="line">cd subapp-react</span><br><span class="line">npm start -- --port 8082</span><br></pre></td></tr></table></figure>
<p>然后在浏览器中访问 <strong>[<a target="_blank" rel="noopener" href="http://localhost:3000">http://localhost:3000</a></strong>，即可看到主应用的页面。在主应用中点击“Vue](<a href="https://link.juejin.cn/?target=http%3A%2F%2Flocalhost%3A3000**%25EF%25BC%258C%25E5%258D%25B3%25E5%258F%25AF%25E7%259C%258B%25E5%2588%25B0%25E4%25B8%25BB%25E5%25BA%2594%25E7%2594%25A8%25E7%259A%2584%25E9%25A1%25B5%25E9%259D%25A2%25E3%2580%2582%25E5%259C%25A8%25E4%25B8%25BB%25E5%25BA%2594%25E7%2594%25A8%25E4%25B8%25AD%25E7%2582%25B9%25E5%2587%25BB%25E2%2580%259CVue">https://link.juejin.cn/?target=http%3A%2F%2Flocalhost%3A3000**%25EF%25BC%258C%25E5%258D%25B3%25E5%258F%25AF%25E7%259C%258B%25E5%2588%25B0%25E4%25B8%25BB%25E5%25BA%2594%25E7%2594%25A8%25E7%259A%2584%25E9%25A1%25B5%25E9%259D%25A2%25E3%2580%2582%25E5%259C%25A8%25E4%25B8%25BB%25E5%25BA%2594%25E7%2594%25A8%25E4%25B8%25AD%25E7%2582%25B9%25E5%2587%25BB%25E2%2580%259CVue</a> “<a target="_blank" rel="noopener" href="http://localhost:3000\*\*%EF%BC%8C%E5%8D%B3%E5%8F%AF%E7%9C%8B%E5%88%B0%E4%B8%BB%E5%BA%94%E7%94%A8%E7%9A%84%E9%A1%B5%E9%9D%A2%E3%80%82%E5%9C%A8%E4%B8%BB%E5%BA%94%E7%94%A8%E4%B8%AD%E7%82%B9%E5%87%BB%E2%80%9CVue">http://localhost:3000\*\*%EF%BC%8C%E5%8D%B3%E5%8F%AF%E7%9C%8B%E5%88%B0%E4%B8%BB%E5%BA%94%E7%94%A8%E7%9A%84%E9%A1%B5%E9%9D%A2%E3%80%82%E5%9C%A8%E4%B8%BB%E5%BA%94%E7%94%A8%E4%B8%AD%E7%82%B9%E5%87%BB%E2%80%9CVue</a>“) 3”或“React App”按钮，即可跳转到对应的子应用页面。在子应用页面中修改内容，可以看到主应用中的内容也随之变化。</p>
<h4 id="子应用中需要引入-qiankun："><a href="#子应用中需要引入-qiankun：" class="headerlink" title="子应用中需要引入 qiankun："></a>子应用中需要引入 <code>qiankun</code>：</h4><p>注意：在子应用中需要引入 <code>qiankun</code> 库，在 <code>Vue 3</code> 应用中需要安装 <code>qiankun</code>，如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install qiankun</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createApp &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; registerMicroApps, start &#125; <span class="keyword">from</span> <span class="string">&#x27;qiankun&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">App</span> <span class="keyword">from</span> <span class="string">&#x27;./App.vue&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_">createApp</span>(<span class="title class_">App</span>).<span class="title function_">mount</span>(<span class="string">&#x27;#app&#x27;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="title function_">registerMicroApps</span>(\[...\]);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="title function_">start</span>();</span><br></pre></td></tr></table></figure>
<p>React 子应用</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">ReactDOM</span> <span class="keyword">from</span> <span class="string">&#x27;react-dom&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; registerMicroApps, start &#125; <span class="keyword">from</span> <span class="string">&#x27;qiankun&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">App</span> <span class="keyword">from</span> <span class="string">&#x27;./App&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="title class_">ReactDOM</span>.<span class="title function_">render</span>(<span class="language-xml"><span class="tag">&lt;<span class="name">App</span> /&gt;</span></span>, <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;root&#x27;</span>));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="title function_">registerMicroApps</span>(\[...\]);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="title function_">start</span>();</span><br></pre></td></tr></table></figure>
<p><code>registerMicroApps(\[...\])</code> 中的 […] 是一个数组，其中包含了注册的子应用的配置信息，每个配置项是一个对象，至少包含以下几个属性:</p>
<ul>
<li><code>name</code>：子应用的名称，需要保证唯一性。</li>
<li><code>entry</code>：子应用的入口 URL。</li>
<li><code>container</code>：子应用渲染的容器，通常是一个 DOM 元素或一个选择器。</li>
<li><code>activeRule</code>：子应用的激活规则，指定该子应用应该在哪些 URL 下被激活。</li>
</ul>
<p>例如</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">registerMicroApps</span>(\[</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;vue3&#x27;</span>,</span><br><span class="line">    <span class="attr">entry</span>: <span class="string">&#x27;//localhost:8081&#x27;</span>,</span><br><span class="line">    <span class="attr">container</span>: <span class="string">&#x27;#vue3&#x27;</span>,</span><br><span class="line">    <span class="attr">activeRule</span>: <span class="string">&#x27;/vue3&#x27;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;react&#x27;</span>,</span><br><span class="line">    <span class="attr">entry</span>: <span class="string">&#x27;//localhost:8082&#x27;</span>,</span><br><span class="line">    <span class="attr">container</span>: <span class="string">&#x27;#react&#x27;</span>,</span><br><span class="line">    <span class="attr">activeRule</span>: <span class="string">&#x27;/react&#x27;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">\]);</span><br></pre></td></tr></table></figure>
<p>以上代码注册了两个子应用 一个是 Vue 3 应用，一个是 React 应用。</p>
<ol>
<li><code>name</code> 分别为 ‘vue3’ 和 ‘react’，</li>
<li><code>entry</code> 分别为 ‘//localhost:8081’ 和 ‘//localhost:8082’，</li>
<li><code>container</code> 分别为 ‘#vue3’ 和 ‘#react’，</li>
<li><code>activeRule</code> 分别为 ‘/vue3’ 和 ‘/react’。</li>
</ol>
<p>注意</p>
<p>1.<code>entry</code> 属性的值应该是子应用的访问 URL，可以是本地开发服务器的地址，也可以是部署到服务器上的地址。<code>container</code> 属性的值可以是一个 DOM 元素，也可以是一个选择器字符串。在子应用中，渲染组件时需要将组件挂载到该容器中。<code>activeRule</code> 属性的值是一个路径匹配规则，表示子应用应该在哪些 URL 下被激活，可以是字符串或正则表达式。如果当前 URL 匹配了该规则，则该子应用会被激活。</p>
<p>2.子应用中也需要写 <code>registerMicroApps(\[...\])</code> 来注册子应用。不同之处在于，子应用注册时需要指定一些配置项，以便于在主应用中正确加载和管理子应用。 在子应用中，通常会将 <code>registerMicroApps(\[...\])</code> 封装成一个函数，以便于主应用加载子应用时调用该函数注册子应用。例如：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; registerMicroApps, start &#125; <span class="keyword">from</span> <span class="string">&#x27;qiankun&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">initApp</span>(<span class="params"></span>) &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">register</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="title function_">registerMicroApps</span>(\[</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&#x27;vue3&#x27;</span>,</span><br><span class="line">      <span class="attr">entry</span>: <span class="string">&#x27;//localhost:8081&#x27;</span>,</span><br><span class="line">      <span class="attr">container</span>: <span class="string">&#x27;#vue3&#x27;</span>,</span><br><span class="line">      <span class="attr">activeRule</span>: <span class="string">&#x27;/vue3&#x27;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  \]);</span><br><span class="line"></span><br><span class="line">  <span class="title function_">start</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">bootstrap</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="title function_">initApp</span>();</span><br><span class="line">  <span class="title function_">render</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="variable language_">window</span>.\_\_POWERED\_BY\_QIANKUN\_\_) &#123;</span><br><span class="line">  <span class="title function_">bootstrap</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">mount</span>(<span class="params">props</span>) &#123;</span><br><span class="line">  <span class="title function_">bootstrap</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">unmount</span>(<span class="params">props</span>) &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在上面的代码中，register() 函数用来注册子应用，其中的配置项与主应用中的相同。bootstrap() 函数用来启动子应用，其中包含了初始化和渲染等过程。mount() 函数用来作为子应用加载时的入口，其中包含了注册、初始化、渲染等过程。unmount() 函数用来作为子应用卸载时的入口，其中包含了销毁子应用的过程。需要注意的是，如果子应用是独立运行的，即非通过主应用加载的，那么直接调用 bootstrap() 启动子应用即可。</p>
<h3 id="2-5-全局状态管理"><a href="#2-5-全局状态管理" class="headerlink" title="2.5 全局状态管理"></a>2.5 全局状态管理</h3><p>主应用可以通过 <code>setGlobalState</code> 方法来设置全局状态，子应用可以通过 <code>onGlobalStateChange</code> 方法来监听全局状态的变化。这样，当主应用修改了全局状态时，所有的子应用都可以得到通知并进行相应的处理。</p>
<blockquote>
<p>在主应用中设置全局状态：</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; setGlobalState &#125; <span class="keyword">from</span> <span class="string">&quot;qiankun&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_">setGlobalState</span>(&#123; <span class="attr">user</span>: &#123; <span class="attr">name</span>: <span class="string">&quot;lang&quot;</span>, <span class="attr">age</span>: <span class="number">18</span> &#125; &#125;);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>在子应用中监听全局状态的变化：</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; onGlobalStateChange, setGlobalState &#125; <span class="keyword">from</span> <span class="string">&quot;qiankun&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_">onGlobalStateChange</span>(<span class="function">(<span class="params">newState, prevousState</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;newState:&quot;</span>, newState);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;prevousState:&quot;</span>, prevousState);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="title function_">setGlobalState</span>(&#123; <span class="attr">user</span>: &#123; <span class="attr">name</span>: <span class="string">&quot;xiaolang&quot;</span>, <span class="attr">age</span>: <span class="number">20</span> &#125; &#125;);</span><br></pre></td></tr></table></figure>
<h3 id="2-6-子应用之间共享状态"><a href="#2-6-子应用之间共享状态" class="headerlink" title="2.6 子应用之间共享状态"></a>2.6 子应用之间共享状态</h3><p>子应用之间可以通过主应用作为中介来实现状态的共享。具体实现方式如下：</p>
<blockquote>
<p>在主应用中设置共享状态</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; setGlobalState &#125; <span class="keyword">from</span> <span class="string">&quot;qiankun&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_">setGlobalState</span>(&#123; <span class="attr">user</span>: &#123; <span class="attr">name</span>: <span class="string">&quot;lang&quot;</span>, <span class="attr">age</span>: <span class="number">18</span> &#125; &#125;);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>在主应用中将共享状态传递给子应用：</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; start &#125; <span class="keyword">from</span> <span class="string">&quot;qiankun&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">start</span>(&#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&quot;vue3&quot;</span>,</span><br><span class="line">  <span class="attr">entry</span>: <span class="string">&quot;//localhost:8081&quot;</span>,</span><br><span class="line">  <span class="attr">container</span>: <span class="string">&quot;#vue3&quot;</span>,</span><br><span class="line">  <span class="attr">activeRule</span>: <span class="string">&quot;/vue3&quot;</span>,</span><br><span class="line">  <span class="attr">props</span>: &#123;</span><br><span class="line">    <span class="attr">shared</span>: &#123;</span><br><span class="line">      <span class="attr">getGlobalState</span>: <span class="function">() =&gt;</span> <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(globalState),</span><br><span class="line">      <span class="attr">setGlobalState</span>: <span class="function">(<span class="params">state</span>) =&gt;</span> <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(<span class="title function_">setGlobalState</span>(state)),</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>在子应用中使用共享状态：</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; initGlobalState &#125; <span class="keyword">from</span> <span class="string">&quot;qiankun&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> actions = <span class="title function_">initGlobalState</span>(&#123; <span class="attr">user</span>: &#123; <span class="attr">name</span>: <span class="string">&quot;lang1&quot;</span>, <span class="attr">age</span>: <span class="number">19</span> &#125; &#125;);</span><br><span class="line"></span><br><span class="line">actions.<span class="title function_">onGlobalStateChange</span>(<span class="function">(<span class="params">newState, prevousState</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;newState:&quot;</span>, newState);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;prevousState:&quot;</span>, prevousState);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">actions.<span class="title function_">setGlobalState</span>(&#123; <span class="attr">user</span>: &#123; <span class="attr">name</span>: <span class="string">&quot;lang2&quot;</span>, <span class="attr">age</span>: <span class="number">20</span> &#125; &#125;);</span><br></pre></td></tr></table></figure>
<p>上面，主应用通过 <code>props</code> 将 <code>getGlobalState</code> 和 <code>setGlobalState</code> 传递给了子应用。子应用可以通过 <code>initGlobalState</code> 方法来初始化全局状态，并且可以监听全局状态的变化。在子应用中，如果需要修改全局状态，可以通过 <code>setGlobalState</code> 方法来实现。</p>
<h3 id="2-7-子应用如何调用其他子应用组件"><a href="#2-7-子应用如何调用其他子应用组件" class="headerlink" title="2.7 子应用如何调用其他子应用组件"></a>2.7 子应用如何调用其他子应用组件</h3><h4 id="Vue-子应用中调用-React-子应用的组件"><a href="#Vue-子应用中调用-React-子应用的组件" class="headerlink" title="Vue 子应用中调用 React 子应用的组件"></a>Vue 子应用中调用 React 子应用的组件</h4><p>可以先在主应用中通过 <code>registerMicroApps</code> 方法注册好所有的子应用，并在主应用中管理子应用之间的通信。然后，可以在需要使用其他子应用组件的子应用中通过 <code>loadMicroApp</code> 方法异步加载对应的子应用并获取到对应子应用的实例，从而使用其提供的组件。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; loadMicroApp &#125; <span class="keyword">from</span> <span class="string">&quot;qiankun&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">loadReactApp</span> = (<span class="params"></span>) =&gt;</span><br><span class="line">  <span class="title function_">loadMicroApp</span>(&#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&quot;reactApp&quot;</span>,</span><br><span class="line">    <span class="attr">entry</span>: <span class="string">&quot;//localhost:8082&quot;</span>,</span><br><span class="line">    <span class="attr">container</span>: <span class="string">&quot;#react&quot;</span>,</span><br><span class="line">    <span class="attr">activeRule</span>: <span class="string">&quot;/react&quot;</span>,</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">VueApp</span> = &#123;</span><br><span class="line">  <span class="attr">template</span>: <span class="string">`</span></span><br><span class="line"><span class="string">    &lt;div&gt;</span></span><br><span class="line"><span class="string">      &lt;h1&gt;VueApp&lt;/h1&gt;</span></span><br><span class="line"><span class="string">      &lt;react-component /&gt;</span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string">  `</span>,</span><br><span class="line">  <span class="title function_">mounted</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title function_">loadReactApp</span>().<span class="title function_">then</span>(<span class="function">(<span class="params">app</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> <span class="title class_">ReactComponent</span> = app.<span class="title function_">getComponent</span>(<span class="string">&quot;ReactComponent&quot;</span>);</span><br><span class="line">      <span class="title class_">Vue</span>.<span class="title function_">component</span>(<span class="string">&quot;react-component&quot;</span>, &#123;</span><br><span class="line">        <span class="attr">template</span>: <span class="string">`&lt;div&gt;&lt;ReactComponent /&gt;&lt;/div&gt;`</span>,</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>在 <code>VueApp</code> 的 <code>mounted</code> 生命周期中异步加载了 <code>ReactApp</code> 并获取到其实例，然后通过 <code>getComponent</code> 方法获取到了 <code>ReactApp</code> 中提供的 <code>ReactComponent</code> 组件，并将其转换为 Vue 组件供 <code>VueApp</code> 使用。</p>
</blockquote>
<h4 id="React-子应用中调用-Vue-子应用的组件"><a href="#React-子应用中调用-Vue-子应用的组件" class="headerlink" title="React 子应用中调用 Vue 子应用的组件"></a>React 子应用中调用 Vue 子应用的组件</h4><blockquote>
<p>React 子应用中，加载 Vue 子应用并获取其组件：</p>
</blockquote>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; loadMicroApp, getGlobalState &#125; <span class="keyword">from</span> <span class="string">&#x27;qiankun&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">App</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> \[vueComponent, setVueComponent\] = <span class="title function_">useState</span>(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> vueApp = <span class="title function_">loadMicroApp</span>(&#123;</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&#x27;vue3&#x27;</span>,</span><br><span class="line">      <span class="attr">entry</span>: <span class="string">&#x27;//localhost:8081&#x27;</span>,</span><br><span class="line">      <span class="attr">container</span>: <span class="string">&#x27;#vue3&#x27;</span>,</span><br><span class="line">      <span class="attr">activeRule</span>: <span class="string">&#x27;/vue3&#x27;</span>,</span><br><span class="line">      <span class="attr">props</span>: &#123; <span class="attr">name</span>: <span class="string">&#x27;vue-app&#x27;</span> &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    vueApp.<span class="title function_">onGlobalStateChange</span>(<span class="function">(<span class="params">state, prev</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;\[React\] Vue global state changed: &#x27;</span>, state);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    vueApp</span><br><span class="line">      .<span class="property">loadPromise</span>.<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> vueInstance = vueApp.<span class="title function_">bootstrap</span>();</span><br><span class="line">        <span class="title function_">setVueComponent</span>(vueInstance.<span class="property">$children</span>\[<span class="number">0</span>\]);</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="function">() =&gt;</span> vueApp.<span class="title function_">unmount</span>();</span><br><span class="line">  &#125;, \[\]);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">h1</span>&gt;</span>React App<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">hr</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">h2</span>&gt;</span>Vue App Component:<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      &#123;vueComponent &amp;&amp; (</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;vueComponent.message&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> vueComponent.handleClick()&#125;&gt;Click me!<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      )&#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">App</span>;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>当然得在 Vue 子应用中，暴露一个组件，上面的<code>vueInstance.$children\[0\]</code>就是这个组件：</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;p&gt;&#123;&#123; message &#125;&#125;&lt;/p&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">export default &#123;</span><br><span class="line">  data() &#123;</span><br><span class="line">    return &#123;</span><br><span class="line">      message: &quot;Hello from Vue!&quot;,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">  methods: &#123;</span><br><span class="line">    handleClick() &#123;</span><br><span class="line">      console.log(&quot;Vue button clicked!&quot;);</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<h4 id="传递参数"><a href="#传递参数" class="headerlink" title="传递参数"></a>传递参数</h4><blockquote>
<p>在调用其他子应用的组件时，可以使用 <code>props</code> 传递参数，和在普通的 React 组件中传递 <code>props</code> 是类似的。具体来说，在调用时，可以将需要传递的参数放在 <code>props</code> 对象中，然后作为第二个参数传递给 <code>render</code> 方法，例如：</p>
</blockquote>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; render, hydrate &#125; <span class="keyword">from</span> <span class="string">&#x27;react-dom&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; registerMicroApps, start &#125; <span class="keyword">from</span> <span class="string">&#x27;qiankun&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">App</span> <span class="keyword">from</span> <span class="string">&#x27;./App&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="title function_">registerMicroApps</span>(\[...\]);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="title function_">start</span>();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">App</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      &#123;/\* 调用 Vue 子应用的组件 */&#125;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        &#123;render(&#x27;vue3&#x27;, &#123; name: &#x27;Tom&#x27; &#125;, &#123; container: &#x27;#vue-container&#x27; &#125;)&#125;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="title function_">hydrate</span>(<span class="language-xml"><span class="tag">&lt;<span class="name">App</span> /&gt;</span></span>, <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;root&#x27;</span>));</span><br></pre></td></tr></table></figure>
<blockquote>
<p>我们向 Vue 子应用的组件中传递了一个名为 <code>name</code> 的参数，并且将其渲染到了 <code>#vue-container</code> 容器中。在 Vue 子应用中，可以通过 <code>props</code> 对象获取这个参数，例如：</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;h2&gt;Vue Component&lt;/h2&gt;</span><br><span class="line">    &lt;p&gt;Hello, &#123;&#123; name &#125;&#125;!&lt;/p&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">export default &#123;</span><br><span class="line">  name: &quot;VueComponent&quot;,</span><br><span class="line">  props: &#123;</span><br><span class="line">    name: &#123;</span><br><span class="line">      type: String,</span><br><span class="line">      required: true,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>这样，在 Vue 子应用中就可以通过 <code>this.$props.name</code> 访问这个参数了</p>
<h4 id="注意："><a href="#注意：" class="headerlink" title="注意："></a>注意：</h4><p>由于 Vue 和 React 使用了不同的渲染引擎，它们之间的组件并不完全兼容。我这个也是自己想尝试一下不同的语言他们互相调用，所以大家在实际开发中需要根据具体情况来选择使用哪种方式来实现组件之间的互相调用。一般的话还是 vue 调用 vue, react 调用 react 兼容比较好。</p>
<p>上面就是就是小浪介绍的一个简单的 <code>qiankun</code> 实例 demo，包括主应用使用 <code>React</code>，子应用 1 使用 <code>Vue 3</code>，子应用 2 使用 <code>React</code> 。</p>
<h2 id="3-我开发中遇到的坑点"><a href="#3-我开发中遇到的坑点" class="headerlink" title="3.我开发中遇到的坑点"></a>3.我开发中遇到的坑点</h2><blockquote>
<p>在平时的开发肯定也不是一帆风顺的，也会多多少少遇到一些问题，下面是我平时遇到的一些问题，也查阅一些解决措施，这里就不一一详细把解决措施写出来，哈哈哈，写不完。</p>
</blockquote>
<h3 id="3-1-路由问题："><a href="#3-1-路由问题：" class="headerlink" title="3.1 路由问题："></a>3.1 路由问题：</h3><p>由于主应用和子应用都需要进行路由处理，需要注意路由的定义、匹配和传递，确保各个子应用之间的路由能够正确地被处理。</p>
<p>措施：统一路由管理：尽量采用相同的路由管理方式，确保路由的定义和匹配方式相同，方便进行传递和处理。</p>
<h3 id="3-2-样式隔离问题："><a href="#3-2-样式隔离问题：" class="headerlink" title="3.2 样式隔离问题："></a>3.2 样式隔离问题：</h3><p>由于不同的子应用之间可能会有样式冲突的问题，需要考虑如何进行样式隔离，以确保各个子应用之间的样式不会互相干扰。</p>
<p>措施：可以采用 CSS Modules、BEM 等方式进行样式隔离，或者使用 Shadow DOM 等技术进行样式隔离。在公司里后面全部改用 CSS Modules。</p>
<h3 id="3-3-全局状态管理问题："><a href="#3-3-全局状态管理问题：" class="headerlink" title="3.3 全局状态管理问题："></a>3.3 全局状态管理问题：</h3><p>由于各个子应用之间需要共享一些全局状态，需要考虑如何进行全局状态管理，以便于各个子应用之间能够共享数据。</p>
<p>措施：可以采用 Redux、Mobx 等全局状态管理库进行状态管理，或者使用 qiankun 提供的 props、emit 等方式进行状态传递。</p>
<h3 id="3-4-生命周期问题："><a href="#3-4-生命周期问题：" class="headerlink" title="3.4 生命周期问题："></a>3.4 生命周期问题：</h3><p>由于 qiankun 微前端框架会对主应用和子应用进行生命周期管理，因此需要注意各个组件的生命周期方法的调用时机和顺序。</p>
<p>措施：可以在各个生命周期方法中进行必要的处理，或者使用 qiankun 提供的 emitLifeCycles 等方式进行生命周期管理。</p>
<h3 id="3-5-缓存问题："><a href="#3-5-缓存问题：" class="headerlink" title="3.5 缓存问题："></a>3.5 缓存问题：</h3><p>由于 qiankun 微前端框架会对各个子应用进行缓存，需要注意缓存的清理和更新，以确保各个子应用之间的数据能够及时地同步更新</p>
<p>措施：可以使用 qiankun 提供的 prefetch、sandbox 等方式进行缓存管理，或者手动清理和更新缓存。</p>
<h3 id="3-6-避免重复引入公共依赖："><a href="#3-6-避免重复引入公共依赖：" class="headerlink" title="3.6 避免重复引入公共依赖："></a>3.6 避免重复引入公共依赖：</h3><blockquote>
<p>在多个子应用之间共享组件时，应该避免重复引入公共依赖。一种解决方法是将公共依赖打包为一个单独的库，并将其发布到 npm 上，然后在子应用中通过 npm 依赖引入。另一种解决方法是将公共依赖打包为 umd 格式，并在<code>qiankun</code>的<code>global</code>对象上注册，使得其他子应用可以通过<code>global</code>对象来访问公共依赖。例如：</p>
</blockquote>
<p>在主应用中注册公共依赖：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">ReactDOM</span> <span class="keyword">from</span> <span class="string">&quot;react-dom&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">MyComponent</span> <span class="keyword">from</span> <span class="string">&quot;my-component&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">window</span>.<span class="property">MyComponent</span> = <span class="title class_">MyComponent</span>;</span><br></pre></td></tr></table></figure>
<p>在子应用中使用公共依赖：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">ReactDOM</span> <span class="keyword">from</span> <span class="string">&quot;react-dom&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; useEffect &#125; <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; <span class="title class_">MyComponent</span> &#125; = <span class="variable language_">window</span>;</span><br></pre></td></tr></table></figure>
<h3 id="3-7-确保应用能够正确注册"><a href="#3-7-确保应用能够正确注册" class="headerlink" title="3.7 确保应用能够正确注册"></a>3.7 确保应用能够正确注册</h3><p>这可能是我自己会遇到的问题，有时候因为自己拼错单词，导致没有注册成功…..应用注册是一个关键步骤，需要确保主应用和子应用都能够正确地注册到<code>qiankun</code>微前端框架中。在主应用中，应该正确地调用<code>registerMicroApps</code>函数，并确保子应用的<code>entry</code>和<code>container</code>属性都被正确地设置。在子应用中，应该正确地调用<code>start</code>函数，并确保子应用的<code>mount</code>函数能够正确地渲染子应用。</p>
<h2 id="4-结语："><a href="#4-结语：" class="headerlink" title="4.结语："></a>4.结语：</h2><p>​ 有的时候查找微前端相关的问题的时候，下面总有言论，不看好微前端</p>
<p>​ 确实，微前端需要解决许多复杂的问题，例如应用程序的拆分、应用程序之间的通信和数据共享等。这会增加开发和维护的复杂性，可能需要额外的学习成本和工具支持。微前端应用程序可能需要通过网络加载许多小块代码，这可能会影响应用程序的性能和用户体验。此外，微前端还需要在运行时处理一些额外的逻辑，例如路由和状态管理，微前端应用程序可能需要跨域通信和数据共享，这可能会引入一些安全风险。此外，微前端还需要确保应用程序的隔离和沙箱，以防止应用程序之间的影响和攻击。技术选型：微前端需要处理不同的技术栈和框架之间的兼容性和交互性。这可能需要额外的工作。等等问题。</p>
<h3 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h3><blockquote>
<p>​ 虽然微前端存在一些挑战和限制，但随着技术的发展和社区的支持，这些问题将得到解决，微前端也将成为构建大型前端应用程序的一种有力选择。总之，qiankun 是一个非常优秀的微前端解决方案，它可以帮助我们更好地管理和维护前端应用程序，提高应用程序的可扩展性和可维护性。同时，qiankun 也是一个非常灵活和可扩展的框架，可以适用于各种前端应用程序的开发场景。</p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://liantianno1.github.io/xiaolangwiki/2022/09/21/22/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/xiaolangwiki/images/avatar.png">
      <meta itemprop="name" content="小浪wiki">
      <meta itemprop="description" content="一个关于编程、计算机、软件工程、互联网的知识库。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小浪wiki">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/xiaolangwiki/2022/09/21/22/" class="post-title-link" itemprop="url">从"登录"到"人生":一个准程序员的"以终为始"领悟</a>
        </h2>

        <div class="post-meta">
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-09-21 09:11:22" itemprop="dateCreated datePublished" datetime="2022-09-21T09:11:22+08:00">2022-09-21</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/xiaolangwiki/categories/%E6%80%9D%E8%80%83/" itemprop="url" rel="index"><span itemprop="name">思考</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="从”登录”到”人生”-一个准程序员的”以终为始”领悟"><a href="#从”登录”到”人生”-一个准程序员的”以终为始”领悟" class="headerlink" title="从”登录”到”人生”:一个准程序员的”以终为始”领悟"></a>从”登录”到”人生”:一个准程序员的”以终为始”领悟</h1><p>大家好,我是小浪,一个即将毕业的软件工程专业学生。最近在做项目的时候,我突然对”以终为始”这个概念有了全新的认识,感觉整个人都升级了,忍不住想和大家分享一下。</p>
<p>还记得大二那会儿,我们上软件工程课时做过一个设计登录功能的小练习。那时候的我,满脑子都是炫酷的界面设计、花里胡哨的动画效果,甚至还想着加个人脸识别啥的。结果呢?老师看完我的设计后,只说了一句话:”你有考虑过用户真正需要的是什么吗?”</p>
<p>我懵了。是啊,我设计了半天,好像真的没想过用户到底需要什么。这个小小的挫折让我开始思考:我们做事情的时候,是不是应该先想想最终要达到什么效果,而不是一头扎进去就开始干?</p>
<p>后来在实习的时候,我遇到了一个特别厉害的mentor。有一次我们在讨论一个新功能,我又开始滔滔不绝地说起实现方案。他听了一会儿,打断我说:”小浪,先别急着谈怎么做。咱们先想想,如果这个功能做好了,会给用户带来什么样的体验?它会解决用户什么问题?”</p>
<p>这一刻,我仿佛被打开了新世界的大门。原来,真正高明的程序员,不是写代码最快的,而是最懂得思考目标和结果的。</p>
<p>从那以后,我开始尝试用”以终为始”的方式来做事。比如在做毕业设计的时候,我没有急着写代码,而是先花了两周时间去调研用户需求,设想产品上线后的场景。这个过程让我发现了很多之前忽视的细节,最后做出来的作品不仅得到了老师的肯定,还真的解决了一些同学的实际问题。</p>
<p>现在回想起来,我发现”以终为始”其实不只是一种工作方法,更是一种生活态度。它让我学会了在行动之前先思考目标,在忙碌之中不忘初心。</p>
<p>就拿找工作来说吧。很多同学一头扎进各种面试题海里,但我选择先想清楚自己理想的职业发展路径。结果是,虽然我可能刷题没他们多,但在面试的时候能够清晰地表达自己的职业规划,反而得到了面试官的青睐。</p>
<p>当然,实践”以终为始”并不总是容易的。有时候,我也会陷入日常琐事,忘记了最初的目标。但每当我感到迷茫或者压力山大的时候,我就会停下来问自己:”我最终想要达到什么样的结果?”这个简单的问题总能让我重新找到方向。</p>
<p>对于我们这些即将踏入职场的准程序员来说,”以终为始”的思维方式尤为重要。因为我们的工作本质上是在将想象变为现实,如果连自己想要的结果都不清楚,又怎么能写出好的代码呢?</p>
<p>所以,我想对所有和我一样的学弟学妹们说:不要急着埋头苦干,先抬头看看你要到达的方向。无论是学习、工作还是生活,都要先想清楚你想要的结果是什么,然后再规划你的行动。这样,你的每一分努力都不会白费,每一步都会离你的目标更近一些。</p>
<p>最后,我想用我们专业常说的一句话来结束这篇文章:”代码是怎么写的不重要,重要的是它能不能解决问题。”同样,生活也是如此,重要的不是你多么忙碌,而是你是否在朝着自己想要的方向前进。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://liantianno1.github.io/xiaolangwiki/2022/08/21/24/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/xiaolangwiki/images/avatar.png">
      <meta itemprop="name" content="小浪wiki">
      <meta itemprop="description" content="一个关于编程、计算机、软件工程、互联网的知识库。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小浪wiki">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/xiaolangwiki/2022/08/21/24/" class="post-title-link" itemprop="url">手写简单vue3响应式原理</a>
        </h2>

        <div class="post-meta">
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-08-21 09:06:24" itemprop="dateCreated datePublished" datetime="2022-08-21T09:06:24+08:00">2022-08-21</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/xiaolangwiki/categories/%E5%89%8D%E7%AB%AF/" itemprop="url" rel="index"><span itemprop="name">前端</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="手写简单-vue3-响应式原理"><a href="#手写简单-vue3-响应式原理" class="headerlink" title="手写简单 vue3 响应式原理"></a>手写简单 vue3 响应式原理</h2><p>原文：<a target="_blank" rel="noopener" href="https://juejin.cn/post/7134281691295645732">https://juejin.cn/post/7134281691295645732</a></p>
<blockquote>
<p>在之前的文章里小浪介绍过<a target="_blank" rel="noopener" href="https://juejin.cn/post/6989106100582744072" title="https://juejin.cn/post/6989106100582744072">Vue2 的响应式原理</a>，评论中有掘友评论想让我介绍 Vue3 的响应式原理，那么在这篇文章中小浪来带大家来简单手写一下 Vue3 中的几个响应式 api</p>
</blockquote>
<h2 id="Proxy"><a href="#Proxy" class="headerlink" title="Proxy"></a>Proxy</h2><blockquote>
<p>首先得先来介绍一下 Proxy 这个强大的 API：</p>
<p>在 Vue3 中使用 Proxy 对象来代替 Vue 2 中基于 Object.defineProperty，消除了 Vue 2 中基于 Object.defineProperty 所存在的一些局限，比如无法监听数组索引，length 属性等等</p>
<p>在 Proxy 中默认监听动态添加属性和属性的删除操作，就很方便</p>
</blockquote>
<p><strong>Proxy</strong>配合<strong>Reflect</strong>使用，<strong>Reflect</strong>是<strong>ES6</strong>出现的新特性，代码运行期间用来设置或获取对象成员（操作对象成员），<strong>Reflect</strong>没有出现前使用<strong>Object</strong>的一些方法比如 <code>Object.getPrototypeOf,</code><strong>Reflect</strong>也有对应的方法 <code>Reflect.getPrototypeOf</code>,两者都是一样的，不过<strong>Reflect</strong>更有语义。</p>
<p>下面来看一下基本的使用</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> target = &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&quot;小浪&quot;</span>,</span><br><span class="line">  <span class="attr">age</span>: <span class="number">22</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> handler = &#123;</span><br><span class="line">  <span class="title function_">get</span>(<span class="params">target, key, receiver</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`获取对象属性<span class="subst">$&#123;key&#125;</span>值`</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">get</span>(target, key, receiver);</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="title function_">set</span>(<span class="params">target, key, value, receiver</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`设置对象属性<span class="subst">$&#123;key&#125;</span>值`</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">set</span>(target, key, value, receiver);</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="title function_">deleteProperty</span>(<span class="params">target, key</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`删除对象属性<span class="subst">$&#123;key&#125;</span>值`</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">deleteProperty</span>(target, key);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> proxy = <span class="keyword">new</span> <span class="title class_">Proxy</span>(target, handler);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(proxy.<span class="property">age</span>);</span><br><span class="line">proxy.<span class="property">age</span> = <span class="number">21</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">delete</span> proxy.<span class="property">age</span>);</span><br></pre></td></tr></table></figure>
<p>输出</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">获取对象属性age值</span><br><span class="line">22</span><br><span class="line">设置对象属性age值</span><br><span class="line">删除对象属性age值</span><br><span class="line"><span class="literal">true</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>target：参数表示所要拦截的目标对象</p>
<p>handler：参数也是一个对象，用来定制拦截行为</p>
</blockquote>
<p>注意：</p>
<ul>
<li><strong>this</strong> 关键字表示的是代理的 handler 对象，<strong>所以不能使用 this 而是要用 receiver 传递</strong>，<code>receiver</code>代表当前 proxy 对象 或者 继承 proxy 的对象，它保证传递正确的 this 给 getter，setter</li>
<li><code>set</code> 和 <code>deleteProperty</code> 也需要返回（添加<code>return</code> ），返回的是一个布尔值，设置/删除成功返回 true，反之返回 false</li>
</ul>
<h2 id="reactive"><a href="#reactive" class="headerlink" title="reactive"></a>reactive</h2><p>了解了上面的 Proxy 和 Reflect，我们来看一下 reactive 的实现，reactive，返回 proxy 对象，这个 reactive 可以深层次递归，如果发现子元素存在引用类型，递归处理。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">isObject</span> = (<span class="params">val</span>) =&gt; val !== <span class="literal">null</span> &amp;&amp; <span class="keyword">typeof</span> val === <span class="string">&quot;object&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">hasOwn</span> = (<span class="params">target, key</span>) =&gt;</span><br><span class="line">  <span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">hasOwnProperty</span>.<span class="title function_">call</span>(target, key);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">reactive</span>(<span class="params">target</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="title function_">isObject</span>(target)) <span class="keyword">return</span> target;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> handler = &#123;</span><br><span class="line">    <span class="title function_">get</span>(<span class="params">target, key, receiver</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`获取对象属性<span class="subst">$&#123;key&#125;</span>值`</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> result = <span class="title class_">Reflect</span>.<span class="title function_">get</span>(target, key, receiver);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (<span class="title function_">isObject</span>(result)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">reactive</span>(result);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="title function_">set</span>(<span class="params">target, key, value, receiver</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`设置对象属性<span class="subst">$&#123;key&#125;</span>值`</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> oldValue = <span class="title class_">Reflect</span>.<span class="title function_">get</span>(target, key, reactive);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">let</span> result = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (oldValue !== value) &#123;</span><br><span class="line">        result = <span class="title class_">Reflect</span>.<span class="title function_">set</span>(target, key, value, receiver);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="title function_">deleteProperty</span>(<span class="params">target, key</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`删除对象属性<span class="subst">$&#123;key&#125;</span>值`</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> hadKey = <span class="title function_">hasOwn</span>(target, key);</span><br><span class="line">      <span class="keyword">const</span> result = <span class="title class_">Reflect</span>.<span class="title function_">deleteProperty</span>(target, key);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (hadKey &amp;&amp; result) &#123;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Proxy</span>(target, handler);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;zh-CN&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;ie=edge&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span><span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;module&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">import</span> &#123; reactive &#125; <span class="keyword">from</span> <span class="string">&quot;../src/reactive.js&quot;</span>;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">const</span> obj = &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">name</span>: <span class="string">&quot;小浪&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">age</span>: <span class="number">22</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">test</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">          <span class="attr">test1</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">test2</span>: <span class="number">21</span>,</span></span><br><span class="line"><span class="language-javascript">          &#125;,</span></span><br><span class="line"><span class="language-javascript">        &#125;,</span></span><br><span class="line"><span class="language-javascript">      &#125;;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">const</span> proxy = <span class="title function_">reactive</span>(obj);</span></span><br><span class="line"><span class="language-javascript">      <span class="variable language_">console</span>.<span class="title function_">log</span>(proxy.<span class="property">age</span>);</span></span><br><span class="line"><span class="language-javascript">      proxy.<span class="property">test</span>.<span class="property">test1</span>.<span class="property">test2</span> = <span class="number">22</span>;</span></span><br><span class="line"><span class="language-javascript">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">delete</span> proxy.<span class="property">age</span>);</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/55627152ac1843feb5bec13dc3641bb0~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?" alt="image.png"></p>
<h2 id="收集依赖-触发更新"><a href="#收集依赖-触发更新" class="headerlink" title="收集依赖/触发更新"></a>收集依赖/触发更新</h2><p>上面我们还有 get 中收集依赖没有完成，收集依赖涉及道 track , effect 还有依赖地图，下面我给出一张图先介绍一下 effect 和 track 是如何收集依赖的</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/faf059ee41664a69a4fcd89f471c20f8~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?" alt="image.png"></p>
<p>响应式顺序：effect &gt; track &gt; trigger &gt; effect</p>
<p>在组件渲染过程中，一个 effect 会会触发 get，从而对值进行 track，当值发生改变，就会进行 trigge，执行 effect 来完成一个响应</p>
<p>那么先来实现 effect</p>
<h3 id="effect"><a href="#effect" class="headerlink" title="effect"></a>effect</h3><blockquote>
<p>effect 的实现很简单</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> activeEffect = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">effect</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">  activeEffect = callback;</span><br><span class="line">  <span class="title function_">callback</span>();</span><br><span class="line">  activeEffect = <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="track"><a href="#track" class="headerlink" title="track"></a>track</h3><blockquote>
<p>然后就是对 track 的实现</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> targetMap = <span class="keyword">new</span> <span class="title class_">WeakMap</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">track</span>(<span class="params">target, key</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!activeEffect) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> depsMap = targetMap.<span class="title function_">get</span>(target);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!depsMap) &#123;</span><br><span class="line">    targetMap.<span class="title function_">set</span>(target, (depsMap = <span class="keyword">new</span> <span class="title class_">Map</span>()));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> dep = depsMap.<span class="title function_">get</span>(key);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!dep) &#123;</span><br><span class="line">    depsMap.<span class="title function_">set</span>(key, (dep = <span class="keyword">new</span> <span class="title class_">Set</span>()));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!dep.<span class="title function_">has</span>(activeEffect)) &#123;</span><br><span class="line">    dep.<span class="title function_">add</span>(activeEffect);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>最后添加到 hander 里 get 中</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">get</span>(<span class="params">target, key, receiver</span>) &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="title function_">track</span>(target, key)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<h3 id="触发更新"><a href="#触发更新" class="headerlink" title="触发更新"></a>触发更新</h3><p>通过上面的图，我们知道在 set 中使用 trigger 函数来触发更新，我们来实现一下吧</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">trigger</span>(<span class="params">target, key</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> depsMap = targetMap.<span class="title function_">get</span>(target);</span><br><span class="line">  <span class="keyword">if</span> (!depsMap) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> dep = depsMap.<span class="title function_">get</span>(key);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (dep) &#123;</span><br><span class="line">    dep.<span class="title function_">forEach</span>(<span class="function">(<span class="params">effect</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">effect</span>();</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>最后添加到 hander 的 set 和 deleteProperty 中</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">set</span>(<span class="params">target, key, value, receiver</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (oldValue !== value) &#123;</span><br><span class="line">        result = <span class="title class_">Reflect</span>.<span class="title function_">set</span>(target, key, value, receiver)</span><br><span class="line">        <span class="title function_">trigger</span>(target, key)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line"><span class="title function_">deleteProperty</span>(<span class="params">target, key</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (hadKey &amp;&amp; result) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="title function_">trigger</span>(target, key)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ref"><a href="#ref" class="headerlink" title="ref"></a>ref</h2><p>把一个基础类型包装成一个有 value 响应式对象（这里是使用<code>get/set</code> 存取器，来进行追踪和触发），如果是普通对象就调用 reactive 来创建响应式对象</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">convert</span> = val =&gt; (<span class="title function_">isObject</span>(val) ? <span class="title function_">reactive</span>(val) : val)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RefImpl</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">_rawValue</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.\_rawValue = \_rawValue</span><br><span class="line">        <span class="variable language_">this</span>.\_\_v\_isRef = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="variable language_">this</span>.\_value = <span class="title function_">convert</span>(\_rawValue)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">get</span> <span class="title function_">value</span>() &#123;</span><br><span class="line"></span><br><span class="line">        <span class="title function_">track</span>(<span class="variable language_">this</span>, <span class="string">&#x27;value&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">_value</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">set</span> <span class="title function_">value</span>(<span class="params">newValue</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (newValue !== <span class="variable language_">this</span>.<span class="property">_value</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">_rawValue</span> = newValue</span><br><span class="line"></span><br><span class="line">            <span class="variable language_">this</span>.\_value = <span class="title function_">convert</span>(<span class="variable language_">this</span>.\_rawValue)</span><br><span class="line"></span><br><span class="line">            <span class="title function_">trigger</span>(<span class="variable language_">this</span>, <span class="string">&#x27;value&#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">ref</span>(<span class="params">rawValue</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isObject</span>(rawValue) &amp;&amp; rawValue.\_\_v\_isRef) <span class="keyword">return</span> rawValue</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RefImpl</span>(rawValue)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="toRef"><a href="#toRef" class="headerlink" title="toRef"></a>toRef</h2><blockquote>
<p><code>toRef</code>传入两个参数，<strong>目标对象</strong>，<strong>对象当中的属性名</strong>，它的返回结果就是<strong>属性名</strong>的可响应式数据，就是将对象中的某个值转化为响应式数据 toRef(obj,key)</p>
<p>那么简单来实现一下</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ObjectRefImpl</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">proxy, _key</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">_proxy</span> = proxy</span><br><span class="line">        <span class="variable language_">this</span>.\_key = \_key</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">this</span>.\_\_v\_isRef = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">get</span> <span class="title function_">value</span>() &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.\_proxy\[<span class="variable language_">this</span>.\_key\]</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">set</span> <span class="title function_">value</span>(<span class="params">newVal</span>) &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="variable language_">this</span>.\_proxy\[<span class="variable language_">this</span>.\_key\] = newVal</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">toRef</span>(<span class="params">proxy, key</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ObjectRefImpl</span>(proxy, key)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>测试</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; ref, effect, toRef, reactive &#125; <span class="keyword">from</span> <span class="string">&quot;../src/reactive.js&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> obj = <span class="title function_">reactive</span>(&#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&quot;小浪&quot;</span>,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">const</span> age = <span class="title function_">toRef</span>(obj, <span class="string">&quot;age&quot;</span>);</span><br><span class="line">age.<span class="property">value</span> = <span class="number">21</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(obj);</span><br><span class="line"><span class="title function_">effect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  age.<span class="property">value</span> = <span class="number">22</span>;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(obj);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>原来的 obj 对象没有 age 属性，使用 toRef 添加了 age， 并且是响应式的</p>
</blockquote>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ee07b1e766e64986b287d07acffb96e3~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?" alt="image.png"></p>
<blockquote>
<p><strong>区别于 ref:</strong></p>
</blockquote>
<p>ref 是对原始数据的拷贝，当修改 ref 数据时，模板中的视图会发生改变，但是原始数据并不会改变。 toRef 是对原始数据的引用，修改 toRef 数据时，原始数据也会发生改变，但是视图并不会更新。</p>
<h2 id="toRefs"><a href="#toRefs" class="headerlink" title="toRefs"></a>toRefs</h2><blockquote>
<p>想必这个大家经常使用吧，平时如果使用 reactive 创建对象，我们不能直接进行解构，我们要使用 toRefs 帮助我们进行解构， 把整个 reactive 创建的对象变成 普通对象， 然后把每个属性变成 ref 响应式对象。那么直接上手写一下吧， 其实它的核心还是使用了 toRef</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">toRefs</span>(<span class="params">proxy</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> ret = proxy <span class="keyword">instanceof</span> <span class="title class_">Array</span> ? <span class="keyword">new</span> <span class="title class_">Array</span>(proxy.<span class="property">length</span>) : &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> proxy) &#123;</span><br><span class="line"></span><br><span class="line">        ret\[key\] = <span class="title function_">toRef</span>(proxy, key)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>测试</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; reactive, toRefs &#125; <span class="keyword">from</span> <span class="string">&quot;../src/reactive.js&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> obj = <span class="title function_">reactive</span>(&#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&quot;小浪&quot;</span>,</span><br><span class="line">  <span class="attr">age</span>: <span class="number">22</span>,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; name, age &#125; = <span class="title function_">toRefs</span>(obj);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(obj);</span><br><span class="line">name.<span class="property">value</span> = <span class="string">&quot;小云&quot;</span>;</span><br><span class="line">age.<span class="property">value</span> = <span class="number">21</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(obj);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>测试成功，toRefs 解构后的属性也是响应式</p>
</blockquote>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bd0857b0aa1341b590f7632cdeed8e64~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?" alt="image.png"></p>
<h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><p><a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2FLianTianNo1%2Fvue3_reactive_demo" title="https://github.com/LianTianNo1/vue3_reactive_demo">github</a></p>
<blockquote>
<p>结语: 身边的小伙伴们都在准备秋招，这段时间除了实习之外的时间我也在慢慢准备，好久没更文了，感谢大家一直以来对小浪的支持，继续加油努力学习！！！</p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://liantianno1.github.io/xiaolangwiki/2022/07/23/35/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/xiaolangwiki/images/avatar.png">
      <meta itemprop="name" content="小浪wiki">
      <meta itemprop="description" content="一个关于编程、计算机、软件工程、互联网的知识库。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小浪wiki">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/xiaolangwiki/2022/07/23/35/" class="post-title-link" itemprop="url">解密10x程序员的思考方式:一个大三学生的领悟</a>
        </h2>

        <div class="post-meta">
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-07-23 12:39:35" itemprop="dateCreated datePublished" datetime="2022-07-23T12:39:35+08:00">2022-07-23</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/xiaolangwiki/categories/%E6%80%9D%E8%80%83/" itemprop="url" rel="index"><span itemprop="name">思考</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="解密10x程序员的思考方式-一个大三学生的领悟"><a href="#解密10x程序员的思考方式-一个大三学生的领悟" class="headerlink" title="解密10x程序员的思考方式:一个大三学生的领悟"></a>解密10x程序员的思考方式:一个大三学生的领悟</h1><p>大家好,我是一名大三的计算机系学生。最近,我在实习中遇到了一位被同事们称为”10x程序员”的大神。这让我开始思考:到底什么是10x程序员?他们是如何思考的?经过一段时间的观察和学习,我有了一些新的认识,今天就和大家分享一下。</p>
<p>首先,我们得搞清楚什么是10x程序员。简单来说,就是能够创造10倍于普通程序员价值的超级开发者。但这并不意味着他们要比别人多写10倍的代码,而是他们的思考方式和解决问题的能力远超常人。</p>
<p>那么,这些10x程序员是如何思考的呢?</p>
<ol>
<li>系统化思考:降低偶然复杂度</li>
</ol>
<p>记得有一次,我们团队接到一个看似简单的需求:给APP添加一个新的功能按钮。大多数人二话不说就开始coding了,但是我们团队的10x大神却先停下来思考。他说:”等等,我们先来分析一下这个需求背后的真正目的。”</p>
<p>他提出了一个通用的思考框架:</p>
<ul>
<li>第一步:确定现状</li>
<li>第二步:明确目标</li>
<li>第三步:制定实现路径</li>
</ul>
<p>这个框架看似简单,但却能帮助我们快速理清思路,避免陷入不必要的复杂性中。</p>
<ol>
<li>明确真实目标</li>
</ol>
<p>大神并不满足于表面的需求描述。他开始追问产品经理:”这个新功能的真正目标是什么?我们要解决用户的什么痛点?有没有其他方式可以更好地达成这个目标?”</p>
<p>这些问题让我意识到,作为程序员,我们不应该只是一个代码搬运工。我们需要深入理解需求背后的真实目标,这样才能提供最优解决方案。</p>
<ol>
<li>任务分解</li>
</ol>
<p>确定了目标后,大神开始将整个任务分解成小块。他说:”把大象放进冰箱需要三步,我们也要把复杂的任务拆解成可管理的小任务。”</p>
<p>这种方法不仅让整个开发过程变得清晰可控,也方便了团队协作和进度跟踪。</p>
<ol>
<li>加强沟通反馈</li>
</ol>
<p>在开发过程中,大神特别强调沟通的重要性。他经常组织简短的站会,确保每个人都清楚自己的任务和整个项目的进展。</p>
<p>他说:”代码是写给人看的,顺便能在机器上运行。”这句话让我明白了,良好的沟通不仅能提高开发效率,还能降低代码的维护成本。</p>
<ol>
<li>实现自动化</li>
</ol>
<p>最让我惊讶的是,大神总能在短时间内完成看似不可能的任务。他的秘诀就是:自动化。</p>
<p>从代码部署到测试,他都尽可能地实现自动化。他说:”重复的工作交给机器,我们的大脑应该专注于创造性的思考。”</p>
<p>这让我想起了自己曾经熬夜手动部署代码的经历,顿时感觉自己还有很长的路要走。</p>
<ol>
<li>持续学习和反思</li>
</ol>
<p>大神总是在学习新东西。无论是新的编程语言,还是最新的技术趋势,他都保持着强烈的好奇心。</p>
<p>他经常说:”在这个行业,如果你觉得自己已经够厉害了,那就意味着你已经开始落后了。”</p>
<p>这句话深深地触动了我。作为一个即将毕业的学生,我更应该保持学习的热情,不断提升自己。</p>
<p>结语:</p>
<p>通过观察和学习10x程序员的思考方式,我意识到成为一个优秀的程序员不仅仅是技术问题,更重要的是思维方式的转变。</p>
<p>系统化思考、明确目标、任务分解、加强沟通、实现自动化、持续学习,这些原则不仅适用于编程,也适用于我们的学习和生活。</p>
<p>作为一个即将步入职场的准程序员,我决定从现在开始就培养这种思考方式。也许我现在还不是10x程序员,但我相信只要坚持这种思维模式,终有一天我也能成为别人眼中的”大神”。<br>最后,祝大家都能成为10x程序员!</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://liantianno1.github.io/xiaolangwiki/2022/05/22/26/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/xiaolangwiki/images/avatar.png">
      <meta itemprop="name" content="小浪wiki">
      <meta itemprop="description" content="一个关于编程、计算机、软件工程、互联网的知识库。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小浪wiki">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/xiaolangwiki/2022/05/22/26/" class="post-title-link" itemprop="url">手把手教你在Webpack写一个Loader</a>
        </h2>

        <div class="post-meta">
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-05-22 08:14:26" itemprop="dateCreated datePublished" datetime="2022-05-22T08:14:26+08:00">2022-05-22</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/xiaolangwiki/categories/%E5%89%8D%E7%AB%AF/" itemprop="url" rel="index"><span itemprop="name">前端</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="手把手教你在-Webpack-写一个-Loader"><a href="#手把手教你在-Webpack-写一个-Loader" class="headerlink" title="手把手教你在 Webpack 写一个 Loader"></a>手把手教你在 Webpack 写一个 Loader</h2><p>原文：<a target="_blank" rel="noopener" href="https://juejin.cn/post/7100534685134454815">https://juejin.cn/post/7100534685134454815</a></p>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>有的时候，你可能在从零搭建 <code>Webpack</code> 项目很熟悉，配置过各种 <code>loader</code> ,面试官在 <code>Webpack</code> 方面问你，是否自己实现过一个<code>loader</code>?如果没有去了解过如果去实现，确实有点尴尬，其实呢，<code>loader</code>实现其实很简单的。下面说下<code>loader</code>是什么？</p>
<h3 id="为什么需要-Loader"><a href="#为什么需要-Loader" class="headerlink" title="为什么需要 Loader?"></a>为什么需要 Loader?</h3><blockquote>
<p><code>Webpack</code> 它只能处理 <code>js</code> 和 <code>JSON</code> 文件。面对 <code>css</code> 文件还有一些图片等等，<code>Webpack</code> 它自己是不能够处理的，它需要<code>loader</code> 处理其他类型的文件并将它们转换为有效的模块以供应用程序使用并添加到依赖关系图中，</p>
</blockquote>
<h3 id="Loader-是什么？"><a href="#Loader-是什么？" class="headerlink" title="Loader 是什么？"></a>Loader 是什么？</h3><blockquote>
<p><code>loader</code>本质上是一个<code>node</code>模块，符合<code>Webpack</code>中一切皆模块的思想。由于它是一个 <code>node</code> 模块，它必须导出一些东西。<code>loader</code>本身就是一个函数，在该函数中对接收到的内容进行转换，然后返回转换后的结果</p>
</blockquote>
<p>下面小浪为你简单介绍下<code>webpack</code>中的<code>loader</code></p>
<h2 id="常见的-loader"><a href="#常见的-loader" class="headerlink" title="常见的 loader"></a>常见的 loader</h2><p>我们先来回顾下常见的 <code>Loader</code> 基础的配置和使用吧（仅仅只是常见的，<code>npm</code>上面开发者大佬们发布的太多了）</p>
<p>那么开始吧，首先先介绍 处理 <code>CSS</code> 相关的 <code>Loader</code></p>
<h3 id="css-loader-和-style-loader"><a href="#css-loader-和-style-loader" class="headerlink" title="css-loader 和 style-loader"></a>css-loader 和 style-loader</h3><blockquote>
<p>安装依赖</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install css-loader style-loader</span><br></pre></td></tr></table></figure>
<blockquote>
<p>使用加载器</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line"></span><br><span class="line">    <span class="attr">module</span>: &#123;</span><br><span class="line">        <span class="attr">rules</span>: \[&#123;</span><br><span class="line">            <span class="attr">test</span>: <span class="regexp">/\\.css$/</span>,</span><br><span class="line">            <span class="attr">use</span>: \[<span class="string">&#x27;style-loader&#x27;</span>, <span class="string">&#x27;css-loader&#x27;</span>\],</span><br><span class="line">        &#125;\],</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;；</span><br></pre></td></tr></table></figure>
<p>其中<code>module.rules</code>代表模块的处理规则。 每个规则可以包含很多配置项</p>
<p><code>test</code> 可以接收正则表达式或元素为正则表达式的数组。 只有与正则表达式匹配的模块才会使用此规则。 在此示例中，<code>/\\.css$/</code> 匹配所有以 <code>.css</code> 结尾的文件。</p>
<p><code>use</code> 可以接收一个包含规则使用的加载器的数组。 如果只配置了一个<code>css-loader</code>，当只有一个<code>loader</code>时也可以为字符串</p>
<p><code>css-loader</code> 的作用只是处理 <code>CSS</code> 的各种加载语法（<code>@import</code> 和 <code>url()</code> 函数等），如果样式要工作，则需要 <code>style-loader</code> 将样式插入页面</p>
<p><code>style-loader</code>加到了<code>css-loader</code>前面，这是因为在<code>Webpack</code>打包时是按照数组从后往前的顺序将资源交给<code>loader</code>处理的，因此要把最后生效的放在前面</p>
<blockquote>
<p>还可以这样写成对象的形式，里面<code>options</code>传入配置</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line"></span><br><span class="line">    <span class="attr">module</span>: &#123;</span><br><span class="line">        <span class="attr">rules</span>: \[&#123;</span><br><span class="line">            <span class="attr">test</span>: <span class="regexp">/\\.css$/</span>,</span><br><span class="line">            <span class="attr">use</span>: \[</span><br><span class="line">                <span class="string">&#x27;style-loader&#x27;</span>,</span><br><span class="line">                  &#123;</span><br><span class="line">                    <span class="attr">loader</span>: <span class="string">&#x27;css-loader&#x27;</span>,</span><br><span class="line">                    <span class="attr">options</span>: &#123;</span><br><span class="line"></span><br><span class="line">                	&#125;,</span><br><span class="line">            	  &#125;</span><br><span class="line">            \],</span><br><span class="line">        &#125;\],</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;；</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>exclude</code>与<code>include</code></p>
<p><code>include</code>代表该规则只对正则匹配到的模块生效</p>
<p><code>exclude</code>的含义是，所有被正则匹配到的模块都排除在该规则之外</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">rules</span>: \[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\\.css$/</span>,</span><br><span class="line">        <span class="attr">use</span>: \[<span class="string">&#x27;style-loader&#x27;</span>, <span class="string">&#x27;css-loader&#x27;</span>\],</span><br><span class="line">        <span class="attr">exclude</span>: <span class="regexp">/node_modules/</span>,</span><br><span class="line">        <span class="attr">include</span>: <span class="regexp">/src/</span>,</span><br><span class="line">    &#125;</span><br><span class="line">\],</span><br></pre></td></tr></table></figure>
<p>是否都还记得呢，现在有现成的脚手架，很多人都很少自己去配置这些了，欸~当然还有相关的 <code>sass/less</code>等等预处理器<code>loader</code>这里就不一一介绍了。</p>
<h3 id="babel-loader"><a href="#babel-loader" class="headerlink" title="babel-loader"></a>babel-loader</h3><p><code>babel-loader</code> 这个<code>loader</code>十分的重要，把高级语法转为<code>ES5</code>，常用于处理 <code>ES6+</code> 并将其编译为 <code>ES5</code>。 它允许我们在项目中使用最新的语言特性（甚至在提案中），而无需特别注意这些特性在不同平台上的兼容性。</p>
<blockquote>
<p>介绍下主要的三个模块</p>
</blockquote>
<ul>
<li>babel-loader：使 <code>Babel</code> 与 <code>Webpack</code> 一起工作的模块</li>
<li>@babel/core：<code>Babel</code>核心模块。</li>
<li>@babel/preset-env：是<code>Babel</code>官方推荐的<code>preseter</code>，可以根据用户设置的目标环境，自动添加编译<code>ES6+</code>代码所需的插件和补丁</li>
</ul>
<blockquote>
<p>安装</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install babel-loader @babel/core @babel/preset-env</span><br></pre></td></tr></table></figure>
<blockquote>
<p>配置</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">rules</span>: \[</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">test</span>: <span class="regexp">/\\.js$/</span>,</span><br><span class="line">    <span class="attr">exclude</span>: <span class="regexp">/node_modules/</span>,</span><br><span class="line">    <span class="attr">use</span>: &#123;</span><br><span class="line">      <span class="attr">loader</span>: <span class="string">&#x27;babel-loader&#x27;</span>,</span><br><span class="line">      <span class="attr">options</span>: &#123;</span><br><span class="line">        <span class="attr">cacheDirectory</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">presets</span>: \[\[</span><br><span class="line">          <span class="string">&#x27;env&#x27;</span>, &#123;</span><br><span class="line">            <span class="attr">modules</span>: <span class="literal">false</span>,</span><br><span class="line">          &#125;</span><br><span class="line">        \]\],</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line">\],</span><br></pre></td></tr></table></figure>
<h3 id="html-loader"><a href="#html-loader" class="headerlink" title="html-loader"></a>html-loader</h3><p><code>Webpack</code> 可不认识 <code>html</code>，直接报错，需要<code>loader</code>转化</p>
<p><code>html-loader</code> 用于将 <code>HTML</code> 文件转换为字符串并进行格式化，它允许我们通过 <code>JS</code> 加载一个 <code>HTML</code> 片段。</p>
<blockquote>
<p>安装</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install html-loader</span><br></pre></td></tr></table></figure>
<blockquote>
<p>配置</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">rules</span>: \[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\\.html$/</span>,</span><br><span class="line">        <span class="attr">use</span>: <span class="string">&#x27;html-loader&#x27;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">\],</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> otherHtml <span class="keyword">from</span> <span class="string">&quot;./other.html&quot;</span>;</span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">write</span>(otherHtml);</span><br></pre></td></tr></table></figure>
<p>这样你可以在 js 中加载另一个页面，写刀当前 index.html 里面</p>
<h3 id="file-loader"><a href="#file-loader" class="headerlink" title="file-loader"></a>file-loader</h3><p>用于打包文件类型的资源，比如对<code>png</code>、<code>jpg</code>、<code>gif</code>等图片资源使用<code>file-loader</code>，然后就可以在<code>JS</code>中加载图片了</p>
<blockquote>
<p>安装</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install file-loader</span><br></pre></td></tr></table></figure>
<blockquote>
<p>配置</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">    <span class="attr">entry</span>: <span class="string">&#x27;./index.js&#x27;</span>,</span><br><span class="line">    <span class="attr">output</span>: &#123;</span><br><span class="line">        <span class="attr">path</span>: path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;dist&#x27;</span>),</span><br><span class="line">        <span class="attr">filename</span>: <span class="string">&#x27;bundle.js&#x27;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">module</span>: &#123;</span><br><span class="line">        <span class="attr">rules</span>: \[</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">test</span>: <span class="regexp">/\\.(png|jpg|gif)$/</span>,</span><br><span class="line">                <span class="attr">use</span>: <span class="string">&#x27;file-loader&#x27;</span>,</span><br><span class="line">            &#125;</span><br><span class="line">        \],</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;；</span><br></pre></td></tr></table></figure>
<h3 id="url-loader"><a href="#url-loader" class="headerlink" title="url-loader"></a>url-loader</h3><p>既然介绍了 <code>file-loader</code> 就不得不介绍 <code>url-loader</code>，它们很相似，但是唯一的区别是用户可以设置文件大小阈值。 大于阈值时返回与<code>file-loader</code>相同的<code>publicPath</code>，小于阈值时返回文件<code>base64</code>编码。</p>
<blockquote>
<p>安装</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install url-loader</span><br></pre></td></tr></table></figure>
<blockquote>
<p>配置</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">rules</span>: \[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\\.(png|jpg|gif)$/</span>,</span><br><span class="line">        <span class="attr">use</span>: &#123;</span><br><span class="line">            <span class="attr">loader</span>: <span class="string">&#x27;url-loader&#x27;</span>,</span><br><span class="line">            <span class="attr">options</span>: &#123;</span><br><span class="line">                <span class="attr">limit</span>: <span class="number">1024</span>,</span><br><span class="line">                <span class="attr">name</span>: <span class="string">&#x27;\[name\].\[ext\]&#x27;</span>,</span><br><span class="line">                <span class="attr">publicPath</span>: <span class="string">&#x27;./assets/&#x27;</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">\],</span><br></pre></td></tr></table></figure>
<h3 id="ts-loader"><a href="#ts-loader" class="headerlink" title="ts-loader"></a>ts-loader</h3><p><code>TypeScript</code>使用得越来越多，对于我们平时写代码有了更好的规范，项目更加利于维护…等等好处，我们也在<code>Webpack</code>中来配置 loader,本质上类似于 <code>babel-loader</code>，是一个连接 <code>Webpack</code> 和 <code>Typescript</code> 的模块</p>
<blockquote>
<p>安装</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install ts-loader typescript</span><br></pre></td></tr></table></figure>
<blockquote>
<p>loader 配置，主要的配置还是在 <code>tsconfig.json</code> 中</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">rules</span>: \[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\\.ts$/</span>,</span><br><span class="line">        <span class="attr">use</span>: <span class="string">&#x27;ts-loader&#x27;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">\],</span><br></pre></td></tr></table></figure>
<h3 id="vue-loader"><a href="#vue-loader" class="headerlink" title="vue-loader"></a>vue-loader</h3><p>用来处理<code>vue</code>组件,还要安装<code>vue-template-compiler</code>来编译<code>Vue</code>模板，估计大家大部分都用脚手架了</p>
<blockquote>
<p>安装</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install vue-loader  vue-template-compiler</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">rules</span>: \[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\\.vue$/</span>,</span><br><span class="line">        <span class="attr">use</span>: <span class="string">&#x27;vue-loader&#x27;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">\],</span><br></pre></td></tr></table></figure>
<h2 id="写一个简单的-Loader"><a href="#写一个简单的-Loader" class="headerlink" title="写一个简单的 Loader"></a>写一个简单的 Loader</h2><p>介绍了几个常见的 loader 的安装配置，我们在具体的业务的实现的时候，可能遇到各种需求，上面介绍的或者 npm 上都没有的加载器都不适合当前的业务场景，那我们可以自己去实现一个自己的<code>loader</code>来满足自己的需求，小浪下面介绍一下如何自定义一个<code>loader</code></p>
<h3 id="1-初始化项目"><a href="#1-初始化项目" class="headerlink" title="1.初始化项目"></a>1.初始化项目</h3><blockquote>
<p>初始化项目</p>
</blockquote>
<p>先创建一个项目文件夹（名字可以随意，当然肯定是英文名）后进行初始化</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm init -y</span><br></pre></td></tr></table></figure>
<blockquote>
<p>安装依赖</p>
</blockquote>
<p>安装依赖： <code>Webpack</code> 和 <code>Webpack</code>脚手架 和 热更新服务器</p>
<p>不同的版本 <code>Webpack</code> 可能有些差异，如果你跟着我的这个例子写的话，小浪建议和我装一样的版本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install webpack@4.39.2 webpack-cli@3.3.6 webpack-dev-server@3.11.0 -D</span><br></pre></td></tr></table></figure>
<blockquote>
<p>新建一个<code>index.html</code>文件</p>
</blockquote>
<p><code>dist/index.html</code></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;zh-CN&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;ie=edge&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span><span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;./bundle.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>新建一个入口文件 <code>index.js</code> 文件</p>
</blockquote>
<p><code>src/index.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">document</span>.<span class="title function_">write</span>(<span class="string">&quot;hello world&quot;</span>);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>创建 <code>webpack.config.js</code> 配置文件</p>
</blockquote>
<p>配置出口和入口文件</p>
<p>配置<code>devServer</code>服务</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&quot;path&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">entry</span>: <span class="string">&quot;./src/index.js&quot;</span>,</span><br><span class="line">  <span class="attr">output</span>: &#123;</span><br><span class="line">    <span class="attr">path</span>: path.<span class="title function_">resolve</span>(__dirname, <span class="string">&quot;dist&quot;</span>),</span><br><span class="line">    <span class="attr">filename</span>: <span class="string">&quot;bundle.js&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">devServer</span>: &#123;</span><br><span class="line">    <span class="attr">contentBase</span>: <span class="string">&quot;./dist&quot;</span>,</span><br><span class="line">    <span class="attr">overlay</span>: &#123;</span><br><span class="line">      <span class="attr">warnings</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">errors</span>: <span class="literal">true</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">open</span>: <span class="literal">true</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>在 <code>package.json</code> 中配置启动命令</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;scripts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">   <span class="attr">&quot;dev&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Webpack-dev-server&quot;</span></span><br><span class="line"> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>启动 <code>npm run dev</code></p>
</blockquote>
<p><code>devServer</code>帮我们启动一个服务器，每次修改<code>index.js不</code>需要自己在去打包，而是自动帮我们完成这项任务</p>
<p>页面内容就是我们<code>index.js</code>编写的内容被打包成在<code>dist/bundle.js</code>引入到<code>index.html</code>了</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/da2abd89712944d6a81877f7af8a6d54~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?" alt="image.png"></p>
<blockquote>
<p>当前的文件目录</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Webpack-demo</span><br><span class="line"> ├── dist</span><br><span class="line"> │   └── index.html</span><br><span class="line"> ├── package-lock.json</span><br><span class="line"> ├── package.json</span><br><span class="line"> ├── src</span><br><span class="line"> │   └── index.js</span><br><span class="line"> └── Webpack.config.js</span><br></pre></td></tr></table></figure>
<h3 id="2-实现一个简单的-loader"><a href="#2-实现一个简单的-loader" class="headerlink" title="2.实现一个简单的 loader"></a>2.实现一个简单的 loader</h3><blockquote>
<p>在 <code>src/MyLoader/my-loader.js</code></p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">function</span> (<span class="params">source</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> source.<span class="title function_">replace</span>(<span class="string">&quot;world&quot;</span>, <span class="string">&quot;, I am Xiaolang&quot;</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>返回其它结果 <code>this.callback</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">this</span>.<span class="title function_">callback</span>(</span><br><span class="line"></span><br><span class="line">    <span class="attr">err</span>: <span class="title class_">Error</span> | <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">    <span class="attr">content</span>: string | <span class="title class_">Buffer</span>,</span><br><span class="line"></span><br><span class="line">    sourceMap?: <span class="title class_">SourceMap</span>,</span><br><span class="line"></span><br><span class="line">    abstractSyntaxTree?: <span class="variable constant_">AST</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>打开代码对应的<code>source-map</code>，方便调试源代码。<code>source-map</code> 可以方便实际开发者在浏览器控制台查看源代码。 如果不处理<code>source-map</code>，最终将无法生成正确的<code>map</code>文件，在浏览器的开发工具中可能会看到混乱的源代码。</p>
<p>为了在使用 <code>this.callback</code> 返回内容时将 <code>source-map</code> 返回给 <code>Webpack</code></p>
<p><code>loader</code> 必须返回 <code>undefined</code> 让 <code>Webpack</code> 知道 <code>loader</code> 返回的结果在 <code>this.callback</code> 中，而不是在 <code>return</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">function</span> (<span class="params">source, sourceMaps</span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">callback</span>(<span class="literal">null</span>, source.<span class="title function_">replace</span>(<span class="string">&quot;world&quot;</span>, <span class="string">&quot;, I am Xiaolang&quot;</span>), sourceMaps);</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>常用加载本地 <code>loader</code> 两种方式</p>
</blockquote>
<p>1.<code>path.resolve</code></p>
<p>使用 <code>path.resolve</code> 指向这个本地文件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">    <span class="attr">module</span>: &#123;</span><br><span class="line">        <span class="attr">rules</span>: \[</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">test</span>: <span class="regexp">/\\.js$/</span>,</span><br><span class="line">                <span class="attr">use</span>: path.<span class="title function_">resolve</span>(<span class="string">&#x27;./src/myLoader/my-loader.js&#x27;</span>),</span><br><span class="line">            &#125;,</span><br><span class="line">        \],</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2.<code>ResolveLoader</code></p>
<p>先去 <code>node_modules</code> 项目下寻找 <code>my-loader</code>，如果找不到，会再去 <code>./src/myLoader/</code> 目录下寻找。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line"></span><br><span class="line">    <span class="attr">module</span>: &#123;</span><br><span class="line">        <span class="attr">rules</span>: \[</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">test</span>: <span class="regexp">/\\.js$/</span>,</span><br><span class="line">                <span class="attr">use</span>: \[<span class="string">&#x27;my-loader&#x27;</span>\],</span><br><span class="line">            &#125;,</span><br><span class="line">        \],</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">resolveLoader</span>: &#123;</span><br><span class="line">        <span class="attr">modules</span>: \[<span class="string">&#x27;node_modules&#x27;</span>, <span class="string">&#x27;./src/myLoader&#x27;</span>\],</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一个 <code>loader</code>的职责是单一的，使每个<code>loader</code>易维护。</p>
<p>如果源文件需要分多步转换才能正常使用，通过多个 Loader 进行转换。当调用多个<code>loader</code>进行文件转换时，每个<code>loader</code>都会链式执行。</p>
<p>第一个<code>loader</code>会得到要处理的原始内容，将前一个 loader 处理的结果传递给下一个。 处理完毕，最终的 Loader 会将处理后的最终结果返回给 <code>Webpack</code></p>
<p>所以，当你写<code>loader</code>记得保持它的职责单一，你只关心输入和输出。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/96657df8c0484e4b9c915bbbb58fed5c~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp" alt="image-20220522142823507"></p>
<h3 id="3-option参数"><a href="#3-option参数" class="headerlink" title="3.option参数"></a>3.<code>option</code>参数</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">module</span>: &#123;</span><br><span class="line">    <span class="attr">rules</span>: \[</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">test</span>: <span class="regexp">/\\.js$/</span>,</span><br><span class="line">            <span class="attr">use</span>: \[</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">loader</span>: <span class="string">&#x27;my-loader&#x27;</span>,</span><br><span class="line">                    <span class="attr">options</span>: &#123;</span><br><span class="line">                        <span class="attr">flag</span>: <span class="literal">true</span>,</span><br><span class="line">                    &#125;,</span><br><span class="line">                &#125;,</span><br><span class="line">            \],</span><br><span class="line">        &#125;,</span><br><span class="line">    \],</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p>那么我们如何在 loader 中获取这个写入配置信息呢？</p>
<p><code>Webpack</code> 提供了<code>loader-utils</code>工具</p>
<blockquote>
<p>在之前写的 loader 修改</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> loaderUtils = <span class="built_in">require</span>(<span class="string">&quot;loader-utils&quot;</span>);</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">function</span> (<span class="params">source</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> options = loaderUtils.<span class="title function_">getOptions</span>(<span class="variable language_">this</span>);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;options--&gt;&quot;</span>, options);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> source.<span class="title function_">replace</span>(<span class="string">&quot;world&quot;</span>, <span class="string">&quot;, I am Xiaolang&quot;</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>控制台也打印了出来</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3ff214671bba483da8487233a4c70357~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp" alt="image-20220522143828316"></p>
<h3 id="4-缓存"><a href="#4-缓存" class="headerlink" title="4.缓存"></a>4.缓存</h3><p>如果为每个构建重新执行重复的转换操作，这样<code>Webpack</code>构建可能会变得非常慢。</p>
<p><code>Webpack</code> 默认会缓存所有<code>loader</code>的处理结果，也就是说，当待处理的文件或者依赖的文件没有变化时，不会再次调用对应的<code>loader</code>进行转换操作</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">function</span> (<span class="params">source</span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">cacheable</span> &amp;&amp; <span class="variable language_">this</span>.<span class="title function_">cacheable</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> source.<span class="title function_">replace</span>(<span class="string">&quot;world&quot;</span>, <span class="string">&quot;, I am Xiaolang&quot;</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>一般默认开启缓存，如果不想<code>Webpack</code>这个<code>loader</code>进行缓存，也可以关闭缓存</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">function</span> (<span class="params">source</span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">cacheable</span>(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> source.<span class="title function_">replace</span>(<span class="string">&quot;world&quot;</span>, <span class="string">&quot;, I am Xiaolang&quot;</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="5-同步与异步"><a href="#5-同步与异步" class="headerlink" title="5.同步与异步"></a>5.同步与异步</h3><p>在某些情况下，转换步骤只能异步完成。</p>
<p>例如，您需要发出网络请求以获取结果。 如果使用同步方式，网络请求会阻塞整个构建，导致构建非常缓慢。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">function</span> (<span class="params">source</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> callback = <span class="variable language_">this</span>.<span class="title function_">async</span>();</span><br><span class="line"></span><br><span class="line">  <span class="title function_">someAsyncOperation</span>(source, <span class="keyword">function</span> (<span class="params">err, result, sourceMaps, ast</span>) &#123;</span><br><span class="line">    <span class="title function_">callback</span>(err, result, sourceMaps, ast);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="6-处理二进制数据"><a href="#6-处理二进制数据" class="headerlink" title="6.处理二进制数据"></a>6.处理二进制数据</h3><p>默认情况下，<code>Webpack</code> 传递给 <code>Loader</code> 的原始内容是一个 <code>UTF-8</code> 格式编码的字符串。 但是在某些场景下，加载器处理的不是文本文件，而是二进制文件</p>
<p>官网例子 通过 <code>exports.raw</code> 属性告诉 <code>Webpack</code> 该 <code>Loader</code> 是否需要二进制数据</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">function</span> (<span class="params">source</span>) &#123;</span><br><span class="line">  source <span class="keyword">instanceof</span> <span class="title class_">Buffer</span> === <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> source;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span>.<span class="property">raw</span> = <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>
<h3 id="7-实现一个渲染-markdown-文档-loader"><a href="#7-实现一个渲染-markdown-文档-loader" class="headerlink" title="7.实现一个渲染 markdown 文档 loader"></a>7.实现一个渲染 markdown 文档 loader</h3><blockquote>
<p>安装依赖 <code>md</code> 转 <code>html</code> 的依赖，当然可以选择另外一个模块 <code>marked</code></p>
<p>我这里使用的 <code>markdown-it</code></p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install markdown-it@12.0.6 -D</span><br></pre></td></tr></table></figure>
<blockquote>
<p>辅助工具 用来添加 <code>div</code> 和 <code>class</code></p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">function</span> <span class="title function_">ModifyStructure</span>(<span class="params">html</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> htmlList = html</span><br><span class="line">    .<span class="title function_">replace</span>(<span class="regexp">/&lt;h3/g</span>, <span class="string">&quot;$*(&lt;h3&quot;</span>)</span><br><span class="line">    .<span class="title function_">replace</span>(<span class="regexp">/&lt;h2/g</span>, <span class="string">&quot;$*(&lt;h2&quot;</span>)</span><br><span class="line">    .<span class="title function_">split</span>(<span class="string">&quot;$*(&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> htmlList</span><br><span class="line">    .<span class="title function_">map</span>(<span class="function">(<span class="params">item</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (item.<span class="title function_">indexOf</span>(<span class="string">&quot;&lt;h3&quot;</span>) !== -<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">`&lt;div class=&quot;card card-3&quot;&gt;<span class="subst">$&#123;item&#125;</span>&lt;/div&gt;`</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (item.<span class="title function_">indexOf</span>(<span class="string">&quot;&lt;h2&quot;</span>) !== -<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">`&lt;div class=&quot;card card-2&quot;&gt;<span class="subst">$&#123;item&#125;</span>&lt;/div&gt;`</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> item;</span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">join</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>新建一个 loader</p>
</blockquote>
<p><code>/src/myLoader/md-loader.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; getOptions &#125; = <span class="built_in">require</span>(<span class="string">&#x27;loader-utils&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">MarkdownIt</span> = <span class="built_in">require</span>(<span class="string">&#x27;markdown-it&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> beautify = <span class="built_in">require</span>(<span class="string">&#x27;./beautify&#x27;</span>)</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">function</span> (<span class="params">source</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> options = <span class="title function_">getOptions</span>(<span class="variable language_">this</span>) || &#123;&#125;</span><br><span class="line">    <span class="keyword">const</span> md = <span class="keyword">new</span> <span class="title class_">MarkdownIt</span>(&#123;</span><br><span class="line">        <span class="attr">html</span>: <span class="literal">true</span>,</span><br><span class="line">        ...options,</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">let</span> html = <span class="title function_">beautify</span>(md.<span class="title function_">render</span>(source))</span><br><span class="line">    html = \<span class="string">`module.exports = <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(html)&#125;</span>\`</span></span><br><span class="line"><span class="string">    this.callback(null, html)</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>
<p>这样<code>loader</code>也写完了，<code>this.callback(null, html)</code> 和 <code>return</code> 在这里差不多哈。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">html = \<span class="string">`module.exports = <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(html)&#125;</span>\`</span></span><br></pre></td></tr></table></figure>
<p>这里解析的结果是一个 <code>HTML</code> 字符串。 如果直接返回，也会面临<code>Webpack</code>无法解析模块的问题。 正确的做法是把这个<code>HTML</code>字符串拼接成一段<code>JS</code>代码。</p>
<p>这时候我们要返回的代码就是通过<code>module.exports</code>导出这个<code>HTML</code>字符串，这样外界在导入模块的时候就可以接收到这个<code>HTML</code>字符串。</p>
<blockquote>
<p>然后在<code>webpack.config.js</code>使用这个加载器</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">    <span class="attr">entry</span>: <span class="string">&#x27;./src/index.js&#x27;</span>,</span><br><span class="line">    <span class="attr">output</span>: &#123;</span><br><span class="line">        <span class="attr">path</span>: path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;dist&#x27;</span>),</span><br><span class="line">        <span class="attr">filename</span>: <span class="string">&#x27;bundle.js&#x27;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">module</span>: &#123;</span><br><span class="line">        <span class="attr">rules</span>: \[</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">test</span>: <span class="regexp">/\\.js$/</span>,</span><br><span class="line">                <span class="attr">use</span>: \[</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">loader</span>: <span class="string">&#x27;my-loader&#x27;</span>,</span><br><span class="line">                        <span class="attr">options</span>: &#123;</span><br><span class="line">                            <span class="attr">flag</span>: <span class="literal">true</span>,</span><br><span class="line">                        &#125;,</span><br><span class="line">                    &#125;,</span><br><span class="line">                \],</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">test</span>: <span class="regexp">/\\.md$/</span>,</span><br><span class="line">                <span class="attr">use</span>: \[</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">loader</span>: <span class="string">&#x27;md-loader&#x27;</span>,</span><br><span class="line">                    &#125;,</span><br><span class="line">                \],</span><br><span class="line">            &#125;,</span><br><span class="line">        \],</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">resolveLoader</span>: &#123;</span><br><span class="line">        <span class="attr">modules</span>: \[<span class="string">&#x27;node_modules&#x27;</span>, <span class="string">&#x27;./src/myLoader&#x27;</span>\],</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">devServer</span>: &#123;</span><br><span class="line">        <span class="attr">contentBase</span>: <span class="string">&#x27;./dist&#x27;</span>,</span><br><span class="line">        <span class="attr">overlay</span>: &#123;</span><br><span class="line">            <span class="attr">warnings</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">errors</span>: <span class="literal">true</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">open</span>: <span class="literal">true</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>使用</p>
<p>最后在<code>index.js</code>中加载一个<code>md</code>文件，我这里随便整个，新建<code>github</code>的<code>readme.md</code></p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">document</span>.<span class="title function_">write</span>(<span class="string">&quot;hello world&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> mdHtml <span class="keyword">from</span> <span class="string">&quot;./test.md&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> content = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&quot;div&quot;</span>);</span><br><span class="line">content.<span class="property">className</span> = <span class="string">&quot;content&quot;</span>;</span><br><span class="line">content.<span class="property">innerHTML</span> = mdHtml;</span><br><span class="line"><span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(content);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>结果图</p>
</blockquote>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9a4ced26d90c4fb0b91e484856af5019~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp" alt="image-20220522165928553"></p>
<blockquote>
<p>目录结构</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Webpack-demo</span><br><span class="line"> ├── dist</span><br><span class="line"> │   └── index.html</span><br><span class="line"> ├── package-lock.json</span><br><span class="line"> ├── package.json</span><br><span class="line"> ├── src</span><br><span class="line"> │   ├── index.js</span><br><span class="line"> │   ├── myLoader</span><br><span class="line"> │   │   ├── beautify.js</span><br><span class="line"> │   │   ├── md-loader.js</span><br><span class="line"> │   │   └── my-loader.js</span><br><span class="line"> │   └── test.md</span><br><span class="line"> └── webpack.config.js</span><br></pre></td></tr></table></figure>
<blockquote>
<p><a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2FLianTianNo1%2Fwebpack-loader-demo" title="https://github.com/LianTianNo1/webpack-loader-demo">github 仓库地址</a></p>
</blockquote>
<h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>感谢大家能看到这里哈~ ，现在打包构建工具也慢慢增多了<code>vue-cli</code>，<code>vite</code>等等，但是 <code>webpack</code> 仍然有一席之地，很多值得学习的地方，继续努力学习~~</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://liantianno1.github.io/xiaolangwiki/2022/02/18/11/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/xiaolangwiki/images/avatar.png">
      <meta itemprop="name" content="小浪wiki">
      <meta itemprop="description" content="一个关于编程、计算机、软件工程、互联网的知识库。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小浪wiki">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/xiaolangwiki/2022/02/18/11/" class="post-title-link" itemprop="url">程序员效率大挑战：别让"偶然复杂度"坑了你！</a>
        </h2>

        <div class="post-meta">
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-02-18 06:12:11" itemprop="dateCreated datePublished" datetime="2022-02-18T06:12:11+08:00">2022-02-18</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/xiaolangwiki/categories/%E6%80%9D%E8%80%83/" itemprop="url" rel="index"><span itemprop="name">思考</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="程序员效率大挑战：别让”偶然复杂度”坑了你！"><a href="#程序员效率大挑战：别让”偶然复杂度”坑了你！" class="headerlink" title="程序员效率大挑战：别让”偶然复杂度”坑了你！"></a>程序员效率大挑战：别让”偶然复杂度”坑了你！</h1><p>嘿，大家好！我是一名22岁的大三计算机系学生，最近读到了一篇超级有意思的文章，讲的是程序员工作效率的问题。说实话，这篇文章真的让我有点震惊，也让我对未来的程序员生涯有了新的认识。我想跟大家分享一下我的想法，希望能给同样即将踏入IT圈的小伙伴们一些启发。</p>
<p>首先，这篇文章提到了一个叫”偶然复杂度”的概念。说白了，就是我们程序员经常忙得要死要活，结果解决的问题根本不是程序本身的问题，而是因为选错了工具或方法导致的额外麻烦。我当时就想，我靠，这不就是在搬起石头砸自己的脚吗？</p>
<p>想想看，我们每天加班加点，以为自己在攻克什么技术难关，结果可能只是在解决自己制造的问题。这就好比你本来要做一道简单的炒饭，结果非要用高压锅，搞得自己手忙脚乱，最后还把厨房炸了（别笑，我室友就干过这种事）。</p>
<p>文章里还说，业界其实有很多提高效率的最佳实践，但问题是这些实践之间没什么明显联系，搞得人很难全面掌握。我听了直呼太真实了！想想我们上课学的那些编程范式、设计模式、敏捷开发…老师讲的时候头头是道，到了实际项目里，我就傻眼了，根本不知道该怎么用。</p>
<p>不过，这篇文章的作者也不是光吐槽，人家给出了四个超实用的原则：以终为始、任务分解、沟通反馈、自动化。乍一看，这四个原则简单得像是小学生都懂的道理。但仔细想想，在实际工作中做到这些，还真不容易。</p>
<p>拿”以终为始”来说吧。我在做课程项目的时候，经常是看到题目就开始狂敲代码，结果写到一半发现理解错题目意思，白忙活一场。如果一开始就花点时间想清楚最终要达到什么效果，再倒推着设计每一步，肯定能少走不少弯路。</p>
<p>“任务分解”这个我倒是有点体会。我大一刚入学的时候，就被老师教导过，要把一个大项目分解成多个小任务，然后每个人负责一个任务。结果我当时就被教导得头头是道，觉得这可真是一件很有意思的事情。后来我参加过一个学校项目，光是看项目描述就觉得头大。但是项目负责人特别厉害，把整个项目分解成一个个小任务，分配给不同班级的学生。结果我们这群素未谋面的人，愣是合作得挺顺畅。</p>
<p>至于”沟通反馈”和”自动化”，老实说，在学校里接触得不多。但我暑假实习的时候，可算是见识到了它们的威力。经常沟通真的能避免很多不必要的返工，而自动化测试和部署，简直是懒人福音啊！要是早点学会这些，指不定我的期末项目能少掉几根头发呢。</p>
<p>不过，文章里也说了，这些原则看着简单，做起来可不容易。比如说，在项目一开始就花大力气做规划和自动化，总觉得是在浪费时间。但是经历过几次”补漏洞”的痛苦之后，我才明白，早做准备真的能省下后面的不少事。</p>
<p>作为一个马上就要进入职场的准程序员，这篇文章给了我一记当头棒喝。它让我意识到，成为一个牛逼的程序员，不只是要会写代码，更重要的是要学会高效工作。我们得学会避开那些自己给自己设的坑，把精力花在真正有价值的问题上。</p>
<p>所以，咱们以后写代码的时候，可得擦亮眼睛啊！别让那个什么”偶然复杂度”把咱们坑了。让我们一起努力，用聪明的方式工作，创造出真正牛逼的软件，改变这个世界！</p>
<p>好了，我的碎碎念就到这里。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://liantianno1.github.io/xiaolangwiki/2022/02/16/14/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/xiaolangwiki/images/avatar.png">
      <meta itemprop="name" content="小浪wiki">
      <meta itemprop="description" content="一个关于编程、计算机、软件工程、互联网的知识库。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小浪wiki">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/xiaolangwiki/2022/02/16/14/" class="post-title-link" itemprop="url">React 无缝滚动跑马灯组件</a>
        </h2>

        <div class="post-meta">
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-02-16 10:16:14" itemprop="dateCreated datePublished" datetime="2022-02-16T10:16:14+08:00">2022-02-16</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/xiaolangwiki/categories/%E5%89%8D%E7%AB%AF/" itemprop="url" rel="index"><span itemprop="name">前端</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="React-无缝滚动跑马灯组件"><a href="#React-无缝滚动跑马灯组件" class="headerlink" title="React 无缝滚动跑马灯组件"></a>React 无缝滚动跑马灯组件</h2><p>最近在做一个电商平台的项目，其中一个需求是在首页顶部展示一些重要的通知公告，比如物流赔付信息、促销活动预告等。为了吸引用户的注意力，UI决定采用跑马灯的形式来展示这些信息，并且要实现无缝滚动，避免出现停顿或跳跃的视觉效果。</p>
<p>由于公司老项目限制，我们没有采用现成的轮播图组件，于是决定自己动手开发一个 React 无缝滚动跑马灯组件。</p>
<h3 id="需求分析"><a href="#需求分析" class="headerlink" title="需求分析"></a>需求分析</h3><p>我们的跑马灯组件需要满足以下几个需求：</p>
<ol>
<li><strong>无缝滚动</strong>: 文案滚动流畅，首尾衔接自然，没有明显的停顿或跳跃。</li>
<li><strong>可配置</strong>: 可以自定义滚动速度、文案内容、字体颜色等样式。</li>
<li><strong>易用</strong>: 使用简单，只需要传入文案数组即可。</li>
</ol>
<h3 id="组件设计与实现"><a href="#组件设计与实现" class="headerlink" title="组件设计与实现"></a>组件设计与实现</h3><h4 id="核心思路"><a href="#核心思路" class="headerlink" title="核心思路"></a>核心思路</h4><p>实现无缝滚动的关键在于复制第一条文案到最后一条，形成一个循环。当滚动到最后一条文案时，瞬间回到第一条文案，由于视觉上第一条文案已经在最后一条文案后面，所以看起来像是继续滚动，从而达到无缝衔接的效果。</p>
<h4 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h4><p>首先，我们定义了组件的 Props 和 State：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">SeamlessMarqueeProps</span> &#123;</span><br><span class="line">    <span class="attr">texts</span>: <span class="built_in">string</span>[]; <span class="comment">// 轮播文案</span></span><br><span class="line">    interval?: <span class="built_in">number</span>; <span class="comment">// 轮播间隔，单位毫秒，默认1000毫秒（每秒滚动一组文案）</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">SeamlessMarqueeState</span> &#123;</span><br><span class="line">    <span class="attr">translateY</span>: <span class="built_in">number</span>; <span class="comment">// 滚动距离</span></span><br><span class="line">    <span class="attr">currentTextIndex</span>: <span class="built_in">number</span>; <span class="comment">// 当前显示的文案索引</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后，在组件的 <code>componentDidMount</code> 生命周期方法中启动定时器，开始滚动：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">componentDidMount</span> () &#123;</span><br><span class="line">    <span class="comment">// 开始滚动</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">startMarquee</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 <code>startMarquee</code> 方法中，我们使用 <code>setInterval</code> 定时调用 <code>rollAnimation</code> 方法，实现滚动动画：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">rollAnimation = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// ... 动画逻辑</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">startMarquee = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; interval = <span class="number">1000</span> &#125; = <span class="variable language_">this</span>.<span class="property">props</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">marqueeInterval</span> = <span class="variable language_">window</span>.<span class="built_in">setInterval</span>(<span class="variable language_">this</span>.<span class="property">rollAnimation</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>), interval);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><code>rollAnimation</code> 方法中，我们首先复制第一条文案到最后一条，然后计算下一个文案索引和滚动距离，最后更新组件的 State，触发重新渲染：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">rollAnimation = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// ... 复制文案、计算索引和滚动距离</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;</span><br><span class="line">        <span class="attr">translateY</span>: nextTranslateY,</span><br><span class="line">        <span class="attr">currentTextIndex</span>: nextTextIndex,</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后，在 <code>render</code> 方法中，我们使用 <code>ul</code> 元素来包裹文案列表，并通过 <code>transform: translateY</code> 来实现滚动效果：</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;ul</span><br><span class="line">    className=<span class="string">&quot;marquee-content&quot;</span></span><br><span class="line">    style=&#123;&#123;</span><br><span class="line">        <span class="attr">transform</span>: <span class="string">`translateY(<span class="subst">$&#123;translateY&#125;</span>px)`</span></span><br><span class="line">    &#125;&#125;</span><br><span class="line">&gt;</span><br><span class="line">    &#123;textsWithFirst.<span class="title function_">map</span>(<span class="function">(<span class="params">text, index</span>) =&gt;</span> (</span><br><span class="line">        <span class="language-xml"><span class="tag">&lt;<span class="name">li</span> <span class="attr">key</span>=<span class="string">&#123;index&#125;</span> <span class="attr">className</span>=<span class="string">&quot;marquee-item&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            &#123;text&#125;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line">    ))&#125;</span><br><span class="line">&lt;/ul&gt;</span><br></pre></td></tr></table></figure>
<p>为了让滚动效果更加自然，我们还添加了一个渐变遮罩，遮挡住文案列表的上下边缘：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.marquee-mask &#123;</span><br><span class="line">    background-image: linear-gradient(to bottom, #fff 0%, transparent 50%, transparent 50%, #fff 100%);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="组件使用"><a href="#组件使用" class="headerlink" title="组件使用"></a>组件使用</h3><p>使用起来非常简单，只需要传入文案数组即可：</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="title class_">SeamlessMarquee</span> texts=&#123;warningArr&#125; interval=&#123;<span class="number">3000</span>&#125; /&gt;</span><br></pre></td></tr></table></figure>
<h3 id="源码全览"><a href="#源码全览" class="headerlink" title="源码全览"></a>源码全览</h3><p><strong>SeamlessMarquee.tsx:</strong></p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span>, &#123; <span class="title class_">Component</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;./index.scss&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">SeamlessMarqueeProps</span> &#123;</span><br><span class="line">    <span class="attr">texts</span>: <span class="built_in">string</span>[]; <span class="comment">// 轮播文案</span></span><br><span class="line">    interval?: <span class="built_in">number</span>; <span class="comment">// 轮播间隔，单位毫秒，默认1000毫秒（每秒滚动一组文案）</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">SeamlessMarqueeState</span> &#123;</span><br><span class="line">    <span class="attr">translateY</span>: <span class="built_in">number</span>; <span class="comment">// 滚动距离</span></span><br><span class="line">    <span class="attr">currentTextIndex</span>: <span class="built_in">number</span>; <span class="comment">// 当前显示的文案索引</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SeamlessMarquee</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Component</span>&lt;</span><br><span class="line">    <span class="title class_">SeamlessMarqueeProps</span>,</span><br><span class="line">    <span class="title class_">SeamlessMarqueeState</span></span><br><span class="line">&gt; &#123;</span><br><span class="line">    <span class="comment">// 滚动容器</span></span><br><span class="line">    <span class="keyword">private</span> <span class="attr">setMarqueeContentRef</span>: <span class="built_in">any</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="attr">marqueeInterval</span>: <span class="built_in">any</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span> (<span class="params"><span class="attr">props</span>: <span class="title class_">SeamlessMarqueeProps</span></span>) &#123;</span><br><span class="line">        <span class="variable language_">super</span>(props);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">state</span> = &#123;</span><br><span class="line">            <span class="attr">translateY</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">currentTextIndex</span>: <span class="number">0</span>,</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">componentDidMount</span> () &#123;</span><br><span class="line">        <span class="comment">// 开始滚动</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">startMarquee</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">componentWillUnmount</span> () &#123;</span><br><span class="line">        <span class="comment">// 停止滚动</span></span><br><span class="line">        <span class="variable language_">window</span>.<span class="built_in">clearInterval</span>(<span class="variable language_">this</span>.<span class="property">marqueeInterval</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * desc 动画逻辑抽离</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> <span class="variable">Lang</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2024-06-04 16:24:17</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    rollAnimation = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; texts &#125; = <span class="variable language_">this</span>.<span class="property">props</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 复制第一个文案到最后一个，实现无缝衔接</span></span><br><span class="line">        <span class="keyword">const</span> textsWithFirst = [...texts, texts[<span class="number">0</span>]];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> &#123; currentTextIndex &#125; = <span class="variable language_">this</span>.<span class="property">state</span>;</span><br><span class="line">        <span class="comment">// 计算下一个文案索引</span></span><br><span class="line">        <span class="keyword">const</span> nextTextIndex = (currentTextIndex + <span class="number">1</span>) % textsWithFirst.<span class="property">length</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 计算滚动距离</span></span><br><span class="line">        <span class="keyword">const</span> nextTranslateY = nextTextIndex * -<span class="number">36</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果滚动到最后一个文案，需要瞬间回到第一个文案</span></span><br><span class="line">        <span class="keyword">if</span> (currentTextIndex === textsWithFirst.<span class="property">length</span> - <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">// 瞬间回到第一个文案 - 关闭过渡动画</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">setMarqueeContentRef</span>.<span class="property">style</span>.<span class="property">transition</span> = <span class="string">&#x27;none&#x27;</span>;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">setMarqueeContentRef</span>.<span class="property">style</span>.<span class="property">transform</span> = <span class="string">&#x27;translateY(0)&#x27;</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 等待回到第一个文案后，再开启过渡动画</span></span><br><span class="line">            <span class="comment">// window.setTimeout 的作用是确保在 translateY 设置为 0 之后，再开启过渡动画，避免视觉上“回拉”的感觉</span></span><br><span class="line">            <span class="variable language_">window</span>.<span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                <span class="comment">// 第一个文案在最后一个文案的后面，所以在视觉上已经是第二个文案了</span></span><br><span class="line">                <span class="comment">// 设置第二个文案为当前文案，用于过渡动画</span></span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;</span><br><span class="line">                    <span class="attr">translateY</span>: -<span class="number">36</span>,</span><br><span class="line">                    <span class="attr">currentTextIndex</span>: <span class="number">1</span>,</span><br><span class="line">                &#125;, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="property">setMarqueeContentRef</span>.<span class="property">style</span>.<span class="property">transition</span> = <span class="string">&#x27;transform 0.5s&#x27;</span>;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;</span><br><span class="line">            <span class="attr">translateY</span>: nextTranslateY,</span><br><span class="line">            <span class="attr">currentTextIndex</span>: nextTextIndex,</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 开始滚动</span></span><br><span class="line">    startMarquee = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; interval = <span class="number">1000</span> &#125; = <span class="variable language_">this</span>.<span class="property">props</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">marqueeInterval</span> = <span class="variable language_">window</span>.<span class="built_in">setInterval</span>(<span class="variable language_">this</span>.<span class="property">rollAnimation</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>), interval);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">render</span> () &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; texts &#125; = <span class="variable language_">this</span>.<span class="property">props</span>;</span><br><span class="line">        <span class="keyword">const</span> &#123; translateY &#125; = <span class="variable language_">this</span>.<span class="property">state</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 复制第一个文案到最后一个，实现无缝衔接</span></span><br><span class="line">        <span class="keyword">const</span> textsWithFirst = [...texts, texts[<span class="number">0</span>]];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;seamless-marquee&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;marquee-mask&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">ul</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">className</span>=<span class="string">&quot;marquee-content&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">ref</span>=<span class="string">&#123;ref</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-xml">                        this.setMarqueeContentRef = ref;</span></span><br><span class="line"><span class="language-xml">                    &#125;&#125;</span></span><br><span class="line"><span class="language-xml">                    style=&#123;&#123;</span></span><br><span class="line"><span class="language-xml">                        transform: `translateY($&#123;translateY&#125;px)`</span></span><br><span class="line"><span class="language-xml">                    &#125;&#125;</span></span><br><span class="line"><span class="language-xml">                &gt;</span></span><br><span class="line"><span class="language-xml">                    &#123;textsWithFirst.map((text, index) =&gt; (</span></span><br><span class="line"><span class="language-xml">                        <span class="tag">&lt;<span class="name">li</span> <span class="attr">key</span>=<span class="string">&#123;index&#125;</span> <span class="attr">className</span>=<span class="string">&quot;marquee-item&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                            &#123;text&#125;</span></span><br><span class="line"><span class="language-xml">                        <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                    ))&#125;</span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">SeamlessMarquee</span>;</span><br></pre></td></tr></table></figure>
<p><strong>SeamlessMarquee.scss:</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">.seamless-marquee &#123;</span><br><span class="line">    width: 380px;</span><br><span class="line">    height: 36px;</span><br><span class="line">    overflow: hidden;</span><br><span class="line">    position: relative;</span><br><span class="line">    font-size: 12px;</span><br><span class="line"></span><br><span class="line">    .marquee-mask &#123;</span><br><span class="line">        position: absolute;</span><br><span class="line">        left: 0;</span><br><span class="line">        top: 0;</span><br><span class="line">        content: &#x27;&#x27;;</span><br><span class="line">        display: block;</span><br><span class="line">        background-image: linear-gradient(to bottom, #fff 0%, transparent 50%, transparent 50%, #fff 100%);</span><br><span class="line">        width: 100%;</span><br><span class="line">        height: 100%;</span><br><span class="line">        z-index: 1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    .marquee-content &#123;</span><br><span class="line">        display: flex;</span><br><span class="line">        flex-direction: column;</span><br><span class="line">        position: absolute;</span><br><span class="line">        top: 0;</span><br><span class="line">        left: 0;</span><br><span class="line">        width: 100%;</span><br><span class="line">        height: auto;</span><br><span class="line">        transition: transform .5s;</span><br><span class="line"></span><br><span class="line">        .marquee-item &#123;</span><br><span class="line">            display: flex;</span><br><span class="line">            align-items: center;</span><br><span class="line">            height: 36px;</span><br><span class="line">            line-height: 36px;</span><br><span class="line">            color: #FF4D4A;</span><br><span class="line">            font-size: 12px;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>通过以上步骤，我们成功开发了一个 React 无缝滚动跑马灯组件，满足了项目的需求，并且代码简洁易懂，方便维护。在实际项目中，我们可以根据具体需求，对组件进行进一步的扩展和优化，比如添加自定义样式、暂停/继续滚动等功能。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/xiaolangwiki/page/2/">2</a><a class="page-number" href="/xiaolangwiki/page/3/">3</a><a class="extend next" rel="next" href="/xiaolangwiki/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="小浪wiki"
      src="/xiaolangwiki/images/avatar.png">
  <p class="site-author-name" itemprop="name">小浪wiki</p>
  <div class="site-description" itemprop="description">一个关于编程、计算机、软件工程、互联网的知识库。</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/xiaolangwiki/archives/">
        
          <span class="site-state-item-count">22</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/xiaolangwiki/categories/">
          
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/xiaolangwiki/tags/">
          
        <span class="site-state-item-count">40</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/LianTianNo1" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;LianTianNo1" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2018 – 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">小浪wiki</span>
</div><div>
<!--添加网站运行时间-->
<span>小破站已经在风雨中度过了</span>
<span id="timeDate">载入天数...</span>
<span id="times">载入时分秒...</span>
<script>
    function createtime() {
        const startTime = '09/27/2018 00:12:55',
            start = new Date(startTime)
        let mill = new Date() - start,
            seconds = Math.floor(mill / 1000),
            mins = Math.floor(seconds / 60),
            hours = Math.floor(mins / 60),
            days = Math.floor(hours / 24)
        const time = {
            seconds: seconds - mins * 60,
            mins: mins - hours * 60,
            hours: hours - days * 24,
        }
        for (const k in time) {
            time[k] = `${time[k]}`.padStart(2, '0')
        }
        document.getElementById("timeDate").innerHTML = ` ${days} 天`
        document.getElementById("times").innerHTML = ` ${time.hours} 小时 ${time.mins} 分 ${time.seconds} 秒`
    }
    setInterval(createtime, 500)
</script>
</div>


        








      </div>
    </footer>
  </div>

  
  <script src="/xiaolangwiki/lib/anime.min.js"></script>
  <script src="/xiaolangwiki/lib/pjax/pjax.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/xiaolangwiki/lib/velocity/velocity.min.js"></script>
  <script src="/xiaolangwiki/lib/velocity/velocity.ui.min.js"></script>

<script src="/xiaolangwiki/js/utils.js"></script>

<script src="/xiaolangwiki/js/motion.js"></script>


<script src="/xiaolangwiki/js/schemes/muse.js"></script>


<script src="/xiaolangwiki/js/next-boot.js"></script>

<script src="/xiaolangwiki/js/bookmark.js"></script>

  <script>
var pjax = new Pjax({
  selectors: [
    'head title',
    '#page-configurations',
    '.content-wrap',
    '.post-toc-wrap',
    '.languages',
    '#pjax'
  ],
  switches: {
    '.post-toc-wrap': Pjax.switches.innerHTML
  },
  analytics: false,
  cacheBust: false,
  scrollTo : !CONFIG.bookmark.enable
});

window.addEventListener('pjax:success', () => {
  document.querySelectorAll('script[data-pjax], script#page-configurations, #pjax script').forEach(element => {
    var code = element.text || element.textContent || element.innerHTML || '';
    var parent = element.parentNode;
    parent.removeChild(element);
    var script = document.createElement('script');
    if (element.id) {
      script.id = element.id;
    }
    if (element.className) {
      script.className = element.className;
    }
    if (element.type) {
      script.type = element.type;
    }
    if (element.src) {
      script.src = element.src;
      // Force synchronous loading of peripheral JS.
      script.async = false;
    }
    if (element.dataset.pjax !== undefined) {
      script.dataset.pjax = '';
    }
    if (code !== '') {
      script.appendChild(document.createTextNode(code));
    }
    parent.appendChild(script);
  });
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  NexT.utils.updateSidebarPosition();
});
</script>




  




  
<script src="/xiaolangwiki/js/local-search.js"></script>













    <div id="pjax">
  

  

  


    </div>
<script src="/xiaolangwiki/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/xiaolangwiki/live2dw/assets/hijiki.model.json"},"display":{"position":"left","width":150,"height":300,"left":10},"mobile":{"show":true}});</script></body>
</html>
